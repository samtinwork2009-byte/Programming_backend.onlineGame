<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後端工程師模擬學習平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.5.25/lib/jsrsasign-all-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        :root {
            --primary-color: #0f172a;
            --secondary-color: #1e293b;
            --accent-blue: #38bdf8;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --text-light: #f8fafc;
            --text-gray: #cbd5e1;
            --code-bg: #0d1117;
            --terminal-bg: #111827;
            --shadow-color: rgba(56, 189, 248, 0.2);
            --gradient-blue: linear-gradient(45deg, #38bdf8, #10b981, #8b5cf6);
            --gradient-green: linear-gradient(45deg, #065f46, #10b981);
            --gradient-red: linear-gradient(45deg, #7f1d1d, #ef4444);
            --gradient-purple: linear-gradient(45deg, #4c1d95, #8b5cf6);
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--primary-color);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 20%);
        }

        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            opacity: 0.3;
        }

        /* 侧边栏导航 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(56, 189, 248, 0.2);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            padding: 20px;
        }

        .sidebar-header {
            padding: 20px 0;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            color: var(--accent-blue);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-section h3 {
            color: var(--accent-green);
            font-size: 1rem;
            margin-bottom: 10px;
            padding-left: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-gray);
        }

        .nav-item:hover {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent-blue);
        }

        .nav-item.active {
            background: var(--gradient-blue);
            color: white;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--accent-green);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .main-content.sidebar-open {
                margin-left: var(--sidebar-width);
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--gradient-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
        }

        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        /* 页面容器 */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 页面头部 */
        .page-header {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(56, 189, 248, 0.3);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-blue);
        }

        .page-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: var(--text-gray);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        /* 步骤引导 */
        .step-guide {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
            border-left: 4px solid var(--accent-blue);
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(56, 189, 248, 0.1);
            color: var(--text-gray);
            transition: all 0.3s ease;
        }

        .step-item.active {
            background: var(--gradient-blue);
            color: white;
        }

        .step-item.completed {
            background: var(--gradient-green);
            color: white;
        }

        .step-connector {
            width: 30px;
            height: 2px;
            background: var(--accent-blue);
            opacity: 0.3;
        }

        /* 编辑器容器 */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .editor-container {
                gap: 10px;
            }
            .code-panel, .console-panel {
                min-height: 300px;
            }
        }

        .code-panel, .console-panel {
            background: var(--code-bg);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        .panel-header {
            background: var(--secondary-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .panel-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* 代码编辑器 */
        .CodeMirror {
            height: 500px !important;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
        }

        .CodeMirror-gutter-breakpoint {
            background: var(--accent-red);
            border-radius: 50%;
            margin-left: 5px;
            cursor: pointer;
        }

        /* 控制台输出 */
        .console-content {
            padding: 20px;
            font-family: 'Fira Code', 'Courier New', monospace;
            height: 500px;
            overflow-y: auto;
            background: var(--terminal-bg);
        }

        .console-tabs {
            display: flex;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .console-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-gray);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .console-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid transparent;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-entry.info { border-left-color: var(--accent-blue); }
        .log-entry.success { border-left-color: var(--accent-green); }
        .log-entry.error { border-left-color: var(--accent-red); }
        .log-entry.warning { border-left-color: var(--accent-yellow); }

        .log-time {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .log-message {
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* 工具栏 */
        .toolbar {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: var(--gradient-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow-color);
        }

        .btn-success {
            background: var(--gradient-green);
        }

        .btn-warning {
            background: var(--gradient-red);
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 表单控件 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent-blue);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group .form-control {
            flex: 1;
        }

        /* 卡片布局 */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .card {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(56, 189, 248, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-blue);
            box-shadow: 0 10px 25px var(--shadow-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: var(--gradient-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .card-title {
            font-size: 1.3rem;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* 统计面板 */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        /* 动画效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .page-title { font-size: 1.8rem; }
            .step-guide { flex-wrap: wrap; }
            .toolbar { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .panel-actions { flex-wrap: wrap; }
            .card-grid { grid-template-columns: 1fr; }
            .stats-panel { grid-template-columns: 1fr; }
            .console-tab { padding: 8px 12px; }
        }

        /* 调试面板 */
        .debug-panel {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent-purple);
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }

        .debug-title {
            color: var(--accent-purple);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .debug-content {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
        }

        .variable-watch {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
        }

        .var-name {
            color: var(--accent-purple);
            font-weight: bold;
        }

        .var-value {
            color: var(--accent-green);
            word-break: break-all;
        }

        /* API文档面板 */
        .api-docs {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent-green);
        }

        .endpoint {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .method-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .method-get { background: #10b981; color: white; }
        .method-post { background: #3b82f6; color: white; }
        .method-put { background: #f59e0b; color: white; }
        .method-delete { background: #ef4444; color: white; }

        .endpoint-path {
            font-family: 'Fira Code', monospace;
            color: var(--text-light);
            word-break: break-all;
        }

        /* 进度条 */
        .progress-bar {
            height: 10px;
            background: var(--secondary-color);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-green);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        /* 网络模拟可视化 */
        .network-visualization {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .network-node {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .network-node.active {
            border-color: var(--accent-blue);
            background: rgba(56, 189, 248, 0.1);
        }

        .node-icon {
            font-size: 2rem;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        /* Flash消息 */
        .flash-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .flash-success {
            background: var(--gradient-green);
            color: white;
        }

        .flash-error {
            background: var(--gradient-red);
            color: white;
        }

        .flash-info {
            background: var(--gradient-blue);
            color: white;
        }

        .flash-warning {
            background: var(--gradient-purple);
            color: white;
        }

        /* 加载动画 */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(56, 189, 248, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 断点样式 */
        .breakpoint {
            color: var(--accent-red);
            cursor: pointer;
            padding: 2px;
        }

        /* 图表容器 */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
            margin-top: 15px;
        }

        /* 项目创建向导 */
        .wizard-steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .wizard-step {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        .wizard-step.active {
            border-color: var(--accent-blue);
        }

        /* OAuth授权页面 */
        .oauth-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-color);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--accent-blue);
            z-index: 2001;
            min-width: 400px;
            max-width: 90%;
        }

        .oauth-dialog h3 {
            color: var(--accent-blue);
            margin-bottom: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
        }

        /* 代码质量报告 */
        .code-quality-report {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent-yellow);
        }

        .quality-metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
        }

        /* Git模拟界面 */
        .git-commit {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-green);
        }

        /* 错误分析助手 */
        .error-assistant {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent-red);
        }

        .error-cause {
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .error-cause:hover {
            background: rgba(239, 68, 68, 0.2);
            cursor: pointer;
        }

        /* 版权声明 */
        .copyright {
            margin-top: 40px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 10px;
            border: 1px solid rgba(56, 189, 248, 0.2);
            text-align: center;
            color: var(--text-gray);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .copyright h4 {
            color: var(--accent-blue);
            margin-bottom: 10px;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* 键盘快捷键提示 */
        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--accent-blue);
            font-size: 0.8rem;
            color: var(--text-gray);
            z-index: 100;
        }

        /* 增强的动态路由参数编辑器 */
        .route-param-editor {
            background: rgba(56, 189, 248, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        /* HTTP/2 模拟 */
        .http2-simulation {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        /* WebSocket 模拟 */
        .websocket-simulation {
            background: rgba(245, 158, 11, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        /* 多语言切换按钮 */
        .lang-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        .lang-btn {
            background: rgba(30, 41, 59, 0.9);
            color: var(--text-light);
            border: 1px solid var(--accent-blue);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: var(--gradient-blue);
        }

        /* 拖放界面 */
        .draggable-item {
            cursor: move;
            padding: 10px;
            margin: 5px;
            background: rgba(56, 189, 248, 0.1);
            border-radius: 5px;
            border: 2px dashed var(--accent-blue);
        }

        .drop-zone {
            min-height: 100px;
            border: 2px dashed var(--accent-green);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--text-gray);
            transition: all 0.3s ease;
        }

        .drop-zone.active {
            border-color: var(--accent-blue);
            background: rgba(56, 189, 248, 0.05);
        }

        /* 时间线 */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent-blue);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-blue);
        }
    </style>
</head>
<body>
    <!-- 网格背景 -->
    <div class="grid-bg"></div>

    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- 多语言切换按钮 -->
    <div class="lang-switcher">
        <select class="lang-btn" id="language-switch" onchange="changeLanguageInterface()">
            <option value="zh-TW">繁體中文</option>
            <option value="en">English</option>
            <option value="ja">日本語</option>
        </select>
    </div>

    <!-- 侧边栏导航 -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-code"></i> 後端模擬平台</h2>
        </div>

        <div class="sidebar-nav">
            <!-- 核心开发模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-cogs"></i> 核心開發模塊</h3>
                <div class="nav-item" onclick="navigateTo('home')">
                    <i class="fas fa-home"></i> 首頁
                </div>
                <div class="nav-item" onclick="navigateTo('code-editor')">
                    <i class="fas fa-laptop-code"></i> 代碼編輯器
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('router-manager')">
                    <i class="fas fa-route"></i> 路由管理器
                </div>
                <div class="nav-item" onclick="navigateTo('http-simulator')">
                    <i class="fas fa-exchange-alt"></i> HTTP模擬器
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('database-simulator')">
                    <i class="fas fa-database"></i> 數據庫模擬
                    <span class="badge">增強</span>
                </div>
            </div>

            <!-- 授权与安全模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-shield-alt"></i> 授權與安全</h3>
                <div class="nav-item" onclick="navigateTo('authentication')">
                    <i class="fas fa-key"></i> 身份驗證
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('authorization')">
                    <i class="fas fa-user-lock"></i> 權限管理
                </div>
                <div class="nav-item" onclick="navigateTo('ssl-simulator')">
                    <i class="fas fa-lock"></i> SSL/HTTPS模擬
                    <span class="badge">新</span>
                </div>
            </div>

            <!-- 项目开发模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-project-diagram"></i> 項目開發</h3>
                <div class="nav-item" onclick="navigateTo('project-wizard')">
                    <i class="fas fa-magic"></i> 項目嚮導
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('git-simulator')">
                    <i class="fas fa-code-branch"></i> Git模擬
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('deployment')">
                    <i class="fas fa-rocket"></i> 部署模擬
                    <span class="badge">增強</span>
                </div>
            </div>

            <!-- 测试与验证模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-vial"></i> 測試與優化</h3>
                <div class="nav-item" onclick="navigateTo('unit-testing')">
                    <i class="fas fa-flask"></i> 單元測試
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('api-testing')">
                    <i class="fas fa-bug"></i> 接口測試
                </div>
                <div class="nav-item" onclick="navigateTo('code-quality')">
                    <i class="fas fa-chart-line"></i> 代碼質量
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('error-assistant')">
                    <i class="fas fa-life-ring"></i> 錯誤助手
                    <span class="badge">新</span>
                </div>
            </div>

            <!-- 网络与集成模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-network-wired"></i> 網絡與集成</h3>
                <div class="nav-item" onclick="navigateTo('dns-simulator')">
                    <i class="fas fa-globe"></i> DNS解析模擬
                </div>
                <div class="nav-item" onclick="navigateTo('third-party-api')">
                    <i class="fas fa-plug"></i> 第三方API
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('load-balancer')">
                    <i class="fas fa-balance-scale"></i> 負載均衡
                </div>
                <div class="nav-item" onclick="navigateTo('browser-simulator')">
                    <i class="fas fa-desktop"></i> 瀏覽器模擬
                    <span class="badge">新</span>
                </div>
            </div>

            <!-- 学习模式 -->
            <div class="nav-section">
                <h3><i class="fas fa-graduation-cap"></i> 學習模式</h3>
                <div class="nav-item" onclick="navigateTo('free-mode')">
                    <i class="fas fa-lightbulb"></i> 自由模式
                </div>
                <div class="nav-item" onclick="navigateTo('practice-mode')">
                    <i class="fas fa-tasks"></i> 實作模式
                </div>
                <div class="nav-item" onclick="navigateTo('exam-mode')">
                    <i class="fas fa-file-alt"></i> 考試模式
                </div>
            </div>

            <!-- 系统状态 -->
            <div class="nav-section">
                <h3><i class="fas fa-chart-line"></i> 系統狀態</h3>
                <div class="nav-item" onclick="navigateTo('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> 儀表板
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('logs')">
                    <i class="fas fa-history"></i> 操作日誌
                    <span class="badge" id="log-count">0</span>
                </div>
                <div class="nav-item" onclick="navigateTo('settings')">
                    <i class="fas fa-cog"></i> 設定
                </div>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content" id="mainContent">
        <!-- Flash消息容器 -->
        <div id="flash-container"></div>

        <!-- 首页 -->
        <div class="page active" id="home" data-page="home">
            <div class="page-header">
                <h1 class="page-title">後端工程師模擬學習平台</h1>
                <p class="page-subtitle">純前端實現的完整後端開發模擬環境</p>
                
                <!-- 步骤引导 -->
                <div class="step-guide">
                    <div class="step-item completed">
                        <span>1</span> 選擇模式
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item active">
                        <span>2</span> 編寫代碼
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item">
                        <span>3</span> 測試驗證
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item">
                        <span>4</span> 部署上線
                    </div>
                </div>
            </div>

            <!-- 统计面板 -->
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-value" id="api-count">0</div>
                    <div class="stat-label">API接口數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="success-rate">100%</div>
                    <div class="stat-label">請求成功率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-response">0ms</div>
                    <div class="stat-label">平均響應時間</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-requests">0</div>
                    <div class="stat-label">總請求數</div>
                </div>
            </div>

            <!-- 功能卡片 -->
            <div class="card-grid">
                <div class="card" onclick="navigateTo('code-editor')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <div>
                            <h3 class="card-title">智能代碼編輯器</h3>
                            <p>支援 Python/Node.js/Java，語法檢查與錯誤提示</p>
                        </div>
                    </div>
                    <p>多語言支持，實時代碼解析，語法錯誤檢測，自動補全功能</p>
                </div>

                <div class="card" onclick="navigateTo('router-manager')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-route"></i>
                        </div>
                        <div>
                            <h3 class="card-title">路由管理器</h3>
                            <p>動態路由配置，中間件管理</p>
                        </div>
                    </div>
                    <p>支援靜態/動態路由，中間件鏈配置，路由測試與驗證</p>
                </div>

                <div class="card" onclick="navigateTo('database-simulator')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div>
                            <h3 class="card-title">數據庫模擬</h3>
                            <p>MySQL/MongoDB 操作模擬</p>
                        </div>
                    </div>
                    <p>SQL查詢執行，文檔增刪改查，數據可視化展示</p>
                </div>

                <div class="card" onclick="navigateTo('authentication')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div>
                            <h3 class="card-title">授權與安全</h3>
                            <p>JWT/Session/OAuth 2.0</p>
                        </div>
                    </div>
                    <p>多種授權方案模擬，權限管理，安全配置</p>
                </div>

                <div class="card" onclick="navigateTo('project-wizard')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div>
                            <h3 class="card-title">項目嚮導</h3>
                            <p>快速創建項目，生成代碼模板</p>
                        </div>
                    </div>
                    <p>引導式項目創建，框架選擇，目錄結構生成</p>
                </div>

                <div class="card" onclick="navigateTo('deployment')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div>
                            <h3 class="card-title">部署模擬</h3>
                            <p>CI/CD 流程模擬</p>
                        </div>
                    </div>
                    <p>自動化部署流程，環境配置，監控與日誌</p>
                </div>
            </div>

            <!-- 版权声明 -->
            <div class="copyright">
                <h4>版權聲明</h4>
                <p>此平台是一個模擬的後端編程遊戲平台，並不是真實的，能夠從平台中學習及吸收知識。瀏覽器網頁內不會儲存或收集任何的私隱及個人資料。</p>
                <p>© 2025 Create By 【 Sam.T 】</p>
                <p>Copyright © 2025 Sam.T. All rights reserved.</p>
                <p>版權所有© 2025 Sam.T</p>
                <p>此平台已受版權者所擁有</p>
                <p>除非已經獲得擁有者同意，否則不能夠作出任何的抄襲行為。</p>
            </div>
        </div>

        <!-- 代码编辑器页面 -->
        <div class="page" id="code-editor" data-page="code-editor">
            <div class="page-header">
                <h1 class="page-title">智能代碼編輯器</h1>
                <p class="page-subtitle">支援多語言，實時語法檢查，代碼調試功能</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 200px;" id="language-select" onchange="changeLanguage()">
                    <option value="python">Python (Flask)</option>
                    <option value="javascript">Node.js (Express)</option>
                    <option value="java">Java (Spring Boot)</option>
                    <option value="sql">SQL</option>
                </select>
                
                <button class="btn" onclick="runCode()">
                    <i class="fas fa-play"></i> 執行代碼
                </button>
                <button class="btn btn-success" onclick="saveCode()">
                    <i class="fas fa-save"></i> 保存
                </button>
                <button class="btn" onclick="loadSnippet()">
                    <i class="fas fa-code"></i> 代碼片段
                </button>
                <button class="btn" onclick="debugCode()">
                    <i class="fas fa-bug"></i> 調試
                </button>
                <button class="btn" onclick="setBreakpoint()">
                    <i class="fas fa-circle"></i> 斷點
                </button>
                <button class="btn btn-secondary" onclick="clearConsole()">
                    <i class="fas fa-trash"></i> 清空
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-file-code"></i>
                            <span>代碼編輯器</span>
                        </div>
                        <div class="panel-actions">
                            <select class="form-control" style="width: 120px;" id="code-template">
                                <option value="">選擇模板</option>
                                <option value="flask-api">Flask API 模板</option>
                                <option value="express-api">Express API 模板</option>
                                <option value="springboot-api">Spring Boot 模板</option>
                                <option value="jwt-auth">JWT 驗證</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="code-editor-area"># 歡迎使用智能代碼編輯器
# 請選擇語言開始編寫代碼

# 示例：創建 Flask 應用
from flask import Flask, jsonify, request

app = Flask(__name__)

# 模擬數據庫
users = [
    {"id": 1, "name": "張三", "email": "zhangsan@example.com"},
    {"id": 2, "name": "李四", "email": "lisi@example.com"}
]

@app.route('/api/users', methods=['GET'])
def get_users():
    """獲取所有用戶"""
    try:
        return jsonify({
            "success": True,
            "data": users,
            "count": len(users)
        }), 200
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

@app.route('/api/users', methods=['POST'])
def create_user():
    """創建新用戶"""
    try:
        data = request.get_json()
        
        # 驗證必填字段
        if not data or 'name' not in data:
            return jsonify({
                "success": False,
                "error": "缺少必要字段: name"
            }), 400
        
        # 檢查用戶名是否已存在
        if any(u['name'] == data['name'] for u in users):
            return jsonify({
                "success": False,
                "error": "用戶名已存在"
            }), 409
        
        # 創建新用戶
        new_user = {
            "id": len(users) + 1,
            "name": data['name'],
            "email": data.get('email', ''),
            "created_at": "2024-01-01T00:00:00Z"
        }
        
        users.append(new_user)
        
        return jsonify({
            "success": True,
            "data": new_user,
            "message": "用戶創建成功"
        }), 201
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

if __name__ == '__main__':
    app.run(debug=True)</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-terminal"></i>
                            <span>控制台輸出</span>
                        </div>
                        <div class="panel-actions">
                            <div class="console-tabs">
                                <div class="console-tab active" onclick="switchConsoleTab('execution')">執行日誌</div>
                                <div class="console-tab" onclick="switchConsoleTab('request')">請求日誌</div>
                                <div class="console-tab" onclick="switchConsoleTab('error')">錯誤日誌</div>
                            </div>
                        </div>
                    </div>
                    <div class="console-content">
                        <div id="execution-log" class="console-tab-content">
                            <div class="log-entry info">
                                <div class="log-time">10:00:00</div>
                                <div class="log-message">代碼編輯器已就緒。請編寫代碼並點擊"執行代碼"按鈕。</div>
                            </div>
                        </div>
                        <div id="request-log" class="console-tab-content" style="display: none;"></div>
                        <div id="error-log" class="console-tab-content" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- 调试面板 -->
            <div class="debug-panel" id="debug-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-bug"></i>
                        <span>代碼調試器</span>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="stepOver()">下一步</button>
                        <button class="btn btn-secondary" onclick="continueDebug()">繼續</button>
                        <button class="btn btn-warning" onclick="stopDebug()">停止</button>
                    </div>
                </div>
                <div class="debug-content">
                    <div class="variable-watch">
                        <div class="var-name">當前行數:</div>
                        <div class="var-value" id="current-line">0</div>
                    </div>
                    <div id="variables-watch"></div>
                </div>
            </div>

            <!-- 多層次程式碼分析面板 -->
            <div class="debug-panel" id="code-analysis-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-search"></i>
                        <span>程式碼分析</span>
                    </div>
                </div>
                <div class="debug-content">
                    <div class="variable-watch">
                        <div class="var-name">語法正確性:</div>
                        <div class="var-value" id="syntax-analysis">檢查中...</div>
                    </div>
                    <div class="variable-watch">
                        <div class="var-name">邏輯正確性:</div>
                        <div class="var-value" id="logic-analysis">檢查中...</div>
                    </div>
                    <div class="variable-watch">
                        <div class="var-name">效能影響分析:</div>
                        <div class="var-value" id="performance-analysis">檢查中...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 路由管理器页面 -->
        <div class="page" id="router-manager" data-page="router-manager">
            <div class="page-header">
                <h1 class="page-title">路由管理器</h1>
                <p class="page-subtitle">配置和管理您的 API 路由，支持動態路由和中間件</p>
            </div>

            <div class="toolbar">
                <button class="btn" onclick="addRoute()">
                    <i class="fas fa-plus"></i> 新增路由
                </button>
                <button class="btn btn-success" onclick="saveRoutes()">
                    <i class="fas fa-save"></i> 保存配置
                </button>
                <button class="btn" onclick="testAllRoutes()">
                    <i class="fas fa-vial"></i> 測試所有路由
                </button>
                <button class="btn" onclick="generateAPIDocs()">
                    <i class="fas fa-file-alt"></i> 生成 API 文檔
                </button>
                <button class="btn" onclick="toggleMiddlewareDebug()">
                    <i class="fas fa-cogs"></i> 中間件調試
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-route"></i>
                            <span>路由配置</span>
                        </div>
                    </div>
                    <div class="console-content" id="route-config-area">
                        <!-- 路由配置將在這裡動態生成 -->
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-vial"></i>
                            <span>路由測試</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-exchange-alt"></i> 測試配置
                            </label>
                            <div class="input-group">
                                <select class="form-control" id="test-method">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                                <input type="text" class="form-control" id="test-url" placeholder="/api/users">
                                <button class="btn" onclick="testRoute()">測試</button>
                            </div>
                        </div>
                        <div id="route-test-results"></div>
                    </div>
                </div>
            </div>

            <!-- API文档面板 -->
            <div class="api-docs" id="api-docs" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-file-alt"></i>
                        <span>API 文檔</span>
                    </div>
                </div>
                <div id="api-docs-content"></div>
            </div>

            <!-- 中間件調試面板 -->
            <div class="debug-panel" id="middleware-debug-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-cogs"></i>
                        <span>中間件執行調試</span>
                    </div>
                </div>
                <div id="middleware-debug-content"></div>
            </div>
        </div>

        <!-- HTTP模拟器页面 -->
        <div class="page" id="http-simulator" data-page="http-simulator">
            <div class="page-header">
                <h1 class="page-title">HTTP 請求模擬器</h1>
                <p class="page-subtitle">模擬真實 HTTP 請求，支持參數驗證和錯誤處理</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 120px;" id="http-method">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                    <option value="OPTIONS">OPTIONS</option>
                </select>
                <select class="form-control" style="width: 120px;" id="http-version">
                    <option value="1.1">HTTP/1.1</option>
                    <option value="2">HTTP/2</option>
                    <option value="websocket">WebSocket</option>
                </select>
                <input type="text" class="form-control" id="http-url" placeholder="請求 URL" value="/api/users">
                <button class="btn" onclick="sendHttpRequest()">
                    <i class="fas fa-paper-plane"></i> 發送請求
                </button>
                <button class="btn" onclick="addHeader()">
                    <i class="fas fa-plus"></i> 添加請求頭
                </button>
                <button class="btn btn-secondary" onclick="clearHttpLog()">
                    <i class="fas fa-trash"></i> 清空日誌
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-cogs"></i>
                            <span>請求配置</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <!-- 请求头配置 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-heading"></i> 請求頭
                            </label>
                            <div id="http-headers">
                                <div class="input-group" style="margin-bottom: 5px;">
                                    <input type="text" class="form-control" placeholder="Header 名稱" value="Content-Type">
                                    <input type="text" class="form-control" placeholder="Header 值" value="application/json">
                                    <button class="btn btn-warning" onclick="removeHeader(this)" style="padding: 5px 10px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 请求参数 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-filter"></i> 請求參數
                            </label>
                            <div id="http-params">
                                <div class="input-group" style="margin-bottom: 5px;">
                                    <input type="text" class="form-control" placeholder="參數名">
                                    <input type="text" class="form-control" placeholder="參數值">
                                    <button class="btn btn-warning" onclick="removeParam(this)" style="padding: 5px 10px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 请求体 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-code"></i> 請求體
                            </label>
                            <textarea class="form-control" id="http-body" rows="8">{
  "name": "測試用戶",
  "email": "test@example.com",
  "active": true
}</textarea>
                        </div>

                        <!-- 网络延迟模拟 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-network-wired"></i> 網絡模擬
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="network-delay" placeholder="延遲 (ms)" value="0" min="0" max="5000">
                                <input type="number" class="form-control" id="packet-loss" placeholder="丟包率 %" value="0" min="0" max="100">
                                <button class="btn" onclick="simulateNetwork()">模擬網絡</button>
                            </div>
                        </div>

                        <!-- HTTP/2 特性模擬 -->
                        <div class="http2-simulation" id="http2-sim" style="display: none;">
                            <h5><i class="fas fa-bolt"></i> HTTP/2 特性</h5>
                            <label><input type="checkbox" id="http2-multiplexing" checked> 多路複用</label>
                            <label><input type="checkbox" id="http2-push"> 伺服器推送</label>
                            <label><input type="checkbox" id="http2-priority"> 優先級</label>
                        </div>

                        <!-- WebSocket 模擬 -->
                        <div class="websocket-simulation" id="websocket-sim" style="display: none;">
                            <h5><i class="fas fa-exchange-alt"></i> WebSocket 連接</h5>
                            <div class="input-group">
                                <input type="text" class="form-control" id="ws-message" placeholder="發送訊息">
                                <button class="btn" onclick="sendWebSocketMessage()">發送</button>
                            </div>
                            <button class="btn" onclick="connectWebSocket()">連接</button>
                            <button class="btn" onclick="disconnectWebSocket()">斷開</button>
                        </div>
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-exchange-alt"></i>
                            <span>請求結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="http-result">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">HTTP 模擬器已就緒。配置請求參數並點擊"發送請求"。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 网络可视化 -->
            <div class="network-visualization" id="network-visualization" style="display: none;">
                <div class="network-node active">
                    <div class="node-icon">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <div>客戶端</div>
                </div>
                <div class="network-node">
                    <div class="node-icon">
                        <i class="fas fa-server"></i>
                    </div>
                    <div>伺服器</div>
                </div>
                <div class="network-node">
                    <div class="node-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div>數據庫</div>
                </div>
                <div class="network-node">
                    <div class="node-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>認證服務</div>
                </div>
            </div>

            <!-- 數據流追蹤 -->
            <div class="debug-panel" id="dataflow-trace">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-stream"></i>
                        <span>數據流追蹤</span>
                    </div>
                </div>
                <div id="dataflow-content"></div>
            </div>
        </div>

        <!-- 数据库模拟器页面 -->
        <div class="page" id="database-simulator" data-page="database-simulator">
            <div class="page-header">
                <h1 class="page-title">數據庫模擬器</h1>
                <p class="page-subtitle">模擬 MySQL 和 MongoDB 數據庫操作，支持 SQL 查詢和文檔操作</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="db-type">
                    <option value="mysql">MySQL</option>
                    <option value="mongodb">MongoDB</option>
                </select>
                <button class="btn" onclick="executeQuery()">
                    <i class="fas fa-play"></i> 執行查詢
                </button>
                <button class="btn btn-success" onclick="createTable()">
                    <i class="fas fa-plus"></i> 創建表/集合
                </button>
                <button class="btn" onclick="insertSampleData()">
                    <i class="fas fa-download"></i> 插入樣本數據
                </button>
                <button class="btn" onclick="showQueryAnalyzer()">
                    <i class="fas fa-search"></i> 查詢分析
                </button>
                <button class="btn btn-secondary" onclick="clearDatabase()">
                    <i class="fas fa-trash"></i> 清空數據
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-database"></i>
                            <span>數據庫查詢</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="db-query" rows="10">-- MySQL 查詢示例
SELECT * FROM users;

-- MongoDB 查詢示例
db.users.find({ active: true });</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-table"></i>
                            <span>查詢結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="db-result">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">數據庫模擬器已就緒。請選擇數據庫類型並執行查詢。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 查詢分析面板 -->
            <div class="debug-panel" id="query-analyzer-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-chart-line"></i>
                        <span>查詢效能分析</span>
                    </div>
                </div>
                <div id="query-analyzer-content"></div>
            </div>

            <!-- 數據庫遷移模擬 -->
            <div class="debug-panel">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-history"></i>
                        <span>數據庫遷移模擬</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">遷移名稱</label>
                    <input type="text" class="form-control" id="migration-name" placeholder="create_users_table">
                    <button class="btn" onclick="generateMigration()" style="margin-top: 10px;">
                        <i class="fas fa-file-code"></i> 生成遷移腳本
                    </button>
                </div>
            </div>
        </div>

        <!-- 身份验证页面 -->
        <div class="page" id="authentication" data-page="authentication">
            <div class="page-header">
                <h1 class="page-title">身份驗證模擬</h1>
                <p class="page-subtitle">模擬 JWT、Session、OAuth 2.0 等多種認證機制</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="auth-type" onchange="changeAuthType()">
                    <option value="jwt">JWT</option>
                    <option value="session">Session</option>
                    <option value="oauth">OAuth 2.0</option>
                    <option value="basic">Basic Auth</option>
                    <option value="oauth2-full">OAuth 2.0 完整流程</option>
                </select>
                <button class="btn" onclick="generateToken()">
                    <i class="fas fa-key"></i> 生成 Token
                </button>
                <button class="btn btn-success" onclick="validateToken()">
                    <i class="fas fa-check"></i> 驗證 Token
                </button>
                <button class="btn" onclick="simulateLogin()">
                    <i class="fas fa-sign-in-alt"></i> 模擬登入
                </button>
                <button class="btn" onclick="refreshToken()">
                    <i class="fas fa-redo"></i> 刷新 Token
                </button>
                <button class="btn btn-warning" onclick="simulateLogout()">
                    <i class="fas fa-sign-out-alt"></i> 模擬登出
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-cogs"></i>
                            <span>認證配置</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <!-- JWT配置 -->
                        <div id="jwt-config">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-key"></i> JWT 密鑰
                                </label>
                                <input type="text" class="form-control" id="jwt-secret" value="your-secret-key-here">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-clock"></i> 有效時間
                                </label>
                                <select class="form-control" id="jwt-expiry">
                                    <option value="1h">1 小時</option>
                                    <option value="1d">1 天</option>
                                    <option value="7d">7 天</option>
                                    <option value="30d">30 天</option>
                                </select>
                            </div>
                        </div>

                        <!-- Session配置 -->
                        <div id="session-config" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-clock"></i> Session 過期時間
                                </label>
                                <select class="form-control" id="session-expiry">
                                    <option value="900">15 分鐘</option>
                                    <option value="3600">1 小時</option>
                                    <option value="86400">1 天</option>
                                </select>
                            </div>
                        </div>

                        <!-- OAuth配置 -->
                        <div id="oauth-config" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-id-card"></i> Client ID
                                </label>
                                <input type="text" class="form-control" id="oauth-client-id" value="your-client-id">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-key"></i> Client Secret
                                </label>
                                <input type="text" class="form-control" id="oauth-client-secret" value="your-client-secret">
                            </div>
                        </div>

                        <!-- OAuth 2.0 完整流程配置 -->
                        <div id="oauth2-full-config" style="display: none;">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <h5>1. 授權請求</h5>
                                    <p>用戶訪問授權端點</p>
                                </div>
                                <div class="timeline-item">
                                    <h5>2. 用戶同意</h5>
                                    <p>用戶確認授權範圍</p>
                                </div>
                                <div class="timeline-item">
                                    <h5>3. 授權碼返回</h5>
                                    <p>重定向回客戶端</p>
                                </div>
                                <div class="timeline-item">
                                    <h5>4. 交換 Token</h5>
                                    <p>用授權碼交換存取 Token</p>
                                </div>
                                <div class="timeline-item">
                                    <h5>5. 刷新 Token</h5>
                                    <p>使用刷新 Token 獲取新存取 Token</p>
                                </div>
                            </div>
                        </div>

                        <!-- 用户数据 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-users"></i> 模擬用戶數據
                            </label>
                            <textarea class="form-control" id="user-data" rows="8">[
  {
    "id": 1,
    "username": "admin",
    "password": "admin123",
    "email": "admin@example.com",
    "role": "admin",
    "permissions": ["read", "write", "delete"],
    "role_hierarchy": 1
  },
  {
    "id": 2,
    "username": "manager",
    "password": "manager123",
    "email": "manager@example.com",
    "role": "manager",
    "permissions": ["read", "write"],
    "role_hierarchy": 2
  },
  {
    "id": 3,
    "username": "user1",
    "password": "password123",
    "email": "user1@example.com",
    "role": "user",
    "permissions": ["read"],
    "role_hierarchy": 3
  }
]</textarea>
                        </div>

                        <!-- 權限層級配置 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-sitemap"></i> 角色層級
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="role-name" placeholder="角色名稱">
                                <input type="number" class="form-control" id="role-level" placeholder="層級" min="1" max="10">
                                <button class="btn" onclick="addRoleHierarchy()">添加角色</button>
                            </div>
                            <div id="role-hierarchy-list"></div>
                        </div>
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-vial"></i>
                            <span>認證測試</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <!-- 登录测试 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-sign-in-alt"></i> 登入測試
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="login-username" placeholder="用戶名" value="admin">
                                <input type="password" class="form-control" id="login-password" placeholder="密碼" value="admin123">
                                <button class="btn" onclick="login()">登入</button>
                            </div>
                        </div>

                        <!-- Token展示 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-key"></i> 當前 Token
                            </label>
                            <textarea class="form-control" id="current-token" rows="3" readonly></textarea>
                        </div>

                        <!-- 刷新Token -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-redo"></i> 刷新 Token
                            </label>
                            <textarea class="form-control" id="refresh-token" rows="2" readonly></textarea>
                            <button class="btn" onclick="useRefreshToken()" style="margin-top: 10px;">使用刷新 Token</button>
                        </div>

                        <!-- 访问受保护资源 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-lock"></i> 訪問受保護資源
                            </label>
                            <div class="input-group">
                                <select class="form-control" id="resource-role">
                                    <option value="admin">管理員資源</option>
                                    <option value="manager">經理資源</option>
                                    <option value="user">用戶資源</option>
                                    <option value="public">公開資源</option>
                                </select>
                                <input type="text" class="form-control" id="protected-resource" placeholder="/api/admin" value="/api/admin">
                                <button class="btn" onclick="accessProtectedResource()">訪問</button>
                            </div>
                        </div>

                        <!-- 测试结果 -->
                        <div id="auth-test-results"></div>
                    </div>
                </div>
            </div>

            <!-- 安全漏洞模擬 -->
            <div class="error-assistant">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-shield-alt"></i>
                        <span>安全漏洞模擬</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">漏洞類型</label>
                    <select class="form-control" id="security-vuln">
                        <option value="sql-injection">SQL 注入</option>
                        <option value="xss">XSS 跨站腳本</option>
                        <option value="csrf">CSRF 跨站請求偽造</option>
                        <option value="jwt-tamper">JWT 竄改</option>
                    </select>
                    <button class="btn" onclick="simulateSecurityVulnerability()" style="margin-top: 10px;">
                        <i class="fas fa-bug"></i> 模擬攻擊
                    </button>
                    <button class="btn btn-success" onclick="showSecurityFix()" style="margin-top: 10px;">
                        <i class="fas fa-wrench"></i> 顯示修復方案
                    </button>
                </div>
            </div>
        </div>

        <!-- 单元测试页面 -->
        <div class="page" id="unit-testing" data-page="unit-testing">
            <div class="page-header">
                <h1 class="page-title">單元測試模擬</h1>
                <p class="page-subtitle">編寫和執行測試用例，分析代碼覆蓋率</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="test-framework">
                    <option value="jest">Jest (JavaScript)</option>
                    <option value="pytest">Pytest (Python)</option>
                    <option value="junit">JUnit (Java)</option>
                    <option value="mock">Mock 測試</option>
                </select>
                <button class="btn" onclick="runTests()">
                    <i class="fas fa-play"></i> 執行測試
                </button>
                <button class="btn btn-success" onclick="addTestCase()">
                    <i class="fas fa-plus"></i> 新增測試用例
                </button>
                <button class="btn" onclick="calculateCoverage()">
                    <i class="fas fa-chart-pie"></i> 計算覆蓋率
                </button>
                <button class="btn" onclick="generateTestReport()">
                    <i class="fas fa-file-pdf"></i> 生成報告
                </button>
                <button class="btn" onclick="setupMockTest()">
                    <i class="fas fa-mask"></i> 設置 Mock
                </button>
                <button class="btn btn-secondary" onclick="clearTests()">
                    <i class="fas fa-trash"></i> 清空測試
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-code"></i>
                            <span>測試代碼</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="test-code" rows="10">// Jest 測試用例示例
const { add, subtract, multiply } = require('./math');

// Mock 外部依賴示例
jest.mock('./api', () => ({
  fetchData: jest.fn().mockResolvedValue({ data: 'mocked' })
}));

describe('數學函數測試', () => {
  test('加法測試', () => {
    expect(add(1, 2)).toBe(3);
    expect(add(-1, 1)).toBe(0);
    expect(add(0, 0)).toBe(0);
  });

  test('減法測試', () => {
    expect(subtract(5, 3)).toBe(2);
    expect(subtract(0, 5)).toBe(-5);
  });

  test('乘法測試', () => {
    expect(multiply(2, 3)).toBe(6);
    expect(multiply(0, 5)).toBe(0);
    expect(multiply(-2, 3)).toBe(-6);
  });

  // 非同步測試示例
  test('非同步數據獲取', async () => {
    const data = await fetchData();
    expect(data).toEqual({ data: 'mocked' });
  });
});

// 被測試的函數
module.exports = {
  add: (a, b) => a + b,
  subtract: (a, b) => a - b,
  multiply: (a, b) => a * b
};</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-chart-bar"></i>
                            <span>測試結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="test-results">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">單元測試模擬器已就緒。請編寫測試代碼並點擊"執行測試"。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 代碼覆蓋率報告 -->
            <div class="code-quality-report" id="coverage-report" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-chart-pie"></i>
                        <span>代碼覆蓋率報告</span>
                    </div>
                </div>
                <div id="coverage-report-content"></div>
            </div>

            <!-- Mock 配置面板 -->
            <div class="debug-panel" id="mock-config-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-mask"></i>
                        <span>Mock 配置</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">要 Mock 的模組</label>
                    <input type="text" class="form-control" id="mock-module" placeholder="模組名稱">
                </div>
                <div class="form-group">
                    <label class="form-label">Mock 返回值</label>
                    <textarea class="form-control" id="mock-return" rows="3" placeholder='例如: { success: true, data: "mocked" }'></textarea>
                </div>
                <button class="btn" onclick="applyMock()">應用 Mock</button>
            </div>
        </div>

        <!-- 项目向导页面 -->
        <div class="page" id="project-wizard" data-page="project-wizard">
            <div class="page-header">
                <h1 class="page-title">項目創建嚮導</h1>
                <p class="page-subtitle">引導式項目創建，自動生成代碼模板</p>
            </div>

            <div class="wizard-steps">
                <div class="wizard-step active" id="step1">
                    <h3><i class="fas fa-list-alt"></i> 步驟 1: 選擇項目類型</h3>
                    <div class="form-group">
                        <select class="form-control" id="project-type">
                            <option value="rest-api">RESTful API</option>
                            <option value="admin-system">後台管理系統</option>
                            <option value="microservice">微服務架構</option>
                            <option value="real-time">實時應用</option>
                            <option value="ecommerce">電商平台</option>
                            <option value="social-media">社交媒體</option>
                        </select>
                    </div>
                    <button class="btn" onclick="nextStep(2)">下一步</button>
                </div>

                <div class="wizard-step" id="step2" style="display: none;">
                    <h3><i class="fas fa-cogs"></i> 步驟 2: 選擇框架</h3>
                    <div class="form-group">
                        <select class="form-control" id="project-framework">
                            <option value="flask">Flask (Python)</option>
                            <option value="express">Express (Node.js)</option>
                            <option value="springboot">Spring Boot (Java)</option>
                            <option value="fastapi">FastAPI (Python)</option>
                            <option value="nestjs">NestJS (Node.js)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="prevStep(1)">上一步</button>
                    <button class="btn" onclick="nextStep(3)">下一步</button>
                </div>

                <div class="wizard-step" id="step3" style="display: none;">
                    <h3><i class="fas fa-folder"></i> 步驟 3: 配置目錄結構</h3>
                    <div class="drop-zone" id="directory-dropzone">
                        拖放文件夾到此處或點擊選擇
                    </div>
                    <div id="directory-structure">
                        <!-- 目录结构将动态生成 -->
                    </div>
                    <button class="btn" onclick="prevStep(2)">上一步</button>
                    <button class="btn" onclick="nextStep(4)">下一步</button>
                </div>

                <div class="wizard-step" id="step4" style="display: none;">
                    <h3><i class="fas fa-check-circle"></i> 步驟 4: 完成創建</h3>
                    <div id="project-summary">
                        <!-- 项目摘要将动态生成 -->
                    </div>
                    <button class="btn" onclick="prevStep(3)">上一步</button>
                    <button class="btn btn-success" onclick="createProject()">創建項目</button>
                </div>
            </div>

            <!-- 項目時間線 -->
            <div class="debug-panel">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-tasks"></i>
                        <span>項目開發流程</span>
                    </div>
                </div>
                <div class="timeline">
                    <div class="timeline-item">
                        <h5>1. 需求分析</h5>
                        <p>分析業務需求，確定技術方案</p>
                        <button class="btn" onclick="simulateRequirementAnalysis()">模擬</button>
                    </div>
                    <div class="timeline-item">
                        <h5>2. 系統設計</h5>
                        <p>設計架構、數據庫、API 接口</p>
                        <button class="btn" onclick="simulateSystemDesign()">模擬</button>
                    </div>
                    <div class="timeline-item">
                        <h5>3. 開發實作</h5>
                        <p>編寫代碼，實現功能模組</p>
                        <button class="btn" onclick="simulateDevelopment()">模擬</button>
                    </div>
                    <div class="timeline-item">
                        <h5>4. 測試驗證</h5>
                        <p>執行單元測試、集成測試</p>
                        <button class="btn" onclick="simulateTesting()">模擬</button>
                    </div>
                    <div class="timeline-item">
                        <h5>5. 部署上線</h5>
                        <p>部署到伺服器，監控運行狀態</p>
                        <button class="btn" onclick="simulateDeployment()">模擬</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Git模拟页面 -->
        <div class="page" id="git-simulator" data-page="git-simulator">
            <div class="page-header">
                <h1 class="page-title">Git 版本控制模擬</h1>
                <p class="page-subtitle">模擬 Git 操作，學習版本控制流程</p>
            </div>

            <div class="toolbar">
                <button class="btn" onclick="gitInit()">
                    <i class="fas fa-plus"></i> 初始化倉庫
                </button>
                <button class="btn" onclick="gitAdd()">
                    <i class="fas fa-plus-circle"></i> 添加文件
                </button>
                <button class="btn btn-success" onclick="gitCommit()">
                    <i class="fas fa-check"></i> 提交
                </button>
                <button class="btn" onclick="gitBranch()">
                    <i class="fas fa-code-branch"></i> 創建分支
                </button>
                <button class="btn" onclick="gitMerge()">
                    <i class="fas fa-code-merge"></i> 合併分支
                </button>
                <button class="btn" onclick="gitPush()">
                    <i class="fas fa-cloud-upload-alt"></i> 推送
                </button>
                <button class="btn" onclick="gitPull()">
                    <i class="fas fa-cloud-download-alt"></i> 拉取
                </button>
                <button class="btn" onclick="simulateConflict()">
                    <i class="fas fa-exclamation-triangle"></i> 模擬衝突
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-code"></i>
                            <span>代碼文件</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="git-file-content" rows="10">// 代碼文件內容
function calculateTotal(items) {
  return items.reduce((sum, item) => sum + item.price, 0);
}

class User {
  constructor(name, email) {
    this.name = name;
    this.email = email;
  }

  // 新功能：用戶驗證
  validate() {
    return this.name && this.email.includes('@');
  }
}</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-history"></i>
                            <span>Git 操作</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <div class="form-group">
                            <label class="form-label">提交信息</label>
                            <input type="text" class="form-control" id="commit-message" placeholder="輸入提交信息">
                        </div>
                        <div class="form-group">
                            <label class="form-label">分支名稱</label>
                            <input type="text" class="form-control" id="branch-name" placeholder="輸入分支名稱">
                        </div>
                        <div class="form-group">
                            <label class="form-label">遠端倉庫</label>
                            <input type="text" class="form-control" id="remote-repo" placeholder="https://github.com/user/repo.git">
                        </div>
                        <div id="git-operations"></div>
                    </div>
                </div>
            </div>

            <!-- 提交历史 -->
            <div class="debug-panel">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-history"></i>
                        <span>提交歷史</span>
                    </div>
                </div>
                <div id="commit-history"></div>
            </div>

            <!-- 分支圖視覺化 -->
            <div class="debug-panel">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-project-diagram"></i>
                        <span>分支圖</span>
                    </div>
                </div>
                <div id="branch-graph">
                    <pre style="font-family: 'Fira Code', monospace; color: var(--accent-green);">
main    : A---B---C---D
           \         \
feature-1 :  E---F---G---H
                     \
feature-2 :           I---J
                    </pre>
                </div>
            </div>

            <!-- 衝突解決模擬 -->
            <div class="error-assistant" id="conflict-resolver" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>合併衝突解決</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">當前分支內容</label>
                    <textarea class="form-control" id="current-branch-content" rows="3">function calculateTotal(items) {
  return items.reduce((sum, item) => sum + item.price, 0);
}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">合併分支內容</label>
                    <textarea class="form-control" id="merge-branch-content" rows="3">function calculateTotal(items) {
  return items.reduce((total, item) => total + item.price * item.quantity, 0);
}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">解決方案</label>
                    <select class="form-control" id="conflict-resolution">
                        <option value="keep-current">保留當前分支</option>
                        <option value="keep-merge">保留合併分支</option>
                        <option value="manual">手動解決</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="resolveConflict()">解決衝突</button>
            </div>
        </div>

        <!-- 代码质量分析页面 -->
        <div class="page" id="code-quality" data-page="code-quality">
            <div class="page-header">
                <h1 class="page-title">代碼質量分析</h1>
                <p class="page-subtitle">檢查代碼規範，提供優化建議</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="linting-tool">
                    <option value="eslint">ESLint (JavaScript)</option>
                    <option value="pylint">Pylint (Python)</option>
                    <option value="checkstyle">Checkstyle (Java)</option>
                    <option value="custom">自訂規則</option>
                </select>
                <button class="btn" onclick="analyzeCode()">
                    <i class="fas fa-search"></i> 分析代碼
                </button>
                <button class="btn btn-success" onclick="autoFormat()">
                    <i class="fas fa-magic"></i> 一鍵格式化
                </button>
                <button class="btn" onclick="showRefactoring()">
                    <i class="fas fa-code-branch"></i> 重構建議
                </button>
                <button class="btn" onclick="generateQualityReport()">
                    <i class="fas fa-file-alt"></i> 生成報告
                </button>
                <button class="btn" onclick="addCustomRule()">
                    <i class="fas fa-plus"></i> 添加規則
                </button>
                <button class="btn btn-secondary" onclick="clearAnalysis()">
                    <i class="fas fa-trash"></i> 清空
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-code"></i>
                            <span>待分析代碼</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="code-to-analyze" rows="10">// 示例代碼（包含一些常見問題）
function processData(data){
  var result = []
  for(var i=0;i<data.length;i++){
    if(data[i].active){
      result.push(data[i])
    }
  }
  return result
}

const user = {
  name: '張三',
  age: 25,
  email: 'zhangsan@example.com'
}

console.log('用戶:', user)

// 複雜度過高的函數
function complexFunction(a, b, c, d, e, f, g) {
  if (a) {
    if (b) {
      if (c) {
        if (d) {
          if (e) {
            if (f) {
              return g;
            }
          }
        }
      }
    }
  }
  return null;
}</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-chart-bar"></i>
                            <span>分析結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="quality-results">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">代碼質量分析器已就緒。請輸入代碼並點擊"分析代碼"。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 代码质量报告 -->
            <div class="code-quality-report" id="quality-report" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-file-alt"></i>
                        <span>代碼質量報告</span>
                    </div>
                </div>
                <div id="quality-report-content"></div>
            </div>

            <!-- 重構建議面板 -->
            <div class="debug-panel" id="refactoring-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-code-branch"></i>
                        <span>重構建議</span>
                    </div>
                </div>
                <div id="refactoring-content">
                    <div class="error-cause">
                        <strong>問題：深層嵌套</strong><br>
                        <p>函數 complexFunction 有 6 層嵌套，建議重構：</p>
                        <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
// 重構後：
function complexFunction(a, b, c, d, e, f, g) {
  if (!a || !b || !c || !d || !e || !f) {
    return null;
  }
  return g;
}</pre>
                        <button class="btn" onclick="applyRefactoring()">應用重構</button>
                    </div>
                </div>
            </div>

            <!-- 自訂規則編輯器 -->
            <div class="debug-panel" id="custom-rules-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-edit"></i>
                        <span>自訂規則</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">規則名稱</label>
                    <input type="text" class="form-control" id="rule-name" placeholder="禁止使用 var">
                </div>
                <div class="form-group">
                    <label class="form-label">正則表達式</label>
                    <input type="text" class="form-control" id="rule-regex" placeholder="\bvar\b">
                </div>
                <div class="form-group">
                    <label class="form-label">錯誤訊息</label>
                    <input type="text" class="form-control" id="rule-message" placeholder="請使用 const 或 let 代替 var">
                </div>
                <button class="btn" onclick="saveCustomRule()">保存規則</button>
                <div id="custom-rules-list"></div>
            </div>
        </div>

        <!-- 错误分析助手页面 -->
        <div class="page" id="error-assistant" data-page="error-assistant">
            <div class="page-header">
                <h1 class="page-title">錯誤分析助手</h1>
                <p class="page-subtitle">智能分析錯誤原因，提供解決方案</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 200px;" id="error-category">
                    <option value="general">一般錯誤</option>
                    <option value="framework">框架特定錯誤</option>
                    <option value="database">數據庫錯誤</option>
                    <option value="network">網絡錯誤</option>
                    <option value="security">安全錯誤</option>
                </select>
                <button class="btn" onclick="analyzeError()">
                    <i class="fas fa-search"></i> 分析錯誤
                </button>
                <button class="btn" onclick="startStepByStepDebug()">
                    <i class="fas fa-footsteps"></i> 逐步除錯
                </button>
                <button class="btn" onclick="simulateError()">
                    <i class="fas fa-bug"></i> 模擬錯誤
                </button>
                <button class="btn" onclick="clearErrorLog()">
                    <i class="fas fa-trash"></i> 清空日誌
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-bug"></i>
                            <span>錯誤信息</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <div class="form-group">
                            <label class="form-label">錯誤類型</label>
                            <select class="form-control" id="error-type">
                                <option value="404">404 Not Found</option>
                                <option value="500">500 Internal Server Error</option>
                                <option value="401">401 Unauthorized</option>
                                <option value="403">403 Forbidden</option>
                                <option value="422">422 Unprocessable Entity</option>
                                <option value="503">503 Service Unavailable</option>
                                <option value="syntax">語法錯誤</option>
                                <option value="runtime">運行時錯誤</option>
                                <option value="typeerror">類型錯誤</option>
                                <option value="referenceerror">引用錯誤</option>
                                <option value="flask">Flask 框架錯誤</option>
                                <option value="express">Express 框架錯誤</option>
                                <option value="springboot">Spring Boot 錯誤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">錯誤描述</label>
                            <textarea class="form-control" id="error-description" rows="6" placeholder="請描述錯誤發生的情況..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">相關代碼片段</label>
                            <textarea class="form-control" id="error-code" rows="4" placeholder="相關的代碼片段..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">堆疊追蹤</label>
                            <textarea class="form-control" id="error-stack" rows="4" placeholder="錯誤堆疊追蹤..."></textarea>
                        </div>
                        <button class="btn" onclick="analyzeError()">開始分析</button>
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-lightbulb"></i>
                            <span>分析結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="error-analysis-results">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">錯誤分析助手已就緒。請選擇錯誤類型並描述問題。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 错误分析助手 -->
            <div class="error-assistant" id="error-suggestions" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-life-ring"></i>
                        <span>可能的解決方案</span>
                    </div>
                </div>
                <div id="error-suggestions-content"></div>
            </div>

            <!-- 逐步除錯引導 -->
            <div class="debug-panel" id="step-debug-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-footsteps"></i>
                        <span>逐步除錯引導</span>
                    </div>
                </div>
                <div id="step-debug-content">
                    <div class="timeline">
                        <div class="timeline-item">
                            <h5>步驟 1: 重現錯誤</h5>
                            <p>嘗試重現錯誤發生的環境和步驟</p>
                            <button class="btn" onclick="completeDebugStep(1)">完成</button>
                        </div>
                        <div class="timeline-item">
                            <h5>步驟 2: 檢查日誌</h5>
                            <p>查看伺服器和應用程式日誌</p>
                            <button class="btn" onclick="completeDebugStep(2)">完成</button>
                        </div>
                        <div class="timeline-item">
                            <h5>步驟 3: 隔離問題</h5>
                            <p>創建最小重現案例</p>
                            <button class="btn" onclick="completeDebugStep(3)">完成</button>
                        </div>
                        <div class="timeline-item">
                            <h5>步驟 4: 分析原因</h5>
                            <p>根據堆疊追蹤分析錯誤根源</p>
                            <button class="btn" onclick="completeDebugStep(4)">完成</button>
                        </div>
                        <div class="timeline-item">
                            <h5>步驟 5: 實施修復</h5>
                            <p>應用修復並測試驗證</p>
                            <button class="btn" onclick="completeDebugStep(5)">完成</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 仪表板页面 -->
        <div class="page" id="dashboard" data-page="dashboard">
            <div class="page-header">
                <h1 class="page-title">系統儀表板</h1>
                <p class="page-subtitle">實時監控系統狀態和性能指標</p>
            </div>

            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-value" id="total-api-calls">0</div>
                    <div class="stat-label">API 調用總數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="success-calls">0</div>
                    <div class="stat-label">成功請求</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="error-calls">0</div>
                    <div class="stat-label">失敗請求</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-latency">0ms</div>
                    <div class="stat-label">平均延遲</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="active-users">1</div>
                    <div class="stat-label">活躍用戶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="memory-usage">45%</div>
                    <div class="stat-label">記憶體使用</div>
                </div>
            </div>

            <div class="card-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <h3 class="card-title">請求趨勢</h3>
                            <p>最近 24 小時 API 調用情況</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="request-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <h3 class="card-title">錯誤分析</h3>
                            <p>最近發生的錯誤統計</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="error-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div>
                            <h3 class="card-title">性能監控</h3>
                            <p>系統資源使用情況</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label>CPU 使用率</label>
                            <div class="progress-bar">
                                <div class="progress-fill" id="cpu-usage" style="width: 30%"></div>
                            </div>
                            <span id="cpu-text">30%</span>
                        </div>
                        <div class="form-group">
                            <label>內存使用率</label>
                            <div class="progress-bar">
                                <div class="progress-fill" id="memory-usage-bar" style="width: 45%"></div>
                            </div>
                            <span id="memory-text">45%</span>
                        </div>
                        <div class="form-group">
                            <label>存儲使用率</label>
                            <div class="progress-bar">
                                <div class="progress-fill" id="storage-usage" style="width: 60%"></div>
                            </div>
                            <span id="storage-text">60%</span>
                        </div>
                        <div class="form-group">
                            <label>網絡流量</label>
                            <div class="progress-bar">
                                <div class="progress-fill" id="network-traffic" style="width: 25%"></div>
                            </div>
                            <span id="network-text">25%</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div>
                            <h3 class="card-title">最近活動</h3>
                            <p>最新的系統操作記錄</p>
                        </div>
                    </div>
                    <div id="recent-activities" style="margin-top: 15px;">
                        <div class="log-entry info" style="margin-bottom: 10px;">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">系統啟動成功</div>
                        </div>
                        <div class="log-entry success" style="margin-bottom: 10px;">
                            <div class="log-time">10:01:00</div>
                            <div class="log-message">用戶登入成功</div>
                        </div>
                        <div class="log-entry info">
                            <div class="log-time">10:02:00</div>
                            <div class="log-message">API 路由配置已加載</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div>
                            <h3 class="card-title">警報設定</h3>
                            <p>自訂監控指標和警報</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label>API 錯誤率超過</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="error-rate-threshold" value="5" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>回應時間超過</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="response-time-threshold" value="1000" min="0">
                                <span class="input-group-text">ms</span>
                            </div>
                        </div>
                        <button class="btn" onclick="saveAlertSettings()">保存設定</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div>
                            <h3 class="card-title">數據分析</h3>
                            <p>用戶行為和系統使用統計</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label>最常用功能</label>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 85%"></div>
                            </div>
                            <span>代碼編輯器 (85%)</span>
                        </div>
                        <div class="form-group">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 60%"></div>
                            </div>
                            <span>路由管理器 (60%)</span>
                        </div>
                        <div class="form-group">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 45%"></div>
                            </div>
                            <span>HTTP 模擬器 (45%)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作日志页面 -->
        <div class="page" id="logs" data-page="logs">
            <div class="page-header">
                <h1 class="page-title">操作日誌</h1>
                <p class="page-subtitle">查看系統操作記錄和事件歷史</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="log-level">
                    <option value="all">所有級別</option>
                    <option value="info">信息</option>
                    <option value="success">成功</option>
                    <option value="warning">警告</option>
                    <option value="error">錯誤</option>
                    <option value="debug">調試</option>
                </select>
                <select class="form-control" style="width: 150px;" id="log-module">
                    <option value="all">所有模組</option>
                    <option value="code-editor">代碼編輯器</option>
                    <option value="router">路由管理器</option>
                    <option value="http">HTTP 模擬器</option>
                    <option value="database">數據庫模擬</option>
                    <option value="auth">身份驗證</option>
                    <option value="test">單元測試</option>
                </select>
                <input type="text" class="form-control" id="log-search" placeholder="搜索日誌...">
                <input type="date" class="form-control" id="log-date">
                <button class="btn" onclick="filterLogs()">
                    <i class="fas fa-filter"></i> 篩選
                </button>
                <button class="btn btn-success" onclick="exportLogs()">
                    <i class="fas fa-download"></i> 導出日誌
                </button>
                <button class="btn" onclick="analyzeLogPatterns()">
                    <i class="fas fa-chart-bar"></i> 分析模式
                </button>
                <button class="btn btn-warning" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> 清空日誌
                </button>
            </div>

            <div class="console-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-history"></i>
                        <span>系統日誌</span>
                    </div>
                </div>
                <div class="console-content" id="system-logs">
                    <!-- 系统日志将在这里动态生成 -->
                </div>
            </div>

            <!-- 日誌分析報告 -->
            <div class="code-quality-report" id="log-analysis-report" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-chart-bar"></i>
                        <span>日誌分析報告</span>
                    </div>
                </div>
                <div id="log-analysis-content"></div>
            </div>
        </div>

        <!-- 第三方API集成页面 -->
        <div class="page" id="third-party-api" data-page="third-party-api">
            <div class="page-header">
                <h1 class="page-title">第三方 API 集成模擬</h1>
                <p class="page-subtitle">模擬支付閘道、社交媒體登入、地圖服務等第三方 API 整合</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 200px;" id="third-party-service">
                    <option value="stripe">Stripe 支付</option>
                    <option value="paypal">PayPal</option>
                    <option value="facebook">Facebook 登入</option>
                    <option value="google">Google 登入</option>
                    <option value="maps">Google Maps</option>
                    <option value="email">郵件發送服務</option>
                    <option value="sms">簡訊發送服務</option>
                </select>
                <button class="btn" onclick="setupThirdPartyService()">
                    <i class="fas fa-cog"></i> 設定服務
                </button>
                <button class="btn btn-success" onclick="testThirdPartyAPI()">
                    <i class="fas fa-vial"></i> 測試 API
                </button>
                <button class="btn" onclick="showIntegrationCode()">
                    <i class="fas fa-code"></i> 整合代碼
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-plug"></i>
                            <span>API 配置</span>
                        </div>
                    </div>
                    <div class="console-content" id="third-party-config">
                        <!-- 配置將根據選擇的服務動態生成 -->
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-exchange-alt"></i>
                            <span>API 測試</span>
                        </div>
                    </div>
                    <div class="console-content" id="third-party-test">
                        <!-- 測試結果將顯示在這裡 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 容器化模擬頁面 -->
        <div class="page" id="deployment" data-page="deployment">
            <div class="page-header">
                <h1 class="page-title">容器化與部署模擬</h1>
                <p class="page-subtitle">模擬 Docker、Kubernetes 和雲端部署流程</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="deployment-type">
                    <option value="docker">Docker 容器</option>
                    <option value="kubernetes">Kubernetes</option>
                    <option value="aws">AWS 部署</option>
                    <option value="azure">Azure 部署</option>
                    <option value="gcp">GCP 部署</option>
                    <option value="ci-cd">CI/CD 流水線</option>
                </select>
                <button class="btn" onclick="buildContainer()">
                    <i class="fas fa-hammer"></i> 建置容器
                </button>
                <button class="btn" onclick="deployApplication()">
                    <i class="fas fa-rocket"></i> 部署應用
                </button>
                <button class="btn" onclick="scaleApplication()">
                    <i class="fas fa-expand-alt"></i> 擴縮容
                </button>
                <button class="btn" onclick="monitorDeployment()">
                    <i class="fas fa-heartbeat"></i> 監控狀態
                </button>
                <button class="btn btn-success" onclick="runCICDPipeline()">
                    <i class="fas fa-tasks"></i> 執行 CI/CD
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-file-code"></i>
                            <span>配置文件</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="deployment-config" rows="15"># Dockerfile 示例
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

USER node
CMD ["node", "server.js"]

# docker-compose.yml 示例
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - db
  
  db:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: example
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-terminal"></i>
                            <span>部署日誌</span>
                        </div>
                    </div>
                    <div class="console-content" id="deployment-logs">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">部署模擬器已就緒。請選擇部署類型並執行部署流程。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 基礎設施即代碼模擬 -->
            <div class="debug-panel">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-cloud"></i>
                        <span>基礎設施即代碼 (IaC)</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">選擇 IaC 工具</label>
                    <select class="form-control" id="iac-tool">
                        <option value="terraform">Terraform</option>
                        <option value="cloudformation">AWS CloudFormation</option>
                        <option value="arm">Azure ARM</option>
                        <option value="pulumi">Pulumi</option>
                    </select>
                    <button class="btn" onclick="generateIaC()" style="margin-top: 10px;">
                        <i class="fas fa-magic"></i> 生成 IaC 模板
                    </button>
                </div>
            </div>

            <!-- CI/CD 流水線視覺化 -->
            <div class="debug-panel">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-stream"></i>
                        <span>CI/CD 流水線</span>
                    </div>
                </div>
                <div class="timeline">
                    <div class="timeline-item">
                        <h5>1. 代碼提交</h5>
                        <p>開發者推送代碼到版本控制</p>
                        <button class="btn" onclick="triggerPipelineStep(1)">觸發</button>
                    </div>
                    <div class="timeline-item">
                        <h5>2. 自動化測試</h5>
                        <p>執行單元測試和集成測試</p>
                        <button class="btn" onclick="triggerPipelineStep(2)">觸發</button>
                    </div>
                    <div class="timeline-item">
                        <h5>3. 建置映像</h5>
                        <p>建置 Docker 容器映像</p>
                        <button class="btn" onclick="triggerPipelineStep(3)">觸發</button>
                    </div>
                    <div class="timeline-item">
                        <h5>4. 部署到預發環境</h5>
                        <p>部署到預發環境進行測試</p>
                        <button class="btn" onclick="triggerPipelineStep(4)">觸發</button>
                    </div>
                    <div class="timeline-item">
                        <h5>5. 部署到生產環境</h5>
                        <p>手動或自動部署到生產環境</p>
                        <button class="btn" onclick="triggerPipelineStep(5)">觸發</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OAuth授权对话框 -->
    <div id="oauth-dialog" class="oauth-dialog" style="display: none;">
        <h3><i class="fas fa-shield-alt"></i> OAuth 2.0 授權</h3>
        <div class="form-group">
            <label class="form-label">應用名稱</label>
            <input type="text" class="form-control" id="oauth-app-name" value="後端模擬平台" readonly>
        </div>
        <div class="form-group">
            <label class="form-label">請求的權限</label>
            <div>
                <label><input type="checkbox" checked> 讀取用戶信息</label><br>
                <label><input type="checkbox" checked> 更新用戶信息</label><br>
                <label><input type="checkbox"> 刪除用戶信息</label>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">授權碼</label>
            <textarea class="form-control" id="oauth-auth-code" rows="3" readonly></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" onclick="approveOAuth()">授權</button>
            <button class="btn btn-warning" onclick="denyOAuth()">拒絕</button>
        </div>
    </div>

    <div id="overlay" class="overlay" style="display: none;"></div>

    <!-- 键盘快捷键提示 -->
    <div class="shortcut-hint" id="shortcut-hint">
        <div><kbd>Ctrl+S</kbd> 保存</div>
        <div><kbd>Ctrl+R</kbd> 執行</div>
        <div><kbd>Ctrl+Z</kbd> 撤銷</div>
        <div><kbd>Ctrl+Y</kbd> 重做</div>
    </div>

    <!-- 加载外部库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/display/autorefresh.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/javascript-lint.min.js"></script>

    <script>
        // ============================================
        // 全局变量和初始化
        // ============================================
        let currentPage = 'home';
        let pageHistory = [];
        let editors = {};
        let systemLogs = [];
        let routes = [];
        let users = [];
        let isDebugging = false;
        let debugLine = 0;
        let debugVariables = {};
        let requestStats = {
            total: 0,
            success: 0,
            error: 0,
            latency: []
        };
        let breakpoints = new Set();
        let pyodide = null;
        let charts = {};
        let databaseData = {
            mysql: {
                users: [
                    { id: 1, name: '張三', email: 'zhangsan@example.com', age: 25, active: 1 },
                    { id: 2, name: '李四', email: 'lisi@example.com', age: 30, active: 1 },
                    { id: 3, name: '王五', email: 'wangwu@example.com', age: 28, active: 0 }
                ],
                orders: [
                    { id: 1, user_id: 1, amount: 100, status: 'completed' },
                    { id: 2, user_id: 2, amount: 200, status: 'pending' }
                ]
            },
            mongodb: {
                users: [
                    { _id: '1', name: '張三', email: 'zhangsan@example.com', age: 25, active: true },
                    { _id: '2', name: '李四', email: 'lisi@example.com', age: 30, active: true },
                    { _id: '3', name: '王五', email: 'wangwu@example.com', age: 28, active: false }
                ],
                orders: [
                    { _id: '1', userId: '1', amount: 100, status: 'completed' },
                    { _id: '2', userId: '2', amount: 200, status: 'pending' }
                ]
            }
        };
        let gitHistory = [];
        let currentBranch = 'main';
        let undoStack = [];
        let redoStack = [];
        let currentLanguage = 'zh-TW';
        let roleHierarchy = {
            'admin': 1,
            'manager': 2,
            'user': 3,
            'guest': 4
        };
        let customLintingRules = [];
        let websocketConnection = null;
        let http2Streams = new Map();

        // 多语言文本
        const translations = {
            'zh-TW': {
                'welcome': '歡迎使用後端學習模擬平台！',
                'save': '保存',
                'run': '執行',
                'undo': '撤銷',
                'redo': '重做',
                'page': '頁面'
            },
            'en': {
                'welcome': 'Welcome to Backend Learning Simulator!',
                'save': 'Save',
                'run': 'Run',
                'undo': 'Undo',
                'redo': 'Redo',
                'page': 'Page'
            },
            'ja': {
                'welcome': 'バックエンド学習シミュレーターへようこそ！',
                'save': '保存',
                'run': '実行',
                'undo': '元に戻す',
                'redo': 'やり直す',
                'page': 'ページ'
            }
        };

        // 初始化函数
        async function init() {
            // 初始化 CodeMirror 编辑器
            editors.code = CodeMirror.fromTextArea(document.getElementById('code-editor-area'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                lineWrapping: true,
                lint: {
                    onUpdateLinting: false
                },
                gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers", "breakpoints"],
                autoRefresh: true,
                extraKeys: {
                    'Ctrl-S': function(cm) {
                        saveCode();
                    },
                    'Ctrl-R': function(cm) {
                        runCode();
                    },
                    'Ctrl-Z': function(cm) {
                        undo();
                    },
                    'Ctrl-Y': function(cm) {
                        redo();
                    },
                    'F9': function(cm) {
                        setBreakpoint();
                    },
                    'F5': function(cm) {
                        debugCode();
                    }
                }
            });

            // 初始化Pyodide
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
                });
                await pyodide.loadPackage(["micropip"]);
                addConsoleLog("Pyodide 載入成功", 'success');
                logSystemEvent('Pyodide 初始化完成', 'success');
            } catch (error) {
                console.error("Pyodide 載入失敗:", error);
                addConsoleLog("Pyodide 載入失敗，使用模擬模式執行 Python 代碼", 'warning');
                showFlash('Pyodide 載入失敗，部分功能可能受限', 'warning');
                logSystemEvent('Pyodide 初始化失敗，使用模擬模式', 'warning');
            }

            // 加载保存的数据
            loadSavedData();
            
            // 初始化系统日志
            initSystemLogs();
            
            // 初始化路由
            initRoutes();
            
            // 初始化用户数据
            initUsers();
            
            // 初始化统计信息
            updateStats();
            
            // 设置移动端适配
            setupMobile();
            
            // 初始化图表
            initCharts();
            
            // 初始化键盘快捷键
            initKeyboardShortcuts();
            
            // 初始化拖放功能
            initDragAndDrop();
            
            // 显示欢迎消息
            showFlash(translations[currentLanguage].welcome, 'info');
            logSystemEvent('系統初始化完成', 'info');
            
            // 设置HTTP版本切换监听
            document.getElementById('http-version').addEventListener('change', function() {
                const version = this.value;
                document.getElementById('http2-sim').style.display = version === '2' ? 'block' : 'none';
                document.getElementById('websocket-sim').style.display = version === 'websocket' ? 'block' : 'none';
            });

            // 点击主内容区关闭侧边栏
            document.getElementById('mainContent').addEventListener('click', function(e) {
                // 如果点击的不是侧边栏相关元素
                if (!e.target.closest('.sidebar') && !e.target.closest('.mobile-menu-btn')) {
                    if (window.innerWidth <= 1024) {
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar.classList.contains('active')) {
                            sidebar.classList.remove('active');
                            this.classList.remove('sidebar-open');
                        }
                    }
                }
            });

            // 初始化撤銷/重做堆棧監聽
            editors.code.on('change', function(cm, change) {
                undoStack.push({
                    text: change.text,
                    from: change.from,
                    to: change.to,
                    origin: change.origin
                });
                // 限制堆棧大小
                if (undoStack.length > 50) {
                    undoStack.shift();
                }
                redoStack = [];
            });

            // 初始化自訂 linting 規則
            loadCustomLintingRules();
        }

        // ============================================
        // 导航功能（增強版）
        // ============================================
        function navigateTo(pageId) {
            // 保存当前页面数据
            savePageData();
            
            const targetPage = document.getElementById(pageId);
            if (!targetPage) {
                console.error(`找不到頁面: ${pageId}`);
                return;
            }

            // 保存当前页面到历史记录（限制深度）
            if (currentPage !== pageId) {
                pageHistory.push(currentPage);
                // 限制历史记录深度
                if (pageHistory.length > 10) {
                    pageHistory = pageHistory.slice(-10);
                }
                logSystemEvent(`切換到頁面: ${pageId}`, 'info');
            }

            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // 显示目标页面
            targetPage.classList.add('active');
            currentPage = pageId;

            // 更新导航项状态
            updateNavItems();

            // 如果是移动端，自动关闭侧边栏
            if (window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('mainContent').classList.remove('sidebar-open');
            }

            // 加载页面数据
            loadPageData();
            
            // 更新页面标题
            updatePageTitle();
        }

        function savePageData() {
            if (currentPage === 'code-editor' && editors.code) {
                const content = editors.code.getValue();
                localStorage.setItem('editor-content', content);
                localStorage.setItem('editor-language', document.getElementById('language-select').value);
            }
            if (currentPage === 'router-manager') {
                localStorage.setItem('routes', JSON.stringify(routes));
            }
            if (currentPage === 'database-simulator') {
                localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
                localStorage.setItem('mongodb-data', JSON.stringify(databaseData.mongodb));
            }
            // 保存当前状态
            localStorage.setItem('last-page', currentPage);
        }

        function loadPageData() {
            if (currentPage === 'code-editor' && editors.code) {
                const savedContent = localStorage.getItem('editor-content');
                const savedLanguage = localStorage.getItem('editor-language');
                if (savedContent) {
                    editors.code.setValue(savedContent);
                }
                if (savedLanguage) {
                    document.getElementById('language-select').value = savedLanguage;
                    changeLanguage();
                }
            }
            if (currentPage === 'router-manager') {
                updateRoutesDisplay();
            }
            if (currentPage === 'dashboard') {
                updateCharts();
                updatePerformanceStats();
            }
            if (currentPage === 'authentication') {
                updateRoleHierarchyDisplay();
            }
        }

        function goBack() {
            if (pageHistory.length > 0) {
                const prevPage = pageHistory.pop();
                navigateTo(prevPage);
            } else {
                navigateTo('home');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('sidebar-open');
            
            // 如果关闭侧边栏，确保它完全隐藏
            if (!sidebar.classList.contains('active')) {
                setTimeout(() => {
                    sidebar.style.transform = 'translateX(-100%)';
                }, 300);
            }
        }

        function updateNavItems() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${currentPage}'`)) {
                    item.classList.add('active');
                }
            });
        }

        function updatePageTitle() {
            const pageTitle = document.querySelector(`#${currentPage} .page-title`);
            if (pageTitle) {
                document.title = `${pageTitle.textContent} - 後端模擬平台`;
            }
        }

        function setupMobile() {
            window.addEventListener('resize', () => {
                if (window.innerWidth > 1024) {
                    const sidebar = document.getElementById('sidebar');
                    const mainContent = document.getElementById('mainContent');
                    
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-open');
                    sidebar.style.transform = '';
                }
            });
            
            // 点击导航项时在移动端自动关闭侧边栏
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        setTimeout(() => {
                            document.getElementById('sidebar').classList.remove('active');
                            document.getElementById('mainContent').classList.remove('sidebar-open');
                        }, 300);
                    }
                });
            });
        }

        // ============================================
        // 系统日志功能（增強版）
        // ============================================
        function initSystemLogs() {
            systemLogs = JSON.parse(localStorage.getItem('system-logs') || '[]');
            if (systemLogs.length === 0) {
                systemLogs.push({
                    time: new Date().toLocaleTimeString(),
                    message: '系統啟動',
                    level: 'info',
                    module: 'system',
                    timestamp: Date.now()
                });
            }
            updateLogsDisplay();
        }

        function logSystemEvent(message, level = 'info', module = 'system') {
            const logEntry = {
                time: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString(),
                message: message,
                level: level,
                module: module,
                timestamp: Date.now(),
                user: localStorage.getItem('current-user') || 'system'
            };
            
            systemLogs.unshift(logEntry);
            
            // 限制日志数量
            if (systemLogs.length > 1000) {
                systemLogs = systemLogs.slice(0, 800);
            }
            
            localStorage.setItem('system-logs', JSON.stringify(systemLogs));
            updateLogsDisplay();
            
            // 更新仪表板显示
            if (currentPage === 'logs') {
                addLogToDisplay(logEntry);
            }
            
            // 检查是否需要触发警报
            checkAlerts(logEntry);
        }

        function updateLogsDisplay() {
            const logCount = document.getElementById('log-count');
            if (logCount) {
                logCount.textContent = systemLogs.length;
            }
            
            if (currentPage === 'logs') {
                const logsContainer = document.getElementById('system-logs');
                logsContainer.innerHTML = '';
                
                // 应用筛选
                const filteredLogs = filterLogsForDisplay();
                filteredLogs.forEach(log => {
                    addLogToDisplay(log);
                });
            }
        }

        function addLogToDisplay(log) {
            const logsContainer = document.getElementById('system-logs');
            if (!logsContainer) return;
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${log.level}`;
            logEntry.innerHTML = `
                <div class="log-time">${log.time} ${log.date}</div>
                <div class="log-message">
                    <strong>[${log.module.toUpperCase()}]</strong> ${log.message}
                    ${log.user ? `<br><small>用戶: ${JSON.parse(log.user).username || 'system'}</small>` : ''}
                </div>
            `;
            logsContainer.appendChild(logEntry);
        }

        function filterLogs() {
            updateLogsDisplay();
        }

        function filterLogsForDisplay() {
            const level = document.getElementById('log-level')?.value || 'all';
            const module = document.getElementById('log-module')?.value || 'all';
            const search = document.getElementById('log-search')?.value.toLowerCase() || '';
            const date = document.getElementById('log-date')?.value || '';
            
            return systemLogs.filter(log => {
                const matchesLevel = level === 'all' || log.level === level;
                const matchesModule = module === 'all' || log.module === module;
                const matchesSearch = !search || 
                    log.message.toLowerCase().includes(search) ||
                    log.module.toLowerCase().includes(search);
                const matchesDate = !date || log.date === new Date(date).toLocaleDateString();
                
                return matchesLevel && matchesModule && matchesSearch && matchesDate;
            });
        }

        function exportLogs() {
            const filteredLogs = filterLogsForDisplay();
            const logText = filteredLogs.map(log => 
                `[${log.date} ${log.time}] [${log.level.toUpperCase()}] [${log.module}] ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showFlash('日誌已導出', 'success');
            logSystemEvent('導出系統日誌', 'info');
        }

        function analyzeLogPatterns() {
            const logs = filterLogsForDisplay();
            const errorCount = logs.filter(log => log.level === 'error').length;
            const warningCount = logs.filter(log => log.level === 'warning').length;
            const moduleCounts = {};
            
            logs.forEach(log => {
                moduleCounts[log.module] = (moduleCounts[log.module] || 0) + 1;
            });
            
            const analysis = `
                <h4>日誌分析報告</h4>
                <div class="quality-metric">
                    <span>總日誌數</span>
                    <span>${logs.length}</span>
                </div>
                <div class="quality-metric">
                    <span>錯誤數量</span>
                    <span>${errorCount}</span>
                </div>
                <div class="quality-metric">
                    <span>警告數量</span>
                    <span>${warningCount}</span>
                </div>
                <div class="quality-metric">
                    <span>錯誤率</span>
                    <span>${logs.length > 0 ? ((errorCount / logs.length) * 100).toFixed(2) : 0}%</span>
                </div>
                <h5>模組分布</h5>
                ${Object.entries(moduleCounts).map(([module, count]) => `
                    <div class="quality-metric">
                        <span>${module}</span>
                        <span>${count} (${((count / logs.length) * 100).toFixed(1)}%)</span>
                    </div>
                `).join('')}
            `;
            
            document.getElementById('log-analysis-content').innerHTML = analysis;
            document.getElementById('log-analysis-report').style.display = 'block';
            
            logSystemEvent('執行日誌分析', 'info');
        }

        function clearLogs() {
            if (confirm('確定要清空所有日誌嗎？此操作不可恢復。')) {
                systemLogs = [{
                    time: new Date().toLocaleTimeString(),
                    date: new Date().toLocaleDateString(),
                    message: '日誌已清空',
                    level: 'info',
                    module: 'system',
                    timestamp: Date.now()
                }];
                localStorage.setItem('system-logs', JSON.stringify(systemLogs));
                updateLogsDisplay();
                showFlash('日誌已清空', 'success');
                logSystemEvent('清空系統日誌', 'warning');
            }
        }

        // ============================================
        // Flash消息功能
        // ============================================
        function showFlash(message, type = 'info') {
            const container = document.getElementById('flash-container');
            const flash = document.createElement('div');
            flash.className = `flash-message flash-${type}`;
            flash.innerHTML = `
                <i class="fas fa-${getFlashIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(flash);
            
            setTimeout(() => {
                flash.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (flash.parentNode) {
                        flash.parentNode.removeChild(flash);
                    }
                }, 300);
            }, 3000);
        }

        function getFlashIcon(type) {
            const icons = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // ============================================
        // 代码编辑器功能（全面增強版）
        // ============================================
        function changeLanguage() {
            const lang = document.getElementById('language-select').value;
            const modes = {
                'python': 'python',
                'javascript': 'javascript',
                'java': 'text/x-java',
                'sql': 'sql'
            };
            
            if (modes[lang]) {
                editors.code.setOption('mode', modes[lang]);
                
                // 更新语法检查规则
                updateSyntaxChecking(lang);
                
                showFlash(`已切換到 ${lang} 語言模式`, 'info');
                logSystemEvent(`切換代碼語言: ${lang}`, 'info');
                
                // 重置断点
                breakpoints.clear();
                updateBreakpointsDisplay();
                
                // 保存语言选择
                localStorage.setItem('editor-language', lang);
            }
        }

        function updateSyntaxChecking(language) {
            // 根据语言更新语法检查规则
            const lintingRules = {
                'python': {
                    rules: {
                        'indentation': true,
                        'unused-imports': true,
                        'undefined-variables': true
                    }
                },
                'javascript': {
                    rules: {
                        'no-unused-vars': true,
                        'no-undef': true,
                        'eqeqeq': true
                    }
                },
                'java': {
                    rules: {
                        'unused-imports': true,
                        'unused-variables': true
                    }
                }
            };
            
            // 应用自定义规则
            applyCustomLintingRules();
            
            logSystemEvent(`更新語法檢查規則: ${language}`, 'info');
        }

        async function runCode() {
            const code = editors.code.getValue();
            const language = document.getElementById('language-select').value;
            
            logSystemEvent('開始執行代碼', 'info');
            showFlash('代碼執行中...', 'info');
            
            // 显示加载动画
            const runBtn = document.querySelector('.btn[onclick="runCode()"]');
            const originalHtml = runBtn.innerHTML;
            runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 執行中...';
            runBtn.disabled = true;
            
            try {
                let result;
                const startTime = Date.now();
                
                if (language === 'python') {
                    result = await executePythonCode(code);
                } else if (language === 'javascript') {
                    result = executeJavaScriptCode(code);
                } else if (language === 'java') {
                    result = simulateJavaCode(code);
                } else if (language === 'sql') {
                    result = executeSQLCode(code);
                } else {
                    result = simulateCodeExecution(code, language);
                }
                
                const executionTime = Date.now() - startTime;
                
                if (result.success) {
                    addConsoleLog('代碼執行成功', 'success', 
                        `輸出: ${result.output}\n執行時間: ${executionTime}ms`);
                    showFlash(`代碼執行成功 (${executionTime}ms)`, 'success');
                    logSystemEvent('代碼執行完成', 'success');
                    
                    requestStats.success++;
                    requestStats.total++;
                    requestStats.latency.push(executionTime);
                    
                    // 执行多層次程式碼分析
                    performCodeAnalysis(code, language);
                } else {
                    addConsoleLog('代碼執行失敗', 'error', result.error);
                    showFlash('代碼執行失敗', 'error');
                    logSystemEvent(`代碼執行錯誤: ${result.error.substring(0, 100)}`, 'error');
                    
                    requestStats.error++;
                    requestStats.total++;
                }
                
                updateStats();
            } catch (error) {
                addConsoleLog('代碼執行錯誤', 'error', error.message);
                showFlash('代碼執行錯誤', 'error');
                logSystemEvent(`代碼執行異常: ${error.message}`, 'error');
                
                requestStats.error++;
                requestStats.total++;
                updateStats();
            } finally {
                // 恢复按钮状态
                runBtn.innerHTML = originalHtml;
                runBtn.disabled = false;
            }
        }

        async function executePythonCode(code) {
            try {
                if (!pyodide) {
                    throw new Error('Pyodide 未載入，無法執行 Python 代碼');
                }
                
                // 設置執行環境
                await pyodide.runPythonAsync(`
                    import sys
                    import io
                    import traceback
                    
                    class OutputCapture:
                        def __init__(self):
                            self.output = io.StringIO()
                        
                        def write(self, text):
                            self.output.write(text)
                        
                        def getvalue(self):
                            return self.output.getvalue()
                    
                    stdout_capture = OutputCapture()
                    stderr_capture = OutputCapture()
                    sys.stdout = stdout_capture
                    sys.stderr = stderr_capture
                `);
                
                // 執行代碼
                await pyodide.runPythonAsync(code);
                
                // 獲取輸出
                const stdout = pyodide.runPython('stdout_capture.getvalue()');
                const stderr = pyodide.runPython('stderr_capture.getvalue()');
                
                if (stderr) {
                    return { 
                        success: false, 
                        error: `Python 錯誤: ${stderr}`,
                        stackTrace: stderr
                    };
                }
                
                return { 
                    success: true, 
                    output: stdout || '代碼執行完成（無輸出）',
                    executionTime: '50ms'
                };
            } catch (error) {
                return { 
                    success: false, 
                    error: `Python 執行錯誤: ${error.message}`,
                    stackTrace: error.stack
                };
            }
        }

        function executeJavaScriptCode(code) {
            try {
                const output = [];
                const errors = [];
                
                // 保存原始 console 方法
                const originalConsole = {
                    log: console.log,
                    error: console.error,
                    warn: console.warn,
                    info: console.info
                };
                
                // 重定向 console 输出
                console.log = function(...args) {
                    output.push(args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                    ).join(' '));
                    originalConsole.log.apply(console, args);
                };
                
                console.error = function(...args) {
                    errors.push(args.join(' '));
                    originalConsole.error.apply(console, args);
                };
                
                console.warn = function(...args) {
                    output.push(`[警告] ${args.join(' ')}`);
                    originalConsole.warn.apply(console, args);
                };
                
                console.info = function(...args) {
                    output.push(`[信息] ${args.join(' ')}`);
                    originalConsole.info.apply(console, args);
                };
                
                // 在安全沙箱中执行代码
                try {
                    // 创建安全执行环境
                    const safeGlobals = {
                        console: console,
                        setTimeout: setTimeout,
                        clearTimeout: clearTimeout,
                        setInterval: setInterval,
                        clearInterval: clearInterval,
                        JSON: JSON,
                        Math: Math,
                        Date: Date,
                        Array: Array,
                        Object: Object,
                        String: String,
                        Number: Number,
                        Boolean: Boolean,
                        RegExp: RegExp,
                        Error: Error,
                        TypeError: TypeError,
                        RangeError: RangeError,
                        SyntaxError: SyntaxError,
                        isNaN: isNaN,
                        isFinite: isFinite,
                        parseFloat: parseFloat,
                        parseInt: parseInt,
                        encodeURI: encodeURI,
                        encodeURIComponent: encodeURIComponent,
                        decodeURI: decodeURI,
                        decodeURIComponent: decodeURIComponent
                    };
                    
                    // 创建沙箱函数
                    const sandbox = new Function(...Object.keys(safeGlobals), `
                        "use strict";
                        try {
                            ${code}
                            return { success: true, output: "代碼執行完成" };
                        } catch (error) {
                            return { success: false, error: error.message, stack: error.stack };
                        }
                    `);
                    
                    const result = sandbox(...Object.values(safeGlobals));
                    
                    if (result && !result.success) {
                        throw new Error(result.error);
                    }
                    
                } catch (error) {
                    errors.push(error.message);
                } finally {
                    // 恢复原始 console 方法
                    console.log = originalConsole.log;
                    console.error = originalConsole.error;
                    console.warn = originalConsole.warn;
                    console.info = originalConsole.info;
                }
                
                if (errors.length > 0) {
                    return {
                        success: false,
                        error: `JavaScript 錯誤: ${errors.join('\n')}`,
                        stackTrace: errors.join('\n')
                    };
                }
                
                return {
                    success: true,
                    output: output.join('\n') || '代碼執行完成（無輸出）',
                    executionTime: '30ms'
                };
            } catch (error) {
                return {
                    success: false,
                    error: `JavaScript 執行錯誤: ${error.message}`,
                    stackTrace: error.stack
                };
            }
        }

        function simulateJavaCode(code) {
            // Java 代码模拟执行
            const syntaxErrors = checkJavaSyntax(code);
            if (syntaxErrors.length > 0) {
                return {
                    success: false,
                    error: `Java 語法錯誤:\n${syntaxErrors.join('\n')}`
                };
            }
            
            return {
                success: true,
                output: `Java 代碼語法檢查通過\n編譯成功，模擬執行完成`,
                executionTime: '150ms'
            };
        }

        function executeSQLCode(code) {
            // 调用数据库模拟器的查询功能
            const dbType = 'mysql'; // 默认使用 MySQL
            const result = executeMySQLQuery(code);
            
            if (result.success) {
                return {
                    success: true,
                    output: `SQL 查詢執行成功\n影響行數: ${result.affectedRows || 0}\n結果: ${JSON.stringify(result.data, null, 2)}`,
                    executionTime: '25ms'
                };
            } else {
                return {
                    success: false,
                    error: `SQL 錯誤: ${result.error}`
                };
            }
        }

        function checkJavaSyntax(code) {
            const errors = [];
            
            // 检查类定义
            if (!code.includes('class ')) {
                errors.push('缺少類定義');
            }
            
            // 检查 main 方法
            if (!code.includes('public static void main')) {
                errors.push('缺少 main 方法');
            }
            
            // 检查分号
            const lines = code.split('\n');
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (trimmed && !trimmed.startsWith('//') && !trimmed.startsWith('*') && 
                    !trimmed.startsWith('/*') && !trimmed.endsWith('{') && 
                    !trimmed.endsWith('}') && !trimmed.includes('class ') &&
                    !trimmed.includes('import ') && !trimmed.includes('package ') &&
                    !trimmed.endsWith(';') && !trimmed.startsWith('@')) {
                    errors.push(`第 ${index + 1} 行: 缺少分號`);
                }
            });
            
            return errors;
        }

        function simulateCodeExecution(code, language) {
            // 语法检查
            const syntaxErrors = checkSyntax(code, language);
            if (syntaxErrors.length > 0) {
                return {
                    success: false,
                    error: `語法錯誤:\n${syntaxErrors.join('\n')}`
                };
            }
            
            // 模拟执行延迟
            const executionTime = 100 + Math.random() * 200;
            
            return {
                success: true,
                output: `代碼語法檢查通過\n語言: ${language}\n執行時間: ${Math.round(executionTime)}ms`,
                executionTime: `${Math.round(executionTime)}ms`
            };
        }

        function checkSyntax(code, language) {
            const errors = [];
            
            if (language === 'python') {
                // 检查Python语法
                if (code.includes('print ') && !code.includes('print(')) {
                    errors.push('Python 3 中使用 print() 而不是 print');
                }
                
                // 检查缩进
                const lines = code.split('\n');
                let indentLevel = 0;
                let inMultilineString = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const trimmed = line.trim();
                    
                    if (trimmed.startsWith('"""') || trimmed.startsWith("'''")) {
                        inMultilineString = !inMultilineString;
                    }
                    
                    if (inMultilineString) continue;
                    
                    if (trimmed.endsWith(':')) {
                        indentLevel++;
                    } else if (trimmed.startsWith('return') || trimmed.startsWith('break') || 
                               trimmed.startsWith('continue') || trimmed.startsWith('pass') ||
                               trimmed.startsWith('raise')) {
                        // 这些语句会减少缩进级别
                    }
                    
                    // 检查混合制表符和空格
                    if (line.includes(' ') && line.includes('\t')) {
                        errors.push(`第 ${i + 1} 行: 混合使用制表符和空格`);
                    }
                }
            }
            
            return errors;
        }

        function setBreakpoint() {
            const cursor = editors.code.getCursor();
            const line = cursor.line + 1;
            
            if (breakpoints.has(line)) {
                breakpoints.delete(line);
                showFlash(`已移除第 ${line} 行的斷點`, 'info');
                logSystemEvent(`移除斷點: 第 ${line} 行`, 'info');
            } else {
                breakpoints.add(line);
                showFlash(`已在第 ${line} 行設置斷點`, 'info');
                logSystemEvent(`設置斷點: 第 ${line} 行`, 'info');
            }
            
            updateBreakpointsDisplay();
        }

        function updateBreakpointsDisplay() {
            const gutters = editors.code.getGutterElement();
            let breakpointGutter = gutters.querySelector('.breakpoints-gutter');
            
            if (!breakpointGutter) {
                breakpointGutter = document.createElement('div');
                breakpointGutter.className = 'breakpoints-gutter';
                breakpointGutter.style.width = '20px';
                gutters.appendChild(breakpointGutter);
            }
            
            breakpointGutter.innerHTML = '';
            
            // 获取总行数
            const lineCount = editors.code.lineCount();
            
            for (let i = 0; i < lineCount; i++) {
                const line = i + 1;
                if (breakpoints.has(line)) {
                    const marker = document.createElement('div');
                    marker.className = 'breakpoint';
                    marker.innerHTML = '●';
                    marker.style.lineHeight = '18px';
                    marker.style.textAlign = 'center';
                    marker.style.cursor = 'pointer';
                    marker.style.color = 'var(--accent-red)';
                    marker.style.fontSize = '12px';
                    marker.onclick = function(e) {
                        e.stopPropagation();
                        breakpoints.delete(line);
                        updateBreakpointsDisplay();
                    };
                    breakpointGutter.appendChild(marker);
                } else {
                    const spacer = document.createElement('div');
                    spacer.style.height = '18px';
                    breakpointGutter.appendChild(spacer);
                }
            }
        }

        function debugCode() {
            if (isDebugging) {
                stopDebug();
                return;
            }
            
            isDebugging = true;
            debugLine = 0;
            debugVariables = {};
            
            document.getElementById('debug-panel').style.display = 'block';
            showFlash('調試模式已啟動，點擊"下一步"開始調試', 'info');
            logSystemEvent('進入調試模式', 'info');
            
            // 更新当前行显示
            document.getElementById('current-line').textContent = debugLine;
            
            // 启用调试按钮
            document.querySelectorAll('#debug-panel .btn').forEach(btn => {
                btn.disabled = false;
            });
        }

        function stepDebug() {
            if (!isDebugging) return;
            
            debugLine++;
            const code = editors.code.getValue();
            const lines = code.split('\n');
            
            if (debugLine > lines.length) {
                stopDebug();
                showFlash('調試完成，已到達文件末尾', 'success');
                return;
            }
            
            // 检查断点
            if (breakpoints.has(debugLine)) {
                showFlash(`在第 ${debugLine} 行遇到斷點，暫停執行`, 'warning');
                logSystemEvent(`調試器在斷點暫停: 第 ${debugLine} 行`, 'info');
                
                // 高亮显示当前行
                editors.code.addLineClass(debugLine - 1, 'background', 'rgba(255, 255, 0, 0.1)');
                
                return; // 暂停在断点
            }
            
            // 更新当前行显示
            document.getElementById('current-line').textContent = debugLine;
            
            // 高亮显示当前行
            editors.code.addLineClass(debugLine - 1, 'background', 'rgba(56, 189, 248, 0.1)');
            
            // 分析当前行的变量
            const currentLine = lines[debugLine - 1];
            analyzeLineForVariables(currentLine, debugLine);
            
            // 更新变量监视
            updateDebugVariables();
            
            // 自动滚动到当前行
            editors.code.scrollIntoView({line: debugLine - 1, ch: 0}, 100);
        }

        function analyzeLineForVariables(line, lineNumber) {
            const trimmed = line.trim();
            
            // 匹配变量赋值
            const varAssignment = trimmed.match(/(\w+)\s*=\s*([^#]+)/);
            if (varAssignment) {
                const varName = varAssignment[1];
                let varValue = varAssignment[2].trim();
                
                // 尝试计算表达式
                try {
                    // 移除可能的尾随逗号
                    if (varValue.endsWith(',')) {
                        varValue = varValue.slice(0, -1);
                    }
                    
                    // 尝试作为数字计算
                    if (!isNaN(eval(varValue))) {
                        varValue = eval(varValue);
                    } else if (varValue.startsWith('"') && varValue.endsWith('"') ||
                               varValue.startsWith("'") && varValue.endsWith("'")) {
                        varValue = varValue.slice(1, -1);
                    }
                } catch (e) {
                    // 如果不能计算，保持原样
                }
                
                debugVariables[varName] = {
                    value: varValue,
                    type: typeof varValue,
                    line: lineNumber
                };
            }
            
            // 匹配函数调用
            const functionCall = trimmed.match(/(\w+)\(([^)]*)\)/);
            if (functionCall) {
                const funcName = functionCall[1];
                const args = functionCall[2];
                
                debugVariables[`call_${funcName}_${lineNumber}`] = {
                    value: `${funcName}(${args})`,
                    type: 'function_call',
                    line: lineNumber
                };
            }
            
            // 匹配条件语句
            if (trimmed.startsWith('if ') || trimmed.startsWith('elif ') || trimmed.startsWith('while ')) {
                const condition = trimmed.match(/if\s+(.+):|elif\s+(.+):|while\s+(.+):/);
                if (condition) {
                    const condExpr = condition[1] || condition[2] || condition[3];
                    debugVariables[`condition_${lineNumber}`] = {
                        value: condExpr,
                        type: 'condition',
                        line: lineNumber
                    };
                }
            }
        }

        function updateDebugVariables() {
            const varsContainer = document.getElementById('variables-watch');
            varsContainer.innerHTML = '';
            
            // 按行号排序
            const sortedVars = Object.entries(debugVariables)
                .sort((a, b) => a[1].line - b[1].line);
            
            sortedVars.forEach(([key, data]) => {
                const varDiv = document.createElement('div');
                varDiv.className = 'variable-watch';
                varDiv.innerHTML = `
                    <div class="var-name">${key} (第${data.line}行):</div>
                    <div class="var-value" title="類型: ${data.type}">${data.value}</div>
                `;
                varsContainer.appendChild(varDiv);
            });
            
            // 如果没有变量，显示提示
            if (sortedVars.length === 0) {
                varsContainer.innerHTML = '<div style="color: var(--text-gray); padding: 10px; text-align: center;">暫無變量數據</div>';
            }
        }

        function stepOver() {
            if (!isDebugging) {
                showFlash('請先啟動調試模式', 'warning');
                return;
            }
            
            // 清除之前的高亮
            editors.code.removeLineClass(debugLine - 1, 'background');
            
            stepDebug();
        }

        function continueDebug() {
            if (!isDebugging) {
                showFlash('請先啟動調試模式', 'warning');
                return;
            }
            
            // 清除之前的高亮
            editors.code.removeLineClass(debugLine - 1, 'background');
            
            // 继续执行直到下一个断点或结束
            const code = editors.code.getValue();
            const lines = code.split('\n');
            
            const interval = setInterval(() => {
                if (!isDebugging) {
                    clearInterval(interval);
                    return;
                }
                
                // 清除之前的高亮
                editors.code.removeLineClass(debugLine - 1, 'background');
                
                debugLine++;
                
                // 检查是否到达文件末尾
                if (debugLine > lines.length) {
                    clearInterval(interval);
                    stopDebug();
                    showFlash('調試完成，已到達文件末尾', 'success');
                    return;
                }
                
                // 检查断点
                if (breakpoints.has(debugLine)) {
                    clearInterval(interval);
                    showFlash(`在第 ${debugLine} 行遇到斷點`, 'warning');
                    logSystemEvent(`調試器在斷點暫停: 第 ${debugLine} 行`, 'info');
                    
                    // 高亮显示当前行
                    editors.code.addLineClass(debugLine - 1, 'background', 'rgba(255, 255, 0, 0.1)');
                    
                    // 更新显示
                    document.getElementById('current-line').textContent = debugLine;
                    analyzeLineForVariables(lines[debugLine - 1], debugLine);
                    updateDebugVariables();
                    editors.code.scrollIntoView({line: debugLine - 1, ch: 0}, 100);
                    return;
                }
                
                // 更新显示
                document.getElementById('current-line').textContent = debugLine;
                analyzeLineForVariables(lines[debugLine - 1], debugLine);
                updateDebugVariables();
                
                // 高亮显示当前行
                editors.code.addLineClass(debugLine - 1, 'background', 'rgba(56, 189, 248, 0.1)');
                editors.code.scrollIntoView({line: debugLine - 1, ch: 0}, 100);
                
            }, 500); // 每500ms执行一步
        }

        function stopDebug() {
            isDebugging = false;
            
            // 清除所有高亮
            const code = editors.code.getValue();
            const lines = code.split('\n');
            for (let i = 0; i < lines.length; i++) {
                editors.code.removeLineClass(i, 'background');
            }
            
            document.getElementById('debug-panel').style.display = 'none';
            showFlash('調試已停止', 'info');
            logSystemEvent('調試模式結束', 'info');
        }

        function saveCode() {
            const code = editors.code.getValue();
            const language = document.getElementById('language-select').value;
            
            const saveData = {
                code: code,
                language: language,
                timestamp: new Date().toISOString(),
                breakpoints: Array.from(breakpoints)
            };
            
            localStorage.setItem('saved-code', JSON.stringify(saveData));
            showFlash('代碼已保存', 'success');
            logSystemEvent('代碼保存成功', 'success');
        }

        function loadSnippet() {
            const template = document.getElementById('code-template').value;
            const snippets = {
                'flask-api': `from flask import Flask, jsonify, request
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

# 配置設定
app.config['SECRET_KEY'] = 'your-secret-key'
app.config['JSON_AS_ASCII'] = False  # 支持中文

@app.route('/api/health', methods=['GET'])
def health_check():
    """健康檢查端點"""
    return jsonify({
        "status": "healthy",
        "timestamp": "2024-01-01T00:00:00Z",
        "service": "Flask API"
    }), 200

@app.route('/api/users', methods=['GET'])
def get_users():
    """獲取所有用戶"""
    users = [
        {"id": 1, "name": "張三", "email": "zhangsan@example.com"},
        {"id": 2, "name": "李四", "email": "lisi@example.com"}
    ]
    return jsonify({
        "success": True,
        "data": users,
        "count": len(users)
    }), 200

@app.route('/api/users', methods=['POST'])
def create_user():
    """創建新用戶"""
    data = request.get_json()
    
    # 驗證請求數據
    if not data:
        return jsonify({"error": "請求數據不能為空"}), 400
    
    required_fields = ['name', 'email']
    for field in required_fields:
        if field not in data:
            return jsonify({"error": f"缺少必要字段: {field}"}), 400
    
    # 模擬創建用戶
    new_user = {
        "id": 3,
        "name": data['name'],
        "email": data['email'],
        "created_at": "2024-01-01T00:00:00Z"
    }
    
    return jsonify({
        "success": True,
        "message": "用戶創建成功",
        "data": new_user
    }), 201

@app.route('/api/users/<int:user_id>', methods=['GET'])
def get_user(user_id):
    """根據ID獲取用戶"""
    # 模擬數據庫查詢
    users = [
        {"id": 1, "name": "張三", "email": "zhangsan@example.com"},
        {"id": 2, "name": "李四", "email": "lisi@example.com"}
    ]
    
    user = next((u for u in users if u['id'] == user_id), None)
    
    if not user:
        return jsonify({"error": "用戶不存在"}), 404
    
    return jsonify({
        "success": True,
        "data": user
    }), 200

@app.errorhandler(404)
def not_found(error):
    """處理404錯誤"""
    return jsonify({
        "error": "資源不存在",
        "message": str(error)
    }), 404

@app.errorhandler(500)
def internal_error(error):
    """處理500錯誤"""
    return jsonify({
        "error": "伺服器內部錯誤",
        "message": str(error)
    }), 500

if __name__ == '__main__':
    # 開發環境配置
    app.run(
        host='0.0.0.0',
        port=5000,
        debug=True,
        threaded=True
    )`,
                'jwt-auth': `const jwt = require('jsonwebtoken');
const express = require('express');
const cors = require('cors');
const bcrypt = require('bcryptjs');

const app = express();

// 中間件
app.use(cors());
app.use(express.json());

// 配置
const SECRET_KEY = process.env.JWT_SECRET || 'your-secret-key-here-change-in-production';
const TOKEN_EXPIRY = '1h';
const REFRESH_TOKEN_EXPIRY = '7d';

// 模擬用戶數據庫
const users = [
    {
        id: 1,
        username: 'admin',
        // 密碼: admin123
        password: '$2a$10$N9qo8uLOickgx2ZMRZoMye8u4J1c5b2C6F5Q6JZ8tQ6nWQ9vYzQaO',
        email: 'admin@example.com',
        role: 'admin',
        permissions: ['read', 'write', 'delete', 'manage_users']
    },
    {
        id: 2,
        username: 'user1',
        // 密碼: password123
        password: '$2a$10$N9qo8uLOickgx2ZMRZoMye8u4J1c5b2C6F5Q6JZ8tQ6nWQ9vYzQaO',
        email: 'user1@example.com',
        role: 'user',
        permissions: ['read', 'write']
    }
];

// 刷新 Token 存儲（生產環境應使用 Redis 或數據庫）
const refreshTokens = new Map();

// 登入接口
app.post('/api/auth/login', async (req, res) => {
    try {
        const { username, password } = req.body;
        
        // 驗證輸入
        if (!username || !password) {
            return res.status(400).json({
                success: false,
                error: '用戶名和密碼為必填項'
            });
        }
        
        // 查找用戶
        const user = users.find(u => u.username === username);
        
        if (!user) {
            return res.status(401).json({
                success: false,
                error: '用戶名或密碼錯誤'
            });
        }
        
        // 驗證密碼（生產環境使用 bcrypt 比對）
        // 這裡簡化為直接比較
        const isValidPassword = password === 'admin123' || password === 'password123';
        
        if (!isValidPassword) {
            return res.status(401).json({
                success: false,
                error: '用戶名或密碼錯誤'
            });
        }
        
        // 生成 JWT Token
        const accessToken = jwt.sign(
            {
                userId: user.id,
                username: user.username,
                role: user.role,
                permissions: user.permissions
            },
            SECRET_KEY,
            { expiresIn: TOKEN_EXPIRY }
        );
        
        // 生成刷新 Token
        const refreshToken = jwt.sign(
            {
                userId: user.id,
                type: 'refresh'
            },
            SECRET_KEY,
            { expiresIn: REFRESH_TOKEN_EXPIRY }
        );
        
        // 存儲刷新 Token
        refreshTokens.set(refreshToken, {
            userId: user.id,
            createdAt: new Date()
        });
        
        // 返回結果
        res.json({
            success: true,
            accessToken,
            refreshToken,
            user: {
                id: user.id,
                username: user.username,
                email: user.email,
                role: user.role,
                permissions: user.permissions
            },
            expiresIn: TOKEN_EXPIRY
        });
        
    } catch (error) {
        console.error('登入錯誤:', error);
        res.status(500).json({
            success: false,
            error: '伺服器內部錯誤'
        });
    }
});

// 刷新 Token 接口
app.post('/api/auth/refresh', (req, res) => {
    try {
        const { refreshToken } = req.body;
        
        if (!refreshToken) {
            return res.status(400).json({
                success: false,
                error: '刷新 Token 為必填項'
            });
        }
        
        // 驗證刷新 Token
        if (!refreshTokens.has(refreshToken)) {
            return res.status(401).json({
                success: false,
                error: '無效的刷新 Token'
            });
        }
        
        // 驗證 JWT
        let decoded;
        try {
            decoded = jwt.verify(refreshToken, SECRET_KEY);
        } catch (error) {
            // 移除無效的刷新 Token
            refreshTokens.delete(refreshToken);
            return res.status(401).json({
                success: false,
                error: '刷新 Token 已過期或無效'
            });
        }
        
        if (decoded.type !== 'refresh') {
            return res.status(401).json({
                success: false,
                error: '無效的 Token 類型'
            });
        }
        
        // 查找用戶
        const user = users.find(u => u.id === decoded.userId);
        if (!user) {
            return res.status(401).json({
                success: false,
                error: '用戶不存在'
            });
        }
        
        // 生成新的存取 Token
        const newAccessToken = jwt.sign(
            {
                userId: user.id,
                username: user.username,
                role: user.role,
                permissions: user.permissions
            },
            SECRET_KEY,
            { expiresIn: TOKEN_EXPIRY }
        );
        
        // 返回新 Token
        res.json({
            success: true,
            accessToken: newAccessToken,
            expiresIn: TOKEN_EXPIRY
        });
        
    } catch (error) {
        console.error('刷新 Token 錯誤:', error);
        res.status(500).json({
            success: false,
            error: '伺服器內部錯誤'
        });
    }
});

// 驗證中間件
const authenticate = (req, res, next) => {
    try {
        const authHeader = req.headers['authorization'];
        
        if (!authHeader) {
            return res.status(401).json({
                success: false,
                error: '需要授權 Token'
            });
        }
        
        const token = authHeader.split(' ')[1];
        
        if (!token) {
            return res.status(401).json({
                success: false,
                error: 'Token 格式錯誤'
            });
        }
        
        // 驗證 Token
        const decoded = jwt.verify(token, SECRET_KEY);
        req.user = decoded;
        next();
        
    } catch (error) {
        if (error.name === 'TokenExpiredError') {
            return res.status(401).json({
                success: false,
                error: 'Token 已過期，請重新登入或刷新 Token'
            });
        }
        
        return res.status(403).json({
            success: false,
            error: '無效的 Token'
        });
    }
};

// 權限檢查中間件
const authorize = (...requiredPermissions) => {
    return (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                success: false,
                error: '需要授權'
            });
        }
        
        const userPermissions = req.user.permissions || [];
        
        // 檢查是否擁有所有需要的權限
        const hasAllPermissions = requiredPermissions.every(perm => 
            userPermissions.includes(perm)
        );
        
        if (!hasAllPermissions) {
            return res.status(403).json({
                success: false,
                error: '權限不足'
            });
        }
        
        next();
    };
};

// 受保護的路由示例
app.get('/api/protected', authenticate, (req, res) => {
    res.json({
        success: true,
        message: '訪問受保護資源成功',
        user: req.user
    });
});

// 需要特定權限的路由
app.get('/api/admin', authenticate, authorize('manage_users'), (req, res) => {
    res.json({
        success: true,
        message: '管理員資源訪問成功',
        data: {
            users: users.map(u => ({
                id: u.id,
                username: u.username,
                email: u.email,
                role: u.role
            }))
        }
    });
});

// 登出接口
app.post('/api/auth/logout', (req, res) => {
    const { refreshToken } = req.body;
    
    if (refreshToken) {
        refreshTokens.delete(refreshToken);
    }
    
    res.json({
        success: true,
        message: '登出成功'
    });
});

// 啟動伺服器
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(\`伺服器運行在端口 \${PORT}\`);
    console.log('JWT 認證系統已就緒');
});`,
                'express-api': `const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');

const app = express();

// 中間件
app.use(helmet()); // 安全頭部
app.use(cors()); // CORS
app.use(express.json()); // JSON 解析
app.use(morgan('combined')); // 日誌

// 路由中間件 - 請求日誌
app.use((req, res, next) => {
    console.log(\`[\${new Date().toISOString()}] \${req.method} \${req.url}\`);
    next();
});

// 路由中間件 - 錯誤處理
app.use((err, req, res, next) => {
    console.error('錯誤:', err);
    res.status(500).json({
        error: '伺服器內部錯誤',
        message: err.message
    });
});

// 健康檢查
app.get('/api/health', (req, res) => {
    res.json({
        status: 'healthy',
        timestamp: new Date().toISOString(),
        uptime: process.uptime()
    });
});

// 用戶路由
const usersRouter = express.Router();

// 獲取所有用戶
usersRouter.get('/', (req, res) => {
    const users = [
        { id: 1, name: '張三', email: 'zhangsan@example.com' },
        { id: 2, name: '李四', email: 'lisi@example.com' }
    ];
    
    res.json({
        success: true,
        data: users,
        count: users.length
    });
});

// 創建用戶
usersRouter.post('/', (req, res) => {
    const { name, email } = req.body;
    
    if (!name || !email) {
        return res.status(400).json({
            success: false,
            error: '姓名和郵箱為必填項'
        });
    }
    
    const newUser = {
        id: Date.now(),
        name,
        email,
        createdAt: new Date().toISOString()
    };
    
    res.status(201).json({
        success: true,
        message: '用戶創建成功',
        data: newUser
    });
});

// 根據ID獲取用戶
usersRouter.get('/:id', (req, res) => {
    const userId = parseInt(req.params.id);
    
    if (isNaN(userId)) {
        return res.status(400).json({
            success: false,
            error: '無效的用戶ID'
        });
    }
    
    const user = { id: userId, name: '張三', email: 'zhangsan@example.com' };
    
    res.json({
        success: true,
        data: user
    });
});

// 更新用戶
usersRouter.put('/:id', (req, res) => {
    const userId = parseInt(req.params.id);
    const updates = req.body;
    
    if (isNaN(userId)) {
        return res.status(400).json({
            success: false,
            error: '無效的用戶ID'
        });
    }
    
    res.json({
        success: true,
        message: '用戶更新成功',
        data: { id: userId, ...updates }
    });
});

// 刪除用戶
usersRouter.delete('/:id', (req, res) => {
    const userId = parseInt(req.params.id);
    
    if (isNaN(userId)) {
        return res.status(400).json({
            success: false,
            error: '無效的用戶ID'
        });
    }
    
    res.json({
        success: true,
        message: '用戶刪除成功',
        data: { id: userId }
    });
});

// 註冊路由
app.use('/api/users', usersRouter);

// 商品路由
const productsRouter = express.Router();

productsRouter.get('/', (req, res) => {
    const products = [
        { id: 1, name: '商品A', price: 100 },
        { id: 2, name: '商品B', price: 200 }
    ];
    
    // 支持查詢參數
    const { minPrice, maxPrice } = req.query;
    let filteredProducts = products;
    
    if (minPrice) {
        filteredProducts = filteredProducts.filter(p => p.price >= parseInt(minPrice));
    }
    
    if (maxPrice) {
        filteredProducts = filteredProducts.filter(p => p.price <= parseInt(maxPrice));
    }
    
    res.json({
        success: true,
        data: filteredProducts,
        count: filteredProducts.length
    });
});

app.use('/api/products', productsRouter);

// 404 處理
app.use((req, res) => {
    res.status(404).json({
        success: false,
        error: '資源不存在',
        path: req.url,
        method: req.method
    });
});

// 啟動伺服器
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(\`Express 伺服器運行在端口 \${PORT}\`);
    console.log(\`健康檢查: http://localhost:\${PORT}/api/health\`);
});`,
                'springboot-api': `package com.example.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.atomic.AtomicLong;

@SpringBootApplication
@RestController
@RequestMapping("/api")
public class DemoApplication {
    
    private final AtomicLong counter = new AtomicLong();
    private final List<User> users = new ArrayList<>();
    
    // 初始化數據
    public DemoApplication() {
        users.add(new User(counter.incrementAndGet(), "張三", "zhangsan@example.com"));
        users.add(new User(counter.incrementAndGet(), "李四", "lisi@example.com"));
    }
    
    // 健康檢查端點
    @GetMapping("/health")
    public ResponseEntity<ApiResponse> healthCheck() {
        return ResponseEntity.ok(
            new ApiResponse(true, "服務運行正常", new HealthStatus())
        );
    }
    
    // 獲取所有用戶
    @GetMapping("/users")
    public ResponseEntity<ApiResponse> getAllUsers() {
        return ResponseEntity.ok(
            new ApiResponse(true, "獲取用戶列表成功", users)
        );
    }
    
    // 根據ID獲取用戶
    @GetMapping("/users/{id}")
    public ResponseEntity<ApiResponse> getUserById(@PathVariable Long id) {
        Optional<User> user = users.stream()
            .filter(u -> u.getId().equals(id))
            .findFirst();
        
        if (user.isPresent()) {
            return ResponseEntity.ok(
                new ApiResponse(true, "獲取用戶成功", user.get())
            );
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body(new ApiResponse(false, "用戶不存在", null));
        }
    }
    
    // 創建新用戶
    @PostMapping("/users")
    public ResponseEntity<ApiResponse> createUser(@RequestBody User newUser) {
        // 驗證輸入
        if (newUser.getName() == null || newUser.getName().trim().isEmpty()) {
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "用戶姓名不能為空", null));
        }
        
        if (newUser.getEmail() == null || newUser.getEmail().trim().isEmpty()) {
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "用戶郵箱不能為空", null));
        }
        
        // 設置ID
        newUser.setId(counter.incrementAndGet());
        users.add(newUser);
        
        return ResponseEntity.status(HttpStatus.CREATED)
            .body(new ApiResponse(true, "用戶創建成功", newUser));
    }
    
    // 更新用戶
    @PutMapping("/users/{id}")
    public ResponseEntity<ApiResponse> updateUser(
            @PathVariable Long id, 
            @RequestBody User updatedUser) {
        
        Optional<User> existingUser = users.stream()
            .filter(u -> u.getId().equals(id))
            .findFirst();
        
        if (existingUser.isPresent()) {
            User user = existingUser.get();
            user.setName(updatedUser.getName());
            user.setEmail(updatedUser.getEmail());
            
            return ResponseEntity.ok(
                new ApiResponse(true, "用戶更新成功", user)
            );
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body(new ApiResponse(false, "用戶不存在", null));
        }
    }
    
    // 刪除用戶
    @DeleteMapping("/users/{id}")
    public ResponseEntity<ApiResponse> deleteUser(@PathVariable Long id) {
        boolean removed = users.removeIf(u -> u.getId().equals(id));
        
        if (removed) {
            return ResponseEntity.ok(
                new ApiResponse(true, "用戶刪除成功", null)
            );
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body(new ApiResponse(false, "用戶不存在", null));
        }
    }
    
    // 全局異常處理
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse> handleException(Exception e) {
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(new ApiResponse(false, "伺服器內部錯誤: " + e.getMessage(), null));
    }
    
    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
}

// 用戶實體類
class User {
    private Long id;
    private String name;
    private String email;
    private LocalDateTime createdAt;
    
    public User() {
        this.createdAt = LocalDateTime.now();
    }
    
    public User(Long id, String name, String email) {
        this.id = id;
        this.name = name;
        this.email = email;
        this.createdAt = LocalDateTime.now();
    }
    
    // Getter 和 Setter 方法
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    
    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }
}

// API 回應格式
class ApiResponse {
    private boolean success;
    private String message;
    private Object data;
    private LocalDateTime timestamp;
    
    public ApiResponse(boolean success, String message, Object data) {
        this.success = success;
        this.message = message;
        this.data = data;
        this.timestamp = LocalDateTime.now();
    }
    
    // Getter 方法
    public boolean isSuccess() { return success; }
    public String getMessage() { return message; }
    public Object getData() { return data; }
    public LocalDateTime getTimestamp() { return timestamp; }
}

// 健康狀態類
class HealthStatus {
    private String status = "UP";
    private LocalDateTime timestamp = LocalDateTime.now();
    
    public String getStatus() { return status; }
    public LocalDateTime getTimestamp() { return timestamp; }
}`
            };
            
            if (snippets[template]) {
                editors.code.setValue(snippets[template]);
                showFlash('代碼片段已加載', 'success');
                logSystemEvent(`加載代碼片段: ${template}`, 'info');
            }
        }

        function clearConsole() {
            const logContainers = ['execution-log', 'request-log', 'error-log'];
            logContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = '';
                }
            });
            showFlash('控制台已清空', 'success');
            logSystemEvent('清空控制台', 'info');
        }

        function switchConsoleTab(tab) {
            document.querySelectorAll('.console-tab').forEach(t => {
                t.classList.remove('active');
            });
            document.querySelectorAll('.console-tab-content').forEach(c => {
                c.style.display = 'none';
            });
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-log`).style.display = 'block';
        }

        function addConsoleLog(message, level = 'info', data = null) {
            const container = document.getElementById('execution-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            
            let logMessage = message;
            if (data) {
                if (typeof data === 'object') {
                    logMessage += '\n' + JSON.stringify(data, null, 2);
                } else {
                    logMessage += '\n' + data;
                }
            }
            
            logEntry.innerHTML = `
                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                <div class="log-message">${logMessage}</div>
            `;
            container.appendChild(logEntry);
            
            // 自动滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        // ============================================
        // 多層次程式碼分析功能
        // ============================================
        function performCodeAnalysis(code, language) {
            document.getElementById('code-analysis-panel').style.display = 'block';
            
            // 語法正確性分析
            const syntaxAnalysis = analyzeSyntax(code, language);
            document.getElementById('syntax-analysis').textContent = syntaxAnalysis;
            
            // 邏輯正確性分析
            const logicAnalysis = analyzeLogic(code, language);
            document.getElementById('logic-analysis').textContent = logicAnalysis;
            
            // 效能影響分析
            const performanceAnalysis = analyzePerformance(code, language);
            document.getElementById('performance-analysis').textContent = performanceAnalysis;
            
            logSystemEvent('執行多層次程式碼分析', 'info');
        }

        function analyzeSyntax(code, language) {
            const errors = [];
            
            if (language === 'python') {
                // 檢查 Python 語法
                try {
                    // 簡單的語法檢查
                    if (code.includes('print ')) {
                        errors.push('使用 print() 而非 print');
                    }
                    
                    // 檢查縮進
                    const lines = code.split('\n');
                    let indentLevel = 0;
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        const leadingSpaces = line.match(/^ */)[0].length;
                        
                        if (line.trim().endsWith(':')) {
                            if (leadingSpaces !== indentLevel * 4) {
                                errors.push(`第 ${i+1} 行: 縮進不一致`);
                            }
                            indentLevel++;
                        }
                    }
                } catch (e) {
                    errors.push(`語法分析錯誤: ${e.message}`);
                }
            } else if (language === 'javascript') {
                // 檢查 JavaScript 語法
                try {
                    eval(`(${code})`);
                } catch (e) {
                    errors.push(`語法錯誤: ${e.message}`);
                }
            }
            
            return errors.length === 0 ? '✅ 語法正確' : `⚠️ 發現 ${errors.length} 個語法問題`;
        }

        function analyzeLogic(code, language) {
            const warnings = [];
            
            // 檢查常見邏輯問題
            if (code.includes('while(true)') || code.includes('while (true)')) {
                warnings.push('發現無限循環風險');
            }
            
            if (code.includes('setTimeout') && !code.includes('clearTimeout')) {
                warnings.push('未清理計時器可能導致記憶體泄漏');
            }
            
            if (code.includes('eval(')) {
                warnings.push('使用 eval() 有安全風險');
            }
            
            // 檢查空值處理
            if (!code.includes('null') && !code.includes('undefined') && 
                !code.includes('try') && !code.includes('catch')) {
                warnings.push('缺少空值和異常處理');
            }
            
            return warnings.length === 0 ? '✅ 邏輯正確' : `⚠️ ${warnings.join('; ')}`;
        }

        function analyzePerformance(code, language) {
            let complexity = '低';
            
            // 簡單的複雜度分析
            const lines = code.split('\n').length;
            const functionCount = (code.match(/function\s+\w+|def\s+\w+/g) || []).length;
            const loopCount = (code.match(/for\s*\(|while\s*\(|for\s+\w+\s+in/g) || []).length;
            
            if (lines > 100) complexity = '中';
            if (lines > 300) complexity = '高';
            if (functionCount > 10) complexity = '中';
            if (loopCount > 5) complexity = '高';
            
            // 檢查遞歸
            if (code.includes('function') && code.includes('function')) {
                complexity = '高';
            }
            
            return `複雜度: ${complexity} (${lines} 行, ${functionCount} 個函數, ${loopCount} 個循環)`;
        }

        // ============================================
        // 路由管理器功能（全面增強版）
        // ============================================
        function initRoutes() {
            routes = JSON.parse(localStorage.getItem('routes') || '[]');
            if (routes.length === 0) {
                routes = [
                    {
                        id: 1,
                        method: 'GET',
                        path: '/api/users',
                        handler: `(req, res) => {
  // 獲取所有用戶
  const users = [
    { id: 1, name: "張三", email: "zhangsan@example.com" },
    { id: 2, name: "李四", email: "lisi@example.com" }
  ];
  
  // 支持查詢參數
  const { active, limit } = req.query;
  let filteredUsers = users;
  
  if (active) {
    filteredUsers = filteredUsers.filter(u => u.active === (active === 'true'));
  }
  
  if (limit) {
    filteredUsers = filteredUsers.slice(0, parseInt(limit));
  }
  
  res.json({
    success: true,
    data: filteredUsers,
    count: filteredUsers.length,
    timestamp: new Date().toISOString()
  });
}`,
                        middlewares: ['log', 'auth'],
                        description: '獲取所有用戶',
                        requestFormat: {
                            query: {
                                active: 'boolean (可選) - 篩選活躍用戶',
                                limit: 'number (可選) - 限制返回數量'
                            }
                        },
                        responseFormat: {
                            success: true,
                            data: 'Array<User>',
                            count: 'number',
                            timestamp: 'string'
                        }
                    },
                    {
                        id: 2,
                        method: 'POST',
                        path: '/api/users',
                        handler: `(req, res) => {
  // 創建新用戶
  const user = req.body;
  
  // 驗證必填字段
  const requiredFields = ['name', 'email'];
  const missingFields = requiredFields.filter(field => !user[field]);
  
  if (missingFields.length > 0) {
    return res.status(400).json({
      success: false,
      error: '缺少必要字段',
      missingFields: missingFields
    });
  }
  
  // 生成新ID
  user.id = Date.now();
  user.createdAt = new Date().toISOString();
  
  // 模擬保存到數據庫
  // database.save(user);
  
  res.status(201).json({
    success: true,
    message: '用戶創建成功',
    data: user
  });
}`,
                        middlewares: ['log', 'auth', 'validate', 'rate-limit'],
                        description: '創建新用戶',
                        requestFormat: {
                            body: {
                                name: 'string (必填) - 用戶姓名',
                                email: 'string (必填) - 用戶郵箱',
                                age: 'number (可選) - 用戶年齡',
                                active: 'boolean (可選) - 是否活躍'
                            }
                        },
                        responseFormat: {
                            success: true,
                            message: 'string',
                            data: 'User'
                        }
                    },
                    {
                        id: 3,
                        method: 'GET',
                        path: '/api/users/:id',
                        handler: `(req, res) => {
  // 根據ID獲取用戶
  const userId = parseInt(req.params.id);
  
  if (isNaN(userId)) {
    return res.status(400).json({
      success: false,
      error: '無效的用戶ID'
    });
  }
  
  // 模擬從數據庫查詢
  const users = [
    { id: 1, name: "張三", email: "zhangsan@example.com" },
    { id: 2, name: "李四", email: "lisi@example.com" }
  ];
  
  const user = users.find(u => u.id === userId);
  
  if (!user) {
    return res.status(404).json({
      success: false,
      error: '用戶不存在'
    });
  }
  
  res.json({
    success: true,
    data: user
  });
}`,
                        middlewares: ['log', 'auth'],
                        description: '根據ID獲取用戶',
                        requestFormat: {
                            params: {
                                id: 'number - 用戶ID'
                            }
                        },
                        responseFormat: {
                            success: true,
                            data: 'User | null'
                        }
                    },
                    {
                        id: 4,
                        method: 'PUT',
                        path: '/api/users/:id',
                        handler: `(req, res) => {
  // 更新用戶
  const userId = parseInt(req.params.id);
  const updates = req.body;
  
  if (isNaN(userId)) {
    return res.status(400).json({
      success: false,
      error: '無效的用戶ID'
    });
  }
  
  // 模擬更新操作
  const user = { id: userId, ...updates };
  user.updatedAt = new Date().toISOString();
  
  res.json({
    success: true,
    message: '用戶更新成功',
    data: user
  });
}`,
                        middlewares: ['log', 'auth', 'validate'],
                        description: '更新用戶信息',
                        requestFormat: {
                            params: {
                                id: 'number - 用戶ID'
                            },
                            body: {
                                name: 'string (可選) - 用戶姓名',
                                email: 'string (可選) - 用戶郵箱',
                                age: 'number (可選) - 用戶年齡',
                                active: 'boolean (可選) - 是否活躍'
                            }
                        },
                        responseFormat: {
                            success: true,
                            message: 'string',
                            data: 'User'
                        }
                    }
                ];
                saveRoutes();
            }
            updateRoutesDisplay();
        }

        function addRoute() {
            const newId = routes.length > 0 ? Math.max(...routes.map(r => r.id)) + 1 : 1;
            const route = {
                id: newId,
                method: 'GET',
                path: '/api/new-route',
                handler: `(req, res) => {
  // 新路由處理函數
  res.json({
    success: true,
    message: "新路由",
    data: req.params
  });
}`,
                middlewares: [],
                description: '新路由',
                requestFormat: {},
                responseFormat: {
                    success: true,
                    message: 'string',
                    data: 'any'
                }
            };
            routes.push(route);
            updateRoutesDisplay();
            showFlash('新路由已添加', 'success');
            logSystemEvent('添加新路由', 'info');
        }

        function updateRoutesDisplay() {
            const container = document.getElementById('route-config-area');
            container.innerHTML = '';
            
            routes.forEach((route) => {
                const routeDiv = document.createElement('div');
                routeDiv.className = 'route-item';
                routeDiv.style.cssText = `
                    margin-bottom: 20px;
                    padding: 20px;
                    background: rgba(30, 41, 59, 0.8);
                    border-radius: 10px;
                    border-left: 4px solid var(--accent-blue);
                    border: 1px solid rgba(56, 189, 248, 0.3);
                `;
                
                const methodColor = {
                    'GET': 'method-get',
                    'POST': 'method-post',
                    'PUT': 'method-put',
                    'DELETE': 'method-delete',
                    'PATCH': 'method-get',
                    'OPTIONS': 'method-get'
                }[route.method] || 'method-get';
                
                routeDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; flex: 1;">
                            <select class="form-control" onchange="updateRoute(${route.id}, 'method', this.value)" style="min-width: 100px; max-width: 120px;">
                                <option value="GET" ${route.method === 'GET' ? 'selected' : ''}>GET</option>
                                <option value="POST" ${route.method === 'POST' ? 'selected' : ''}>POST</option>
                                <option value="PUT" ${route.method === 'PUT' ? 'selected' : ''}>PUT</option>
                                <option value="DELETE" ${route.method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                <option value="PATCH" ${route.method === 'PATCH' ? 'selected' : ''}>PATCH</option>
                                <option value="OPTIONS" ${route.method === 'OPTIONS' ? 'selected' : ''}>OPTIONS</option>
                            </select>
                            <div style="flex: 1; min-width: 200px;">
                                <input type="text" class="form-control" value="${route.path}" 
                                       onchange="updateRoute(${route.id}, 'path', this.value)" placeholder="路由路徑">
                                <small style="color: var(--text-gray); font-size: 0.8rem; margin-top: 5px; display: block;">
                                    使用 :param 定義動態參數，例如 /api/users/:id
                                </small>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-success" onclick="testSingleRoute(${route.id})" style="padding: 5px 10px;">
                                <i class="fas fa-vial"></i>
                            </button>
                            <button class="btn btn-warning" onclick="removeRoute(${route.id})" style="padding: 5px 10px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <input type="text" class="form-control" value="${route.description || ''}" 
                               onchange="updateRoute(${route.id}, 'description', this.value)" placeholder="路由描述">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="color: var(--accent-blue); font-weight: 600; margin-bottom: 5px; display: block;">
                            <i class="fas fa-code"></i> 處理函數
                        </label>
                        <textarea class="form-control" onchange="updateRoute(${route.id}, 'handler', this.value)" 
                                  rows="6" placeholder="處理函數" style="font-family: 'Fira Code', monospace; font-size: 0.9rem;">${route.handler}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="color: var(--accent-blue); font-weight: 600; margin-bottom: 5px; display: block;">
                            <i class="fas fa-cogs"></i> 中間件
                        </label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="color: var(--accent-blue); font-size: 0.9rem;">
                                <input type="checkbox" ${route.middlewares.includes('log') ? 'checked' : ''} 
                                       onchange="toggleMiddleware(${route.id}, 'log', this.checked)"> 
                                <span style="margin-left: 5px;">日誌</span>
                            </label>
                            <label style="color: var(--accent-blue); font-size: 0.9rem;">
                                <input type="checkbox" ${route.middlewares.includes('auth') ? 'checked' : ''} 
                                       onchange="toggleMiddleware(${route.id}, 'auth', this.checked)"> 
                                <span style="margin-left: 5px;">認證</span>
                            </label>
                            <label style="color: var(--accent-blue); font-size: 0.9rem;">
                                <input type="checkbox" ${route.middlewares.includes('validate') ? 'checked' : ''} 
                                       onchange="toggleMiddleware(${route.id}, 'validate', this.checked)"> 
                                <span style="margin-left: 5px;">驗證</span>
                            </label>
                            <label style="color: var(--accent-blue); font-size: 0.9rem;">
                                <input type="checkbox" ${route.middlewares.includes('cors') ? 'checked' : ''} 
                                       onchange="toggleMiddleware(${route.id}, 'cors', this.checked)"> 
                                <span style="margin-left: 5px;">CORS</span>
                            </label>
                            <label style="color: var(--accent-blue); font-size: 0.9rem;">
                                <input type="checkbox" ${route.middlewares.includes('rate-limit') ? 'checked' : ''} 
                                       onchange="toggleMiddleware(${route.id}, 'rate-limit', this.checked)"> 
                                <span style="margin-left: 5px;">限流</span>
                            </label>
                            <label style="color: var(--accent-blue); font-size: 0.9rem;">
                                <input type="checkbox" ${route.middlewares.includes('cache') ? 'checked' : ''} 
                                       onchange="toggleMiddleware(${route.id}, 'cache', this.checked)"> 
                                <span style="margin-left: 5px;">緩存</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>
                            <label style="color: var(--accent-green); font-weight: 600; margin-bottom: 5px; display: block;">
                                <i class="fas fa-sign-in-alt"></i> 請求格式
                            </label>
                            <textarea class="form-control" onchange="updateRoute(${route.id}, 'requestFormat', JSON.parse(this.value))" 
                                      rows="4" placeholder="請求格式 (JSON)" style="font-family: 'Fira Code', monospace; font-size: 0.9rem;">${JSON.stringify(route.requestFormat || {}, null, 2)}</textarea>
                        </div>
                        <div>
                            <label style="color: var(--accent-green); font-weight: 600; margin-bottom: 5px; display: block;">
                                <i class="fas fa-sign-out-alt"></i> 回應格式
                            </label>
                            <textarea class="form-control" onchange="updateRoute(${route.id}, 'responseFormat', JSON.parse(this.value))" 
                                      rows="4" placeholder="回應格式 (JSON)" style="font-family: 'Fira Code', monospace; font-size: 0.9rem;">${JSON.stringify(route.responseFormat || {}, null, 2)}</textarea>
                        </div>
                    </div>
                    
                    ${route.path.includes(':') ? `
                    <div class="route-param-editor" style="margin-top: 15px;">
                        <label style="color: var(--accent-purple); font-weight: 600; margin-bottom: 5px; display: block;">
                            <i class="fas fa-sliders-h"></i> 動態參數配置
                        </label>
                        <div id="params-${route.id}">
                            ${extractRouteParams(route.path).map(param => `
                                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                                    <input type="text" class="form-control" value="${param}" readonly style="flex: 1;">
                                    <input type="text" class="form-control" placeholder="測試值" id="param-${route.id}-${param}" style="flex: 2;">
                                    <select class="form-control" style="flex: 1;">
                                        <option value="string">字串</option>
                                        <option value="number">數字</option>
                                        <option value="boolean">布林值</option>
                                        <option value="uuid">UUID</option>
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
                container.appendChild(routeDiv);
            });
        }

        function extractRouteParams(path) {
            const paramRegex = /:(\w+)/g;
            const params = [];
            let match;
            while ((match = paramRegex.exec(path)) !== null) {
                params.push(match[1]);
            }
            return params;
        }

        function updateRoute(id, field, value) {
            const routeIndex = routes.findIndex(r => r.id === id);
            if (routeIndex !== -1) {
                // 特殊處理某些字段
                if (field === 'requestFormat' || field === 'responseFormat') {
                    try {
                        routes[routeIndex][field] = JSON.parse(value);
                    } catch (e) {
                        showFlash('JSON 格式錯誤', 'error');
                        return;
                    }
                } else {
                    routes[routeIndex][field] = value;
                }
                saveRoutes();
            }
        }

        function toggleMiddleware(id, middleware, checked) {
            const routeIndex = routes.findIndex(r => r.id === id);
            if (routeIndex === -1) return;
            
            if (checked) {
                if (!routes[routeIndex].middlewares.includes(middleware)) {
                    routes[routeIndex].middlewares.push(middleware);
                }
            } else {
                const idx = routes[routeIndex].middlewares.indexOf(middleware);
                if (idx > -1) {
                    routes[routeIndex].middlewares.splice(idx, 1);
                }
            }
            saveRoutes();
        }

        function removeRoute(id) {
            if (confirm('確定要刪除此路由嗎？')) {
                const routeIndex = routes.findIndex(r => r.id === id);
                if (routeIndex !== -1) {
                    const removed = routes.splice(routeIndex, 1);
                    updateRoutesDisplay();
                    saveRoutes();
                    showFlash('路由已刪除', 'success');
                    logSystemEvent(`刪除路由: ${removed[0].method} ${removed[0].path}`, 'info');
                }
            }
        }

        function saveRoutes() {
            localStorage.setItem('routes', JSON.stringify(routes));
            showFlash('路由配置已保存', 'success');
            logSystemEvent('保存路由配置', 'info');
        }

        function testRoute() {
            const method = document.getElementById('test-method').value;
            const url = document.getElementById('test-url').value;
            
            // 使用增强的路由匹配
            const matchResult = findMatchingRouteWithParams(method, url);
            
            const resultsDiv = document.getElementById('route-test-results');
            
            if (matchResult.matched) {
                const { route, params } = matchResult;
                
                // 执行中间件链
                const middlewareResults = executeMiddlewareChain(route, params, url);
                
                let testResult = '成功';
                let statusCode = 200;
                let responseBody = '';
                let errorMessage = '';
                
                // 检查中间件结果
                const failedMiddleware = middlewareResults.find(r => !r.passed);
                
                if (failedMiddleware) {
                    testResult = '失敗';
                    statusCode = failedMiddleware.statusCode;
                    errorMessage = failedMiddleware.message;
                } else {
                    // 模拟执行处理函数
                    try {
                        // 创建模拟的 req 和 res 对象
                        const mockReq = {
                            method: method,
                            url: url,
                            params: params,
                            query: extractQueryParams(url),
                            body: method === 'POST' || method === 'PUT' || method === 'PATCH' 
                                ? { name: '測試用戶', email: 'test@example.com' }
                                : {},
                            headers: {
                                'authorization': 'Bearer test-token',
                                'content-type': 'application/json'
                            }
                        };
                        
                        const mockRes = {
                            status: function(code) {
                                this.statusCode = code;
                                return this;
                            },
                            json: function(data) {
                                this.body = data;
                                return this;
                            }
                        };
                        
                        // 执行处理函数（简化版）
                        responseBody = '處理函數執行成功';
                        
                    } catch (error) {
                        testResult = '失敗';
                        statusCode = 500;
                        errorMessage = `處理函數錯誤: ${error.message}`;
                    }
                }
                
                resultsDiv.innerHTML = `
                    <div class="log-entry ${testResult === '成功' ? 'success' : 'error'}">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>路由測試${testResult}</strong><br>
                            方法: ${method}<br>
                            路徑: ${url}<br>
                            匹配路由: ${route.path}<br>
                            動態參數: ${JSON.stringify(params)}<br>
                            中間件: ${route.middlewares.join(', ')}<br>
                            狀態碼: ${statusCode}<br>
                            ${responseBody ? '回應: ' + responseBody : ''}<br>
                            ${errorMessage ? '錯誤: ' + errorMessage : ''}
                        </div>
                    </div>
                `;
                
                if (testResult === '成功') {
                    showFlash('路由測試成功', 'success');
                    logSystemEvent(`路由測試成功: ${method} ${url}`, 'success');
                } else {
                    showFlash(`路由測試失敗: ${errorMessage}`, 'error');
                    logSystemEvent(`路由測試失敗: ${method} ${url} - ${errorMessage}`, 'error');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>路由測試失敗</strong><br>
                            未找到匹配的路由: ${method} ${url}<br>
                            可用路由:<br>
                            ${routes.map(r => `• ${r.method} ${r.path}`).join('<br>')}
                        </div>
                    </div>
                `;
                
                showFlash('未找到匹配的路由', 'error');
                logSystemEvent(`路由測試失敗: ${method} ${url}`, 'error');
            }
            
            // 更新统计信息
            requestStats.total++;
            if (matchResult.matched) requestStats.success++;
            else requestStats.error++;
            updateStats();
        }

        function findMatchingRouteWithParams(method, path) {
            for (const route of routes) {
                if (route.method !== method) continue;
                
                // 构建正则表达式来匹配动态参数
                const pattern = route.path
                    .replace(/:\w+/g, '([^/]+)')
                    .replace(/\//g, '\\/');
                
                const regex = new RegExp(`^${pattern}$`);
                const match = path.match(regex);
                
                if (match) {
                    // 提取参数
                    const params = {};
                    const paramNames = extractRouteParams(route.path);
                    
                    paramNames.forEach((name, index) => {
                        params[name] = match[index + 1];
                    });
                    
                    return {
                        matched: true,
                        route: route,
                        params: params
                    };
                }
            }
            
            return { matched: false };
        }

        function extractQueryParams(url) {
            const query = {};
            const queryString = url.split('?')[1];
            
            if (queryString) {
                queryString.split('&').forEach(pair => {
                    const [key, value] = pair.split('=');
                    if (key) {
                        query[decodeURIComponent(key)] = decodeURIComponent(value || '');
                    }
                });
            }
            
            return query;
        }

        function executeMiddlewareChain(route, params, url) {
            const results = [];
            
            for (const middleware of route.middlewares) {
                const result = executeMiddleware(middleware, params, url);
                results.push(result);
                
                if (!result.passed) {
                    break;
                }
            }
            
            return results;
        }

        function executeMiddleware(middleware, params, url) {
            switch (middleware) {
                case 'auth':
                    // 检查认证
                    const token = localStorage.getItem('auth-token');
                    if (!token) {
                        return {
                            passed: false,
                            statusCode: 401,
                            message: '未通過認證：缺少有效的認證Token'
                        };
                    }
                    return { passed: true, message: '通過認證' };
                    
                case 'validate':
                    // 验证请求数据
                    if (url.includes('/api/users') && params.id) {
                        const id = parseInt(params.id);
                        if (isNaN(id) || id <= 0) {
                            return {
                                passed: false,
                                statusCode: 422,
                                message: '驗證失敗：無效的用戶ID'
                            };
                        }
                    }
                    return { passed: true, message: '通過驗證' };
                    
                case 'rate-limit':
                    // 模拟限流检查
                    const shouldRateLimit = Math.random() < 0.1; // 10% 概率触发限流
                    if (shouldRateLimit) {
                        return {
                            passed: false,
                            statusCode: 429,
                            message: '請求過於頻繁，請稍後再試'
                        };
                    }
                    return { passed: true, message: '通過限流檢查' };
                    
                case 'cache':
                    // 模拟缓存检查
                    const cachedResponse = localStorage.getItem(`cache_${url}`);
                    if (cachedResponse) {
                        return {
                            passed: true,
                            message: '使用緩存數據',
                            cached: true
                        };
                    }
                    return { passed: true, message: '未命中緩存' };
                    
                default:
                    return { passed: true, message: `中間件 ${middleware} 執行成功` };
            }
        }

        function testSingleRoute(routeId) {
            const route = routes.find(r => r.id === routeId);
            if (!route) return;
            
            // 构建测试URL
            let testUrl = route.path;
            const params = extractRouteParams(route.path);
            
            // 替换参数为测试值
            params.forEach(param => {
                const testValue = document.getElementById(`param-${routeId}-${param}`)?.value || '123';
                testUrl = testUrl.replace(`:${param}`, testValue);
            });
            
            // 设置测试参数并执行测试
            document.getElementById('test-method').value = route.method;
            document.getElementById('test-url').value = testUrl;
            testRoute();
        }

        function testAllRoutes() {
            const resultsDiv = document.getElementById('route-test-results');
            resultsDiv.innerHTML = '<div class="log-entry info">開始測試所有路由...</div>';
            
            let passed = 0;
            let failed = 0;
            const testPromises = [];
            
            // 测试用户定义的所有路由
            routes.forEach((route, index) => {
                const testPromise = new Promise(resolve => {
                    setTimeout(() => {
                        // 为每个路由生成测试URL
                        let testUrl = route.path;
                        
                        // 替换动态参数
                        const params = extractRouteParams(route.path);
                        params.forEach(param => {
                            testUrl = testUrl.replace(`:${param}`, '123');
                        });
                        
                        const matchResult = findMatchingRouteWithParams(route.method, testUrl);
                        
                        if (matchResult.matched) {
                            passed++;
                            resultsDiv.innerHTML += `
                                <div class="log-entry success">
                                    <div class="log-message">✓ ${route.method} ${testUrl} - 成功</div>
                                </div>
                            `;
                        } else {
                            failed++;
                            resultsDiv.innerHTML += `
                                <div class="log-entry error">
                                    <div class="log-message">✗ ${route.method} ${testUrl} - 失敗</div>
                                </div>
                            `;
                        }
                        
                        resolve();
                        
                        if (index === routes.length - 1) {
                            resultsDiv.innerHTML += `
                                <div class="log-entry ${passed === routes.length ? 'success' : 'warning'}">
                                    <div class="log-message">
                                        <strong>測試完成</strong><br>
                                        通過: ${passed}/${routes.length}<br>
                                        失敗: ${failed}/${routes.length}<br>
                                        成功率: ${((passed / routes.length) * 100).toFixed(1)}%
                                    </div>
                                </div>
                            `;
                            
                            showFlash(`路由測試完成: ${passed}/${routes.length} 通過`, 
                                     passed === routes.length ? 'success' : 'warning');
                            logSystemEvent(`路由測試完成: ${passed}/${routes.length} 通過`, 
                                         passed === routes.length ? 'success' : 'warning');
                        }
                    }, index * 500);
                });
                
                testPromises.push(testPromise);
            });
            
            return Promise.all(testPromises);
        }

        function toggleMiddlewareDebug() {
            const panel = document.getElementById('middleware-debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            
            if (panel.style.display === 'block') {
                updateMiddlewareDebugInfo();
            }
        }

        function updateMiddlewareDebugInfo() {
            const contentDiv = document.getElementById('middleware-debug-content');
            contentDiv.innerHTML = '';
            
            routes.forEach(route => {
                const routeDiv = document.createElement('div');
                routeDiv.style.cssText = `
                    margin-bottom: 15px;
                    padding: 15px;
                    background: rgba(30, 41, 59, 0.8);
                    border-radius: 8px;
                    border-left: 4px solid var(--accent-purple);
                `;
                
                routeDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--accent-blue);">${route.method} ${route.path}</strong>
                    </div>
                    <div>
                        <strong>中間件鏈:</strong> ${route.middlewares.join(' → ') || '無'}<br>
                        <strong>執行順序:</strong><br>
                        ${route.middlewares.map((mw, idx) => `
                            <div style="margin-left: 20px; margin-top: 5px;">
                                ${idx + 1}. ${mw} - ${getMiddlewareDescription(mw)}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                contentDiv.appendChild(routeDiv);
            });
        }

        function getMiddlewareDescription(middleware) {
            const descriptions = {
                'log': '記錄請求日誌',
                'auth': '驗證用戶身份',
                'validate': '驗證請求數據',
                'cors': '處理跨域請求',
                'rate-limit': '限流控制',
                'cache': '緩存處理'
            };
            
            return descriptions[middleware] || '自定義中間件';
        }

        function generateAPIDocs() {
            const docsDiv = document.getElementById('api-docs');
            const contentDiv = document.getElementById('api-docs-content');
            
            contentDiv.innerHTML = `
                <h3 style="color: var(--accent-green); margin-bottom: 20px;">API 文檔</h3>
                <p style="margin-bottom: 20px; color: var(--text-gray);">
                    自動根據路由配置生成的 API 文檔，包含請求/回應格式示例。
                </p>
            `;
            
            routes.forEach(route => {
                const methodColor = {
                    'GET': 'method-get',
                    'POST': 'method-post',
                    'PUT': 'method-put',
                    'DELETE': 'method-delete',
                    'PATCH': 'method-get',
                    'OPTIONS': 'method-get'
                }[route.method];
                
                const params = extractRouteParams(route.path);
                
                contentDiv.innerHTML += `
                    <div class="endpoint">
                        <div class="endpoint-header">
                            <span class="method-badge ${methodColor}">${route.method}</span>
                            <span class="endpoint-path">${route.path}</span>
                            ${route.middlewares.length > 0 ? `
                                <span style="color: var(--text-gray); font-size: 0.9rem;">
                                    <i class="fas fa-cogs"></i> ${route.middlewares.join(', ')}
                                </span>
                            ` : ''}
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <strong>描述:</strong> ${route.description || '無'}<br>
                            
                            ${params.length > 0 ? `
                                <strong>路徑參數:</strong><br>
                                <div style="margin-left: 20px; margin-top: 5px;">
                                    ${params.map(p => `• ${p} (string)`).join('<br>')}
                                </div>
                            ` : ''}
                            
                            ${Object.keys(route.requestFormat || {}).length > 0 ? `
                                <strong>請求格式:</strong>
                                <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 5px; overflow: auto; font-size: 0.9rem;">
${JSON.stringify(route.requestFormat, null, 2)}
                                </pre>
                            ` : ''}
                            
                            ${Object.keys(route.responseFormat || {}).length > 0 ? `
                                <strong>回應格式:</strong>
                                <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 5px; overflow: auto; font-size: 0.9rem;">
${JSON.stringify(route.responseFormat, null, 2)}
                                </pre>
                            ` : ''}
                            
                            <strong>處理函數:</strong>
                            <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 5px; overflow: auto; font-size: 0.9rem;">
${route.handler}
                            </pre>
                        </div>
                    </div>
                `;
            });
            
            docsDiv.style.display = 'block';
            showFlash('API 文檔已生成', 'success');
            logSystemEvent('生成 API 文檔', 'info');
        }

        // ============================================
        // HTTP模拟器功能（全面增強版）
        // ============================================
        function sendHttpRequest() {
            const method = document.getElementById('http-method').value;
            const version = document.getElementById('http-version').value;
            const url = document.getElementById('http-url').value;
            const body = document.getElementById('http-body').value;
            
            const startTime = Date.now();
            
            // 模拟网络延迟
            const delay = parseInt(document.getElementById('network-delay').value) || 0;
            const packetLoss = parseInt(document.getElementById('packet-loss').value) || 0;
            
            logSystemEvent(`發送 HTTP 請求: ${method} ${url} (${version})`, 'info');
            showFlash('請求發送中...', 'info');
            
            // 显示加载状态
            const sendBtn = document.querySelector('.btn[onclick="sendHttpRequest()"]');
            const originalHtml = sendBtn.innerHTML;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 發送中...';
            sendBtn.disabled = true;
            
            // 检查请求体格式
            if (method !== 'GET' && method !== 'DELETE' && method !== 'OPTIONS') {
                try {
                    if (body.trim()) {
                        JSON.parse(body);
                    }
                } catch (error) {
                    const latency = Date.now() - startTime;
                    const resultDiv = document.getElementById('http-result');
                    resultDiv.innerHTML += `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>請求失敗: 415 Unsupported Media Type</strong><br>
                                方法: ${method}<br>
                                URL: ${url}<br>
                                協議: HTTP/${version}<br>
                                錯誤: 請求體必須是有效的 JSON 格式<br>
                                錯誤詳情: ${error.message}
                            </div>
                        </div>
                    `;
                    
                    // 恢复按钮状态
                    sendBtn.innerHTML = originalHtml;
                    sendBtn.disabled = false;
                    
                    showFlash('請求體必須是有效的 JSON 格式', 'error');
                    logSystemEvent(`HTTP 請求失敗: 無效的 JSON 格式`, 'error');
                    
                    requestStats.error++;
                    requestStats.total++;
                    requestStats.latency.push(latency);
                    updateStats();
                    return;
                }
            }
            
            // 模拟网络延迟
            setTimeout(() => {
                // 模拟丢包
                if (Math.random() * 100 < packetLoss) {
                    const latency = Date.now() - startTime;
                    const resultDiv = document.getElementById('http-result');
                    resultDiv.innerHTML += `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>請求失敗: 網絡丟包</strong><br>
                                方法: ${method}<br>
                                URL: ${url}<br>
                                協議: HTTP/${version}<br>
                                延遲: ${latency}ms<br>
                                丟包率: ${packetLoss}%<br>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-secondary" onclick="retryHttpRequest()" style="margin-right: 10px;">
                                        <i class="fas fa-redo"></i> 重試請求
                                    </button>
                                    <button class="btn" onclick="analyzeNetworkIssue()">
                                        <i class="fas fa-search"></i> 分析網絡問題
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 恢复按钮状态
                    sendBtn.innerHTML = originalHtml;
                    sendBtn.disabled = false;
                    
                    showFlash('請求失敗: 網絡丟包', 'error');
                    logSystemEvent(`HTTP 請求失敗: 網絡丟包`, 'error');
                    
                    requestStats.error++;
                    requestStats.total++;
                    requestStats.latency.push(latency);
                    updateStats();
                    
                    // 更新网络可视化
                    updateNetworkVisualization('error');
                    return;
                }
                
                // HTTP/2 特性模拟
                if (version === '2') {
                    simulateHTTP2Features(method, url);
                }
                
                // WebSocket 模拟
                if (version === 'websocket') {
                    simulateWebSocket();
                    return;
                }
                
                // 查找匹配的路由
                const matchResult = findMatchingRouteWithParams(method, url);
                
                const latency = Date.now() - startTime;
                const resultDiv = document.getElementById('http-result');
                
                if (matchResult.matched) {
                    const { route, params } = matchResult;
                    
                    // 执行中间件链
                    const middlewareResults = executeMiddlewareChain(route, params, url);
                    
                    // 检查是否有失败的中间件
                    const failedMiddleware = middlewareResults.find(r => !r.passed);
                    
                    if (failedMiddleware) {
                        resultDiv.innerHTML += `
                            <div class="log-entry error">
                                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                                <div class="log-message">
                                    <strong>請求失敗: ${failedMiddleware.statusCode}</strong><br>
                                    方法: ${method}<br>
                                    URL: ${url}<br>
                                    協議: HTTP/${version}<br>
                                    狀態碼: ${failedMiddleware.statusCode}<br>
                                    錯誤: ${failedMiddleware.message}<br>
                                    中間件鏈: ${route.middlewares.join(' → ')}<br>
                                    延遲: ${latency}ms<br>
                                    ${params && Object.keys(params).length > 0 ? 
                                        `參數: ${JSON.stringify(params)}<br>` : ''}
                                </div>
                            </div>
                        `;
                        
                        showFlash(`請求失敗: ${failedMiddleware.message}`, 'error');
                        logSystemEvent(`HTTP 請求失敗: ${failedMiddleware.statusCode} ${failedMiddleware.message}`, 'error');
                        
                        requestStats.error++;
                        requestStats.total++;
                        requestStats.latency.push(latency);
                    } else {
                        let responseBody;
                        try {
                            responseBody = body.trim() ? JSON.parse(body) : {};
                        } catch {
                            responseBody = { error: '無效的 JSON 格式' };
                        }
                        
                        // 添加模擬數據
                        if (method === 'GET' && url.includes('/api/users')) {
                            responseBody = {
                                success: true,
                                data: [
                                    { id: 1, name: '張三', email: 'zhangsan@example.com' },
                                    { id: 2, name: '李四', email: 'lisi@example.com' }
                                ],
                                count: 2,
                                timestamp: new Date().toISOString()
                            };
                        }
                        
                        // 檢查是否使用緩存
                        const cachedResponse = middlewareResults.find(r => r.cached);
                        const cacheInfo = cachedResponse ? ' (使用緩存)' : '';
                        
                        resultDiv.innerHTML += `
                            <div class="log-entry success">
                                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                                <div class="log-message">
                                    <strong>請求成功: 200 OK${cacheInfo}</strong><br>
                                    方法: ${method}<br>
                                    URL: ${url}<br>
                                    協議: HTTP/${version}<br>
                                    狀態碼: 200<br>
                                    延遲: ${latency}ms<br>
                                    中間件鏈: ${route.middlewares.join(' → ')}<br>
                                    ${params && Object.keys(params).length > 0 ? 
                                        `參數: ${JSON.stringify(params)}<br>` : ''}
                                    回應體: <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 5px; overflow: auto;">${JSON.stringify(responseBody, null, 2)}</pre>
                                </div>
                            </div>
                        `;
                        
                        showFlash(`請求成功${cacheInfo}`, 'success');
                        logSystemEvent(`HTTP 請求成功: ${method} ${url}`, 'success');
                        
                        requestStats.success++;
                        requestStats.total++;
                        requestStats.latency.push(latency);
                    }
                } else {
                    resultDiv.innerHTML += `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>請求失敗: 404 Not Found</strong><br>
                                方法: ${method}<br>
                                URL: ${url}<br>
                                協議: HTTP/${version}<br>
                                狀態碼: 404<br>
                                延遲: ${latency}ms<br>
                                錯誤: 未找到匹配的路由<br>
                                建議:<br>
                                • 檢查 URL 是否正確<br>
                                • 確認路由是否已註冊<br>
                                • 檢查 HTTP 方法是否匹配
                            </div>
                        </div>
                    `;
                    
                    showFlash('請求失敗: 404 Not Found', 'error');
                    logSystemEvent(`HTTP 請求失敗: 404 Not Found`, 'error');
                    
                    requestStats.error++;
                    requestStats.total++;
                    requestStats.latency.push(latency);
                }
                
                // 恢复按钮状态
                sendBtn.innerHTML = originalHtml;
                sendBtn.disabled = false;
                
                updateStats();
                
                // 更新网络可视化
                updateNetworkVisualization('success');
                
                // 更新数据流追踪
                updateDataflowTrace(method, url, latency);
                
            }, delay);
        }

        function simulateHTTP2Features(method, url) {
            const multiplexing = document.getElementById('http2-multiplexing').checked;
            const serverPush = document.getElementById('http2-push').checked;
            const priority = document.getElementById('http2-priority').checked;
            
            const http2Log = document.getElementById('http-result');
            
            if (multiplexing) {
                http2Log.innerHTML += `
                    <div class="log-entry info">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>HTTP/2 多路複用</strong><br>
                            在同一個 TCP 連接上併發傳輸多個請求/回應流
                        </div>
                    </div>
                `;
            }
            
            if (serverPush) {
                http2Log.innerHTML += `
                    <div class="log-entry info">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>HTTP/2 伺服器推送</strong><br>
                            伺服器主動推送相關資源到客戶端緩存
                        </div>
                    </div>
                `;
            }
            
            if (priority) {
                http2Log.innerHTML += `
                    <div class="log-entry info">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>HTTP/2 流優先級</strong><br>
                            為不同的流設置優先級，優化資源加載順序
                        </div>
                    </div>
                `;
            }
        }

        function simulateWebSocket() {
            const wsLog = document.getElementById('http-result');
            
            if (!websocketConnection) {
                wsLog.innerHTML += `
                    <div class="log-entry info">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>WebSocket 連接建立</strong><br>
                            握手協議: HTTP/1.1 → WebSocket<br>
                            狀態: 連接成功<br>
                            連接ID: ws-${Date.now()}
                        </div>
                    </div>
                `;
                
                websocketConnection = {
                    id: `ws-${Date.now()}`,
                    connected: true,
                    messages: []
                };
                
                showFlash('WebSocket 連接已建立', 'success');
                logSystemEvent('WebSocket 連接建立', 'info');
            } else {
                wsLog.innerHTML += `
                    <div class="log-entry warning">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>WebSocket 連接已存在</strong><br>
                            連接ID: ${websocketConnection.id}<br>
                            已發送消息: ${websocketConnection.messages.length}
                        </div>
                    </div>
                `;
            }
        }

        function connectWebSocket() {
            simulateWebSocket();
        }

        function disconnectWebSocket() {
            if (websocketConnection) {
                const wsLog = document.getElementById('http-result');
                wsLog.innerHTML += `
                    <div class="log-entry info">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>WebSocket 連接關閉</strong><br>
                            連接ID: ${websocketConnection.id}<br>
                            狀態碼: 1000 (正常關閉)<br>
                            持續時間: ${Math.floor(Math.random() * 30) + 1}秒<br>
                            總消息數: ${websocketConnection.messages.length}
                        </div>
                    </div>
                `;
                
                showFlash('WebSocket 連接已關閉', 'info');
                logSystemEvent('WebSocket 連接關閉', 'info');
                
                websocketConnection = null;
            }
        }

        function sendWebSocketMessage() {
            const message = document.getElementById('ws-message').value;
            
            if (!websocketConnection) {
                showFlash('請先建立 WebSocket 連接', 'warning');
                return;
            }
            
            if (!message.trim()) {
                showFlash('請輸入要發送的消息', 'warning');
                return;
            }
            
            const wsLog = document.getElementById('http-result');
            wsLog.innerHTML += `
                <div class="log-entry success">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>WebSocket 消息發送</strong><br>
                        連接ID: ${websocketConnection.id}<br>
                        消息類型: text<br>
                        內容: ${message}<br>
                        消息大小: ${new Blob([message]).size} 字節
                    </div>
                </div>
            `;
            
            // 模擬伺服器回應
            setTimeout(() => {
                const response = `伺服器收到: ${message}`;
                wsLog.innerHTML += `
                    <div class="log-entry info">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>WebSocket 伺服器回應</strong><br>
                            連接ID: ${websocketConnection.id}<br>
                            消息類型: text<br>
                            內容: ${response}<br>
                            延遲: 100ms
                        </div>
                    </div>
                `;
                
                websocketConnection.messages.push({
                    type: 'text',
                    content: message,
                    timestamp: Date.now(),
                    direction: 'outgoing'
                });
                
                websocketConnection.messages.push({
                    type: 'text',
                    content: response,
                    timestamp: Date.now() + 100,
                    direction: 'incoming'
                });
                
                document.getElementById('ws-message').value = '';
                
            }, 100);
            
            showFlash('WebSocket 消息已發送', 'success');
            logSystemEvent('發送 WebSocket 消息', 'info');
        }

        function retryHttpRequest() {
            sendHttpRequest();
        }

        function analyzeNetworkIssue() {
            const analysis = `
                <div class="log-entry warning">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>網絡問題分析</strong><br>
                        可能原因:<br>
                        1. 網絡連接不穩定<br>
                        2. 伺服器負載過高<br>
                        3. 防火牆或代理設置問題<br>
                        4. DNS 解析失敗<br>
                        <br>
                        建議解決方案:<br>
                        1. 檢查網絡連接<br>
                        2. 降低請求頻率<br>
                        3. 增加超時時間設置<br>
                        4. 使用重試機制<br>
                        5. 監控網絡質量
                    </div>
                </div>
            `;
            
            document.getElementById('http-result').innerHTML += analysis;
            showFlash('網絡問題分析已生成', 'info');
        }

        function addHeader() {
            const headersDiv = document.getElementById('http-headers');
            const headerCount = headersDiv.children.length;
            
            // 避免添加太多請求頭
            if (headerCount >= 10) {
                showFlash('最多只能添加10個請求頭', 'warning');
                return;
            }
            
            const headerHtml = `
                <div class="input-group" style="margin-bottom: 5px;">
                    <input type="text" class="form-control" placeholder="Header 名稱" value="X-Custom-Header">
                    <input type="text" class="form-control" placeholder="Header 值" value="custom-value">
                    <button class="btn btn-warning" onclick="removeHeader(this)" style="padding: 5px 10px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            headersDiv.insertAdjacentHTML('beforeend', headerHtml);
            
            logSystemEvent('添加 HTTP 請求頭', 'info');
        }

        function removeHeader(button) {
            button.parentElement.remove();
            logSystemEvent('移除 HTTP 請求頭', 'info');
        }

        function removeParam(button) {
            button.parentElement.remove();
        }

        function simulateNetwork() {
            const delay = document.getElementById('network-delay').value;
            const packetLoss = document.getElementById('packet-loss').value;
            
            showFlash(`網絡模擬設置: 延遲 ${delay}ms, 丟包率 ${packetLoss}%`, 'info');
            logSystemEvent(`設置網絡模擬: 延遲 ${delay}ms, 丟包率 ${packetLoss}%`, 'info');
        }

        function clearHttpLog() {
            document.getElementById('http-result').innerHTML = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">HTTP 日誌已清空</div>
                </div>
            `;
            showFlash('HTTP 日誌已清空', 'success');
            logSystemEvent('清空 HTTP 日誌', 'info');
        }

        function updateNetworkVisualization(status = 'info') {
            const nodes = document.querySelectorAll('.network-node');
            const visualization = document.getElementById('network-visualization');
            
            visualization.style.display = 'grid';
            
            nodes.forEach((node, index) => {
                setTimeout(() => {
                    node.classList.add('active');
                    
                    // 根據狀態設置顏色
                    if (status === 'error') {
                        node.style.borderColor = 'var(--accent-red)';
                        node.style.background = 'rgba(239, 68, 68, 0.1)';
                    } else if (status === 'success') {
                        node.style.borderColor = 'var(--accent-green)';
                        node.style.background = 'rgba(16, 185, 129, 0.1)';
                    }
                    
                    setTimeout(() => {
                        node.classList.remove('active');
                        node.style.borderColor = '';
                        node.style.background = '';
                    }, 1000);
                }, index * 300);
            });
        }

        function updateDataflowTrace(method, url, latency) {
            const contentDiv = document.getElementById('dataflow-content');
            const traceId = `trace-${Date.now()}`;
            
            const traceEntry = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>數據流追蹤 [${traceId}]</strong><br>
                        請求: ${method} ${url}<br>
                        延遲: ${latency}ms<br>
                        追蹤路徑:<br>
                        1. 客戶端發起請求<br>
                        2. DNS 解析<br>
                        3. TCP 握手<br>
                        4. TLS 握手 (HTTPS)<br>
                        5. 請求發送到伺服器<br>
                        6. 伺服器處理請求<br>
                        7. 中間件執行<br>
                        8. 生成回應<br>
                        9. 回應返回客戶端<br>
                        10. 客戶端接收回應
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = traceEntry + contentDiv.innerHTML;
            
            // 限制追蹤條目數量
            const entries = contentDiv.querySelectorAll('.log-entry');
            if (entries.length > 5) {
                entries[entries.length - 1].remove();
            }
        }

        // ============================================
        // 数据库模拟器功能（全面增強版）
        // ============================================
        function executeQuery() {
            const query = document.getElementById('db-query').value;
            const dbType = document.getElementById('db-type').value;
            
            logSystemEvent(`執行數據庫查詢: ${dbType}`, 'info');
            showFlash('查詢執行中...', 'info');
            
            // 显示加载状态
            const executeBtn = document.querySelector('.btn[onclick="executeQuery()"]');
            const originalHtml = executeBtn.innerHTML;
            executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 執行中...';
            executeBtn.disabled = true;
            
            setTimeout(() => {
                let result;
                const startTime = Date.now();
                
                try {
                    if (dbType === 'mysql') {
                        result = executeEnhancedMySQLQuery(query);
                    } else {
                        result = executeEnhancedMongoDBQuery(query);
                    }
                    
                    const executionTime = Date.now() - startTime;
                    
                    const resultDiv = document.getElementById('db-result');
                    if (result.success) {
                        resultDiv.innerHTML = `
                            <div class="log-entry success">
                                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                                <div class="log-message">
                                    <strong>查詢執行成功</strong><br>
                                    數據庫類型: ${dbType}<br>
                                    查詢: <pre style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 3px; margin: 5px 0;">${query}</pre>
                                    結果: <pre style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 3px; margin: 5px 0;">${JSON.stringify(result.data, null, 2)}</pre>
                                    受影響行數: ${result.affectedRows || 0}<br>
                                    執行時間: ${executionTime}ms<br>
                                    ${result.warnings ? `警告: ${result.warnings.join(', ')}` : ''}
                                </div>
                            </div>
                        `;
                        
                        showFlash('查詢執行成功', 'success');
                        logSystemEvent('數據庫查詢成功', 'success');
                        
                        // 執行查詢分析
                        analyzeQueryPerformance(query, dbType, executionTime);
                    } else {
                        resultDiv.innerHTML = `
                            <div class="log-entry error">
                                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                                <div class="log-message">
                                    <strong>查詢執行失敗</strong><br>
                                    數據庫類型: ${dbType}<br>
                                    查詢: <pre style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 3px; margin: 5px 0;">${query}</pre>
                                    錯誤: ${result.error}<br>
                                    錯誤類型: ${result.errorType || '語法錯誤'}<br>
                                    執行時間: ${executionTime}ms
                                </div>
                            </div>
                        `;
                        
                        showFlash('查詢執行失敗', 'error');
                        logSystemEvent('數據庫查詢失敗', 'error');
                    }
                } catch (error) {
                    const resultDiv = document.getElementById('db-result');
                    resultDiv.innerHTML = `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>查詢執行異常</strong><br>
                                錯誤: ${error.message}<br>
                                堆疊: ${error.stack}
                            </div>
                        </div>
                    `;
                    
                    showFlash('查詢執行異常', 'error');
                    logSystemEvent(`數據庫查詢異常: ${error.message}`, 'error');
                } finally {
                    // 恢复按钮状态
                    executeBtn.innerHTML = originalHtml;
                    executeBtn.disabled = false;
                }
            }, 1000);
        }

        function executeEnhancedMySQLQuery(query) {
            const queryLower = query.toLowerCase().trim();
            
            try {
                // SELECT 查詢
                if (queryLower.startsWith('select')) {
                    return executeSelectQuery(query, queryLower);
                }
                
                // INSERT 查詢
                if (queryLower.startsWith('insert')) {
                    return executeInsertQuery(query, queryLower);
                }
                
                // UPDATE 查詢
                if (queryLower.startsWith('update')) {
                    return executeUpdateQuery(query, queryLower);
                }
                
                // DELETE 查詢
                if (queryLower.startsWith('delete')) {
                    return executeDeleteQuery(query, queryLower);
                }
                
                // CREATE TABLE
                if (queryLower.startsWith('create table')) {
                    return executeCreateTableQuery(query, queryLower);
                }
                
                // ALTER TABLE
                if (queryLower.startsWith('alter table')) {
                    return executeAlterTableQuery(query, queryLower);
                }
                
                // DROP TABLE
                if (queryLower.startsWith('drop table')) {
                    return executeDropTableQuery(query, queryLower);
                }
                
                // JOIN 查詢
                if (queryLower.includes(' join ')) {
                    return executeJoinQuery(query, queryLower);
                }
                
                // 子查詢
                if (queryLower.includes('select') && queryLower.includes('(select')) {
                    return executeSubquery(query, queryLower);
                }
                
                return {
                    success: false,
                    error: '不支持的 SQL 語句或語法錯誤',
                    errorType: '語法錯誤'
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: `查詢執行錯誤: ${error.message}`,
                    errorType: '執行錯誤'
                };
            }
        }

        function executeSelectQuery(query, queryLower) {
            // 解析 FROM 子句
            const fromMatch = queryLower.match(/from\s+(\w+)/);
            if (!fromMatch) {
                return {
                    success: false,
                    error: '缺少 FROM 子句',
                    errorType: '語法錯誤'
                };
            }
            
            const tableName = fromMatch[1];
            let data = databaseData.mysql[tableName] || [];
            
            // 檢查表是否存在
            if (!databaseData.mysql[tableName]) {
                return {
                    success: false,
                    error: `表 '${tableName}' 不存在`,
                    errorType: '表不存在'
                };
            }
            
            // 解析 WHERE 子句
            if (queryLower.includes('where')) {
                const whereClause = query.substring(queryLower.indexOf('where') + 5).trim();
                data = applyWhereClause(data, whereClause);
            }
            
            // 解析 ORDER BY 子句
            if (queryLower.includes('order by')) {
                const orderByMatch = query.match(/order by\s+(\w+)(?:\s+(asc|desc))?/i);
                if (orderByMatch) {
                    const field = orderByMatch[1];
                    const direction = (orderByMatch[2] || 'asc').toLowerCase();
                    
                    data.sort((a, b) => {
                        if (a[field] < b[field]) return direction === 'asc' ? -1 : 1;
                        if (a[field] > b[field]) return direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
            }
            
            // 解析 LIMIT 子句
            if (queryLower.includes('limit')) {
                const limitMatch = query.match(/limit\s+(\d+)(?:\s*,\s*(\d+))?/i);
                if (limitMatch) {
                    const limit = parseInt(limitMatch[1]);
                    const offset = limitMatch[2] ? parseInt(limitMatch[2]) : 0;
                    
                    if (limitMatch[2]) {
                        // LIMIT offset, count 語法
                        data = data.slice(offset, offset + limit);
                    } else {
                        // LIMIT count 語法
                        data = data.slice(0, limit);
                    }
                }
            }
            
            // 解析 SELECT 字段
            const selectMatch = query.match(/select\s+(.+?)\s+from/i);
            if (selectMatch) {
                const selectFields = selectMatch[1].trim();
                
                if (selectFields !== '*') {
                    const fields = selectFields.split(',').map(f => f.trim());
                    data = data.map(row => {
                        const newRow = {};
                        fields.forEach(field => {
                            if (row[field] !== undefined) {
                                newRow[field] = row[field];
                            }
                        });
                        return newRow;
                    });
                }
            }
            
            return {
                success: true,
                data: data,
                affectedRows: 0,
                warnings: data.length === 0 ? ['查詢返回空結果'] : []
            };
        }

        function applyWhereClause(data, whereClause) {
            // 簡單的 WHERE 條件解析
            const conditions = [];
            
            // 處理 AND 條件
            const andParts = whereClause.split(' and ');
            andParts.forEach(part => {
                // 處理 OR 條件
                const orParts = part.split(' or ');
                orParts.forEach(orPart => {
                    orPart = orPart.trim();
                    
                    // 處理比較運算符
                    const operators = ['=', '!=', '<', '>', '<=', '>=', 'like', 'in'];
                    let operatorFound = null;
                    
                    for (const op of operators) {
                        if (orPart.includes(` ${op} `)) {
                            operatorFound = op;
                            break;
                        }
                    }
                    
                    if (operatorFound) {
                        const [field, valuePart] = orPart.split(` ${operatorFound} `);
                        const fieldName = field.trim();
                        let value = valuePart.trim();
                        
                        // 移除引號
                        if (value.startsWith("'") && value.endsWith("'")) {
                            value = value.slice(1, -1);
                        }
                        
                        conditions.push({
                            field: fieldName,
                            operator: operatorFound,
                            value: value
                        });
                    }
                });
            });
            
            // 應用條件過濾
            return data.filter(row => {
                return conditions.every(condition => {
                    const rowValue = row[condition.field];
                    const conditionValue = condition.value;
                    
                    switch (condition.operator) {
                        case '=':
                            return rowValue == conditionValue;
                        case '!=':
                            return rowValue != conditionValue;
                        case '<':
                            return rowValue < conditionValue;
                        case '>':
                            return rowValue > conditionValue;
                        case '<=':
                            return rowValue <= conditionValue;
                        case '>=':
                            return rowValue >= conditionValue;
                        case 'like':
                            const pattern = conditionValue.replace(/%/g, '.*');
                            return new RegExp(`^${pattern}$`, 'i').test(rowValue);
                        case 'in':
                            const values = conditionValue.replace(/[()]/g, '').split(',').map(v => v.trim());
                            return values.includes(rowValue.toString());
                        default:
                            return true;
                    }
                });
            });
        }

        function executeJoinQuery(query, queryLower) {
            // 簡單的 JOIN 模擬
            const joinMatch = query.match(/from\s+(\w+)\s+(inner|left|right)?\s*join\s+(\w+)\s+on\s+(.+?)(?:\s+where|\s+order by|\s+limit|$)/i);
            
            if (!joinMatch) {
                return {
                    success: false,
                    error: 'JOIN 語法錯誤',
                    errorType: '語法錯誤'
                };
            }
            
            const table1 = joinMatch[1];
            const joinType = (joinMatch[2] || 'inner').toLowerCase();
            const table2 = joinMatch[3];
            const joinCondition = joinMatch[4];
            
            // 獲取表數據
            const data1 = databaseData.mysql[table1] || [];
            const data2 = databaseData.mysql[table2] || [];
            
            if (!data1.length || !data2.length) {
                return {
                    success: true,
                    data: [],
                    affectedRows: 0,
                    warnings: ['JOIN 操作返回空結果']
                };
            }
            
            // 解析連接條件
            const conditionMatch = joinCondition.match(/(\w+)\.(\w+)\s*=\s*(\w+)\.(\w+)/);
            if (!conditionMatch) {
                return {
                    success: false,
                    error: '不支持的 JOIN 條件格式',
                    errorType: '語法錯誤'
                };
            }
            
            const [_, table1Alias, field1, table2Alias, field2] = conditionMatch;
            
            // 執行 JOIN
            let result = [];
            
            if (joinType === 'inner') {
                result = data1.flatMap(row1 => 
                    data2
                        .filter(row2 => row1[field1] == row2[field2])
                        .map(row2 => ({ ...row1, ...row2 }))
                );
            } else if (joinType === 'left') {
                result = data1.flatMap(row1 => {
                    const matchingRows = data2.filter(row2 => row1[field1] == row2[field2]);
                    if (matchingRows.length === 0) {
                        return [{ ...row1 }];
                    }
                    return matchingRows.map(row2 => ({ ...row1, ...row2 }));
                });
            }
            
            return {
                success: true,
                data: result,
                affectedRows: 0
            };
        }

        function executeSubquery(query, queryLower) {
            // 簡單的子查詢模擬
            const subqueryMatch = query.match(/where\s+\w+\s+in\s*\((.+?)\)/i);
            
            if (!subqueryMatch) {
                return {
                    success: false,
                    error: '不支持的子查詢格式',
                    errorType: '語法錯誤'
                };
            }
            
            const subquery = subqueryMatch[1];
            // 遞歸執行子查詢
            const subqueryResult = executeEnhancedMySQLQuery(subquery);
            
            if (!subqueryResult.success) {
                return subqueryResult;
            }
            
            // 主查詢處理
            return executeSelectQuery(query.replace(subquery, '(...)'), queryLower);
        }

        function executeInsertQuery(query, queryLower) {
            const intoMatch = query.match(/into\s+(\w+)\s*\(([^)]+)\)\s*values\s*\(([^)]+)\)/i);
            
            if (!intoMatch) {
                return {
                    success: false,
                    error: 'INSERT 語法錯誤',
                    errorType: '語法錯誤'
                };
            }
            
            const tableName = intoMatch[1];
            const fields = intoMatch[2].split(',').map(f => f.trim());
            const values = intoMatch[3].split(',').map(v => v.trim().replace(/'/g, ''));
            
            // 檢查表是否存在
            if (!databaseData.mysql[tableName]) {
                databaseData.mysql[tableName] = [];
            }
            
            // 創建新記錄
            const newRecord = {};
            fields.forEach((field, index) => {
                let value = values[index];
                
                // 嘗試解析數字
                if (!isNaN(value) && value.trim() !== '') {
                    value = Number(value);
                }
                // 處理布林值
                else if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                    value = value.toLowerCase() === 'true';
                }
                // 處理 NULL
                else if (value.toLowerCase() === 'null') {
                    value = null;
                }
                
                newRecord[field] = value;
            });
            
            // 自動生成 ID（如果沒有提供）
            if (!newRecord.id && databaseData.mysql[tableName].length > 0) {
                const maxId = Math.max(...databaseData.mysql[tableName].map(r => r.id || 0));
                newRecord.id = maxId + 1;
            }
            
            databaseData.mysql[tableName].push(newRecord);
            localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
            
            return {
                success: true,
                data: newRecord,
                affectedRows: 1,
                message: '記錄插入成功'
            };
        }

        function executeUpdateQuery(query, queryLower) {
            const updateMatch = query.match(/update\s+(\w+)\s+set\s+(.+?)(?:\s+where|\s*$)/i);
            
            if (!updateMatch) {
                return {
                    success: false,
                    error: 'UPDATE 語法錯誤',
                    errorType: '語法錯誤'
                };
            }
            
            const tableName = updateMatch[1];
            const setClause = updateMatch[2];
            
            // 檢查表是否存在
            if (!databaseData.mysql[tableName]) {
                return {
                    success: false,
                    error: `表 '${tableName}' 不存在`,
                    errorType: '表不存在'
                };
            }
            
            // 解析 SET 子句
            const updates = {};
            const setParts = setClause.split(',').map(p => p.trim());
            
            setParts.forEach(part => {
                const [field, value] = part.split('=').map(s => s.trim());
                let parsedValue = value.replace(/'/g, '');
                
                // 嘗試解析數字
                if (!isNaN(parsedValue) && parsedValue.trim() !== '') {
                    parsedValue = Number(parsedValue);
                }
                // 處理布林值
                else if (parsedValue.toLowerCase() === 'true' || parsedValue.toLowerCase() === 'false') {
                    parsedValue = parsedValue.toLowerCase() === 'true';
                }
                // 處理 NULL
                else if (parsedValue.toLowerCase() === 'null') {
                    parsedValue = null;
                }
                
                updates[field] = parsedValue;
            });
            
            // 應用 WHERE 條件
            let affected = 0;
            let whereClause = '';
            
            if (queryLower.includes('where')) {
                whereClause = query.substring(queryLower.indexOf('where') + 5).trim();
            }
            
            databaseData.mysql[tableName] = databaseData.mysql[tableName].map(row => {
                let shouldUpdate = true;
                
                // 應用 WHERE 條件
                if (whereClause) {
                    const testData = [row];
                    const filtered = applyWhereClause(testData, whereClause);
                    shouldUpdate = filtered.length > 0;
                }
                
                if (shouldUpdate) {
                    affected++;
                    return { ...row, ...updates };
                }
                
                return row;
            });
            
            localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
            
            return {
                success: true,
                data: { updated: affected },
                affectedRows: affected,
                message: `更新了 ${affected} 條記錄`
            };
        }

        function executeDeleteQuery(query, queryLower) {
            const deleteMatch = query.match(/from\s+(\w+)(?:\s+where|\s*$)/i);
            
            if (!deleteMatch) {
                return {
                    success: false,
                    error: 'DELETE 語法錯誤',
                    errorType: '語法錯誤'
                };
            }
            
            const tableName = deleteMatch[1];
            
            // 檢查表是否存在
            if (!databaseData.mysql[tableName]) {
                return {
                    success: false,
                    error: `表 '${tableName}' 不存在`,
                    errorType: '表不存在'
                };
            }
            
            const originalLength = databaseData.mysql[tableName].length;
            let whereClause = '';
            
            if (queryLower.includes('where')) {
                whereClause = query.substring(queryLower.indexOf('where') + 5).trim();
            }
            
            if (whereClause) {
                // 應用 WHERE 條件過濾
                databaseData.mysql[tableName] = databaseData.mysql[tableName].filter(row => {
                    const testData = [row];
                    const filtered = applyWhereClause(testData, whereClause);
                    return filtered.length === 0; // 保留不符合條件的記錄
                });
            } else {
                // 沒有 WHERE 條件，清空表
                databaseData.mysql[tableName] = [];
            }
            
            const affected = originalLength - databaseData.mysql[tableName].length;
            localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
            
            return {
                success: true,
                data: { deleted: affected },
                affectedRows: affected,
                message: `刪除了 ${affected} 條記錄`,
                warnings: affected === 0 ? ['沒有記錄被刪除'] : []
            };
        }

        function executeCreateTableQuery(query, queryLower) {
            const createMatch = query.match(/create table\s+(\w+)\s*\((.+)\)/i);
            
            if (!createMatch) {
                return {
                    success: false,
                    error: 'CREATE TABLE 語法錯誤',
                    errorType: '語法錯誤'
                };
            }
            
            const tableName = createMatch[1];
            const columnsDef = createMatch[2];
            
            // 檢查表是否已存在
            if (databaseData.mysql[tableName]) {
                return {
                    success: false,
                    error: `表 '${tableName}' 已存在`,
                    errorType: '表已存在'
                };
            }
            
            // 解析列定義
            const columns = columnsDef.split(',').map(col => col.trim());
            const tableStructure = {
                columns: [],
                indexes: [],
                constraints: []
            };
            
            columns.forEach(col => {
                const colMatch = col.match(/(\w+)\s+(\w+)(?:\((\d+)\))?(?:\s+(primary key|not null|unique|auto_increment|default\s+\S+))*/i);
                if (colMatch) {
                    const [, name, type, size, modifiers] = colMatch;
                    tableStructure.columns.push({
                        name,
                        type: type.toLowerCase(),
                        size: size ? parseInt(size) : null,
                        modifiers: modifiers ? modifiers.toLowerCase() : ''
                    });
                }
                
                // 檢查約束
                if (col.includes('primary key')) {
                    const pkMatch = col.match(/primary key\s*\((\w+)\)/i);
                    if (pkMatch) {
                        tableStructure.constraints.push({
                            type: 'primary_key',
                            column: pkMatch[1]
                        });
                    }
                }
                
                if (col.includes('foreign key')) {
                    const fkMatch = col.match(/foreign key\s*\((\w+)\)\s+references\s+(\w+)\((\w+)\)/i);
                    if (fkMatch) {
                        tableStructure.constraints.push({
                            type: 'foreign_key',
                            column: fkMatch[1],
                            references: {
                                table: fkMatch[2],
                                column: fkMatch[3]
                            }
                        });
                    }
                }
            });
            
            // 創建空表
            databaseData.mysql[tableName] = [];
            databaseData.mysql[`${tableName}_structure`] = tableStructure;
            
            localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
            
            return {
                success: true,
                data: tableStructure,
                affectedRows: 0,
                message: `表 '${tableName}' 創建成功`
            };
        }

        function executeEnhancedMongoDBQuery(query) {
            const queryLower = query.toLowerCase().trim();
            
            try {
                // find 查詢
                if (queryLower.includes('db.') && queryLower.includes('.find')) {
                    return executeMongoFindQuery(query);
                }
                
                // insert 操作
                if (queryLower.includes('db.') && (queryLower.includes('.insert') || queryLower.includes('.save'))) {
                    return executeMongoInsertQuery(query);
                }
                
                // update 操作
                if (queryLower.includes('db.') && queryLower.includes('.update')) {
                    return executeMongoUpdateQuery(query);
                }
                
                // delete 操作
                if (queryLower.includes('db.') && queryLower.includes('.remove')) {
                    return executeMongoDeleteQuery(query);
                }
                
                // aggregate 管道
                if (queryLower.includes('db.') && queryLower.includes('.aggregate')) {
                    return executeMongoAggregateQuery(query);
                }
                
                // createIndex
                if (queryLower.includes('db.') && queryLower.includes('.createindex')) {
                    return executeMongoCreateIndexQuery(query);
                }
                
                return {
                    success: false,
                    error: '不支持的 MongoDB 語句或語法錯誤',
                    errorType: '語法錯誤'
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: `MongoDB 查詢錯誤: ${error.message}`,
                    errorType: '執行錯誤'
                };
            }
        }

        function executeMongoFindQuery(query) {
            const collectionMatch = query.match(/db\.(\w+)\.find/);
            if (!collectionMatch) {
                return {
                    success: false,
                    error: 'MongoDB 查詢語法錯誤',
                    errorType: '語法錯誤'
                };
            }
            
            const collectionName = collectionMatch[1];
            let data = databaseData.mongodb[collectionName] || [];
            
            // 解析查詢條件
            let filter = {};
            let projection = {};
            let options = {};
            
            // 提取查詢文檔
            const findMatch = query.match(/find\(([^)]*)\)/);
            if (findMatch && findMatch[1].trim()) {
                try {
                    const findArgs = findMatch[1];
                    // 簡單解析 JSON 或 JavaScript 對象
                    if (findArgs.includes('{') && findArgs.includes('}')) {
                        const jsonStr = findArgs.substring(findArgs.indexOf('{'), findArgs.lastIndexOf('}') + 1);
                        const parsed = parseMongoQuery(jsonStr);
                        if (parsed && typeof parsed === 'object') {
                            filter = parsed;
                        }
                    }
                } catch (e) {
                    // 解析失敗，使用空過濾器
                }
            }
            
            // 解析投影
            const projectionMatch = query.match(/find\([^)]*,\s*([^)]+)\)/);
            if (projectionMatch) {
                try {
                    const projectionStr = projectionMatch[1];
                    if (projectionStr.includes('{') && projectionStr.includes('}')) {
                        const jsonStr = projectionStr.substring(projectionStr.indexOf('{'), projectionStr.lastIndexOf('}') + 1);
                        projection = JSON.parse(jsonStr.replace(/(\w+):/g, '"$1":'));
                    }
                } catch (e) {
                    // 解析失敗
                }
            }
            
            // 應用過濾器
            if (Object.keys(filter).length > 0) {
                data = data.filter(doc => evaluateMongoFilter(doc, filter));
            }
            
            // 應用投影
            if (Object.keys(projection).length > 0) {
                data = data.map(doc => {
                    const projected = {};
                    Object.keys(projection).forEach(key => {
                        if (projection[key] && doc[key] !== undefined) {
                            projected[key] = doc[key];
                        }
                    });
                    return projected;
                });
            }
            
            return {
                success: true,
                data: data,
                count: data.length,
                message: `查找到 ${data.length} 個文檔`
            };
        }

        function parseMongoQuery(queryStr) {
            try {
                // 嘗試解析為 JSON
                return JSON.parse(queryStr.replace(/(\w+):/g, '"$1":'));
            } catch (e) {
                // 簡單解析
                const obj = {};
                const pairs = queryStr.replace(/[{}]/g, '').split(',');
                
                pairs.forEach(pair => {
                    const [key, value] = pair.split(':').map(s => s.trim());
                    if (key && value !== undefined) {
                        // 簡單的值解析
                        let parsedValue = value;
                        
                        if (value === 'true') parsedValue = true;
                        else if (value === 'false') parsedValue = false;
                        else if (value === 'null') parsedValue = null;
                        else if (!isNaN(value)) parsedValue = Number(value);
                        else if (value.startsWith('"') && value.endsWith('"')) parsedValue = value.slice(1, -1);
                        else if (value.startsWith("'") && value.endsWith("'")) parsedValue = value.slice(1, -1);
                        
                        obj[key] = parsedValue;
                    }
                });
                
                return obj;
            }
        }

        function evaluateMongoFilter(doc, filter) {
            for (const [key, condition] of Object.entries(filter)) {
                if (key.startsWith('$')) {
                    // 操作符處理
                    switch (key) {
                        case '$and':
                            if (!Array.isArray(condition)) return false;
                            return condition.every(subFilter => evaluateMongoFilter(doc, subFilter));
                        case '$or':
                            if (!Array.isArray(condition)) return false;
                            return condition.some(subFilter => evaluateMongoFilter(doc, subFilter));
                        case '$gt':
                            // 需要與其他條件結合使用，這裡簡化處理
                            break;
                    }
                } else {
                    // 普通條件
                    if (typeof condition === 'object' && condition !== null) {
                        // 操作符條件
                        for (const [op, value] of Object.entries(condition)) {
                            switch (op) {
                                case '$eq':
                                    if (doc[key] != value) return false;
                                    break;
                                case '$ne':
                                    if (doc[key] == value) return false;
                                    break;
                                case '$gt':
                                    if (!(doc[key] > value)) return false;
                                    break;
                                case '$gte':
                                    if (!(doc[key] >= value)) return false;
                                    break;
                                case '$lt':
                                    if (!(doc[key] < value)) return false;
                                    break;
                                case '$lte':
                                    if (!(doc[key] <= value)) return false;
                                    break;
                                case '$in':
                                    if (!Array.isArray(value) || !value.includes(doc[key])) return false;
                                    break;
                                case '$regex':
                                    const regex = new RegExp(value);
                                    if (!regex.test(doc[key])) return false;
                                    break;
                            }
                        }
                    } else {
                        // 簡單等值條件
                        if (doc[key] != condition) return false;
                    }
                }
            }
            
            return true;
        }

        function executeMongoAggregateQuery(query) {
            const collectionMatch = query.match(/db\.(\w+)\.aggregate/);
            if (!collectionMatch) {
                return {
                    success: false,
                    error: '聚合查詢語法錯誤',
                    errorType: '語法錯誤'
                };
            }
            
            const collectionName = collectionMatch[1];
            const data = databaseData.mongodb[collectionName] || [];
            
            // 解析聚合管道
            const pipelineMatch = query.match(/aggregate\(([^)]*)\)/);
            if (!pipelineMatch) {
                return {
                    success: true,
                    data: data,
                    count: data.length,
                    message: '聚合查詢返回原始數據'
                };
            }
            
            try {
                const pipelineStr = pipelineMatch[1];
                // 簡單解析管道階段
                let pipeline = [];
                
                if (pipelineStr.includes('[') && pipelineStr.includes(']')) {
                    const arrayStr = pipelineStr.substring(pipelineStr.indexOf('['), pipelineStr.lastIndexOf(']') + 1);
                    pipeline = JSON.parse(arrayStr.replace(/(\w+):/g, '"$1":'));
                }
                
                // 執行聚合管道
                let result = [...data];
                
                pipeline.forEach(stage => {
                    const [stageName, stageDef] = Object.entries(stage)[0];
                    
                    switch (stageName) {
                        case '$match':
                            result = result.filter(doc => evaluateMongoFilter(doc, stageDef));
                            break;
                        case '$group':
                            result = executeGroupStage(result, stageDef);
                            break;
                        case '$sort':
                            const sortField = Object.keys(stageDef)[0];
                            const sortOrder = stageDef[sortField];
                            result.sort((a, b) => {
                                if (a[sortField] < b[sortField]) return sortOrder === 1 ? -1 : 1;
                                if (a[sortField] > b[sortField]) return sortOrder === 1 ? 1 : -1;
                                return 0;
                            });
                            break;
                        case '$limit':
                            result = result.slice(0, stageDef);
                            break;
                        case '$project':
                            result = result.map(doc => {
                                const projected = {};
                                Object.keys(stageDef).forEach(key => {
                                    if (stageDef[key] && doc[key] !== undefined) {
                                        projected[key] = doc[key];
                                    }
                                });
                                return projected;
                            });
                            break;
                    }
                });
                
                return {
                    success: true,
                    data: result,
                    count: result.length,
                    message: `聚合查詢完成，返回 ${result.length} 個文檔`
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: `聚合管道解析錯誤: ${error.message}`,
                    errorType: '語法錯誤'
                };
            }
        }

        function executeGroupStage(data, groupDef) {
            const groupResult = {};
            const idFields = groupDef._id;
            
            data.forEach(doc => {
                // 創建分組鍵
                let groupKey;
                if (typeof idFields === 'string') {
                    groupKey = doc[idFields];
                } else if (typeof idFields === 'object') {
                    groupKey = JSON.stringify(
                        Object.fromEntries(
                            Object.entries(idFields).map(([key, field]) => [key, doc[field]])
                        )
                    );
                } else {
                    groupKey = 'all';
                }
                
                if (!groupResult[groupKey]) {
                    groupResult[groupKey] = {
                        _id: groupKey === 'all' ? null : (typeof idFields === 'string' ? doc[idFields] : idFields),
                        count: 0
                    };
                }
                
                const group = groupResult[groupKey];
                group.count++;
                
                // 處理累加器
                Object.entries(groupDef).forEach(([accName, accDef]) => {
                    if (accName !== '_id') {
                        if (accDef === '$sum') {
                            group[accName] = (group[accName] || 0) + 1;
                        } else if (accDef === '$sum') {
                            // 簡單的 $sum 實現
                        }
                    }
                });
            });
            
            return Object.values(groupResult);
        }

        function createTable() {
            const dbType = document.getElementById('db-type').value;
            let query;
            
            if (dbType === 'mysql') {
                query = `-- 創建用戶表
CREATE TABLE IF NOT EXISTS users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    age INT,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_active (active)
);

-- 創建訂單表
CREATE TABLE IF NOT EXISTS orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    status ENUM('pending', 'processing', 'completed', 'cancelled') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 創建產品表
CREATE TABLE IF NOT EXISTS products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    stock INT DEFAULT 0,
    category VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_category (category),
    INDEX idx_price (price),
    FULLTEXT idx_search (name, description)
);`;
            } else {
                query = `// 創建用戶集合
db.createCollection("users", {
    validator: {
        $jsonSchema: {
            bsonType: "object",
            required: ["username", "email"],
            properties: {
                username: {
                    bsonType: "string",
                    description: "必須是字符串且是必需的"
                },
                email: {
                    bsonType: "string",
                    pattern: "^.+@.+\\..+$",
                    description: "必須是有效的電子郵件地址"
                },
                age: {
                    bsonType: "int",
                    minimum: 0,
                    maximum: 150,
                    description: "年齡必須在 0-150 之間"
                },
                active: {
                    bsonType: "bool",
                    description: "必須是布林值"
                },
                created_at: {
                    bsonType: "date",
                    description: "必須是日期"
                }
            }
        }
    },
    validationLevel: "strict",
    validationAction: "error"
});

// 創建索引
db.users.createIndex({ username: 1 }, { unique: true });
db.users.createIndex({ email: 1 }, { unique: true });
db.users.createIndex({ active: 1 });
db.users.createIndex({ created_at: -1 });

// 創建訂單集合
db.createCollection("orders", {
    validator: {
        $jsonSchema: {
            bsonType: "object",
            required: ["user_id", "amount", "status"],
            properties: {
                user_id: {
                    bsonType: "string",
                    description: "用戶ID"
                },
                amount: {
                    bsonType: "double",
                    minimum: 0,
                    description: "金額必須大於等於0"
                },
                status: {
                    enum: ["pending", "processing", "completed", "cancelled"],
                    description: "必須是有效的狀態"
                },
                items: {
                    bsonType: "array",
                    items: {
                        bsonType: "object",
                        required: ["product_id", "quantity"],
                        properties: {
                            product_id: { bsonType: "string" },
                            quantity: { bsonType: "int", minimum: 1 },
                            price: { bsonType: "double", minimum: 0 }
                        }
                    }
                }
            }
        }
    }
});

// 創建訂單索引
db.orders.createIndex({ user_id: 1 });
db.orders.createIndex({ status: 1 });
db.orders.createIndex({ created_at: -1 });
db.orders.createIndex({ user_id: 1, status: 1 });`;
            }
            
            document.getElementById('db-query').value = query;
            showFlash('創建表語句已生成', 'success');
            logSystemEvent(`生成創建表語句: ${dbType}`, 'info');
        }

        function insertSampleData() {
            const dbType = document.getElementById('db-type').value;
            let query;
            
            if (dbType === 'mysql') {
                query = `-- 插入示例用戶數據
INSERT INTO users (username, email, age, active) VALUES
('zhangsan', 'zhangsan@example.com', 25, true),
('lisi', 'lisi@example.com', 30, true),
('wangwu', 'wangwu@example.com', 28, false),
('zhaoliu', 'zhaoliu@example.com', 35, true),
('sunqi', 'sunqi@example.com', 22, true);

-- 插入示例產品數據
INSERT INTO products (name, description, price, stock, category) VALUES
('筆記本電腦', '高性能筆記本電腦', 29999.99, 50, '電子產品'),
('智能手機', '最新款智能手機', 19999.99, 100, '電子產品'),
('藍牙耳機', '無線藍牙耳機', 2999.99, 200, '電子產品'),
('運動鞋', '舒適運動鞋', 1999.99, 150, '服裝'),
('背包', '多功能背包', 999.99, 80, '配件');

-- 插入示例訂單數據
INSERT INTO orders (user_id, amount, status) VALUES
(1, 29999.99, 'completed'),
(2, 19999.99, 'pending'),
(3, 2999.99, 'processing'),
(1, 1999.99, 'completed'),
(4, 999.99, 'cancelled');`;
            } else {
                query = `// 插入示例用戶數據
db.users.insertMany([
    {
        username: "zhangsan",
        email: "zhangsan@example.com",
        age: 25,
        active: true,
        created_at: new Date("2024-01-01")
    },
    {
        username: "lisi",
        email: "lisi@example.com",
        age: 30,
        active: true,
        created_at: new Date("2024-01-02")
    },
    {
        username: "wangwu",
        email: "wangwu@example.com",
        age: 28,
        active: false,
        created_at: new Date("2024-01-03")
    },
    {
        username: "zhaoliu",
        email: "zhaoliu@example.com",
        age: 35,
        active: true,
        created_at: new Date("2024-01-04")
    },
    {
        username: "sunqi",
        email: "sunqi@example.com",
        age: 22,
        active: true,
        created_at: new Date("2024-01-05")
    }
]);

// 插入示例訂單數據
db.orders.insertMany([
    {
        user_id: "1",
        amount: 29999.99,
        status: "completed",
        items: [
            { product_id: "1", quantity: 1, price: 29999.99 }
        ],
        created_at: new Date("2024-01-10")
    },
    {
        user_id: "2",
        amount: 19999.99,
        status: "pending",
        items: [
            { product_id: "2", quantity: 1, price: 19999.99 }
        ],
        created_at: new Date("2024-01-11")
    },
    {
        user_id: "3",
        amount: 2999.99,
        status: "processing",
        items: [
            { product_id: "3", quantity: 1, price: 2999.99 }
        ],
        created_at: new Date("2024-01-12")
    }
]);`;
            }
            
            document.getElementById('db-query').value = query;
            showFlash('示例數據語句已生成', 'success');
            logSystemEvent(`生成示例數據語句: ${dbType}`, 'info');
        }

        function showQueryAnalyzer() {
            const panel = document.getElementById('query-analyzer-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            
            if (panel.style.display === 'block') {
                analyzeCurrentQuery();
            }
        }

        function analyzeCurrentQuery() {
            const query = document.getElementById('db-query').value;
            const dbType = document.getElementById('db-type').value;
            
            const analysis = analyzeQueryPerformance(query, dbType);
            
            document.getElementById('query-analyzer-content').innerHTML = analysis;
        }

        function analyzeQueryPerformance(query, dbType, executionTime = null) {
            let analysis = `<h4>查詢效能分析</h4>`;
            
            // 基本統計
            const lines = query.split('\n').length;
            const words = query.split(/\s+/).length;
            const chars = query.length;
            
            analysis += `
                <div class="quality-metric">
                    <span>查詢長度</span>
                    <span>${lines} 行, ${words} 單詞, ${chars} 字符</span>
                </div>
            `;
            
            if (executionTime !== null) {
                analysis += `
                    <div class="quality-metric">
                        <span>執行時間</span>
                        <span>${executionTime}ms</span>
                    </div>
                `;
            }
            
            // 複雜度分析
            let complexity = '低';
            let suggestions = [];
            
            if (query.toLowerCase().includes('join')) {
                complexity = '中';
                suggestions.push('JOIN 操作可能影響效能，考慮添加索引');
            }
            
            if (query.toLowerCase().includes('select *')) {
                complexity = '中';
                suggestions.push('避免使用 SELECT *，只選擇需要的字段');
            }
            
            if (query.toLowerCase().includes('like \'%')) {
                complexity = '高';
                suggestions.push('前導 % 的 LIKE 查詢無法使用索引');
            }
            
            if (query.toLowerCase().includes('subquery') || query.toLowerCase().includes('(select')) {
                complexity = '高';
                suggestions.push('考慮將子查詢重寫為 JOIN');
            }
            
            if (query.toLowerCase().includes('order by') && query.toLowerCase().includes('rand()')) {
                complexity = '高';
                suggestions.push('ORDER BY RAND() 效能很差，考慮其他方案');
            }
            
            analysis += `
                <div class="quality-metric">
                    <span>複雜度評估</span>
                    <span>${complexity}</span>
                </div>
            `;
            
            // 建議
            if (suggestions.length > 0) {
                analysis += `<h5>優化建議</h5>`;
                suggestions.forEach((suggestion, index) => {
                    analysis += `
                        <div class="error-cause">
                            <strong>建議 ${index + 1}</strong><br>
                            ${suggestion}
                        </div>
                    `;
                });
            } else {
                analysis += `<div style="color: var(--accent-green); padding: 10px;">查詢效能良好，無需優化</div>`;
            }
            
            // 索引建議
            if (dbType === 'mysql') {
                analysis += `<h5>索引建議</h5>`;
                
                // 簡單的索引建議
                const whereMatch = query.match(/where\s+(.+?)(?:\s+order by|\s+group by|\s+limit|\s*$)/i);
                if (whereMatch) {
                    const whereClause = whereMatch[1];
                    const fields = whereClause.match(/(\w+)\s*[=<>!]/g);
                    
                    if (fields) {
                        const uniqueFields = [...new Set(fields.map(f => f.replace(/\s*[=<>!].*/, '').trim()))];
                        
                        analysis += `<p>考慮為以下字段創建索引：</p>`;
                        uniqueFields.forEach(field => {
                            analysis += `<div style="margin-left: 20px;">• ${field}</div>`;
                        });
                        
                        analysis += `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(56, 189, 248, 0.1); border-radius: 5px;">
                                <strong>創建索引語句示例：</strong><br>
                                <code>CREATE INDEX idx_${uniqueFields[0] || 'field'} ON table_name(${uniqueFields[0] || 'field'});</code>
                            </div>
                        `;
                    }
                }
            }
            
            return analysis;
        }

        function clearDatabase() {
            const dbType = document.getElementById('db-type').value;
            
            if (confirm(`確定要清空 ${dbType.toUpperCase()} 模擬數據庫嗎？此操作將刪除所有數據。`)) {
                if (dbType === 'mysql') {
                    // 保留表結構，只清空數據
                    Object.keys(databaseData.mysql).forEach(key => {
                        if (!key.endsWith('_structure')) {
                            databaseData.mysql[key] = [];
                        }
                    });
                    localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
                } else {
                    Object.keys(databaseData.mongodb).forEach(key => {
                        databaseData.mongodb[key] = [];
                    });
                    localStorage.setItem('mongodb-data', JSON.stringify(databaseData.mongodb));
                }
                
                const resultDiv = document.getElementById('db-result');
                resultDiv.innerHTML = `
                    <div class="log-entry warning">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>模擬數據庫已清空</strong><br>
                            數據庫類型: ${dbType}<br>
                            所有表/集合的數據已被清除<br>
                            表結構保留不變
                        </div>
                    </div>
                `;
                showFlash('模擬數據庫已清空', 'warning');
                logSystemEvent(`清空 ${dbType} 模擬數據庫`, 'warning');
            }
        }

        function generateMigration() {
            const migrationName = document.getElementById('migration-name').value;
            
            if (!migrationName) {
                showFlash('請輸入遷移名稱', 'warning');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0];
            const filename = `${timestamp}_${migrationName}.sql`;
            
            const migrationSQL = `-- 遷移: ${migrationName}
-- 創建時間: ${new Date().toISOString()}

-- 升級操作
-- 請在此處編寫升級數據庫的 SQL 語句

-- 示例: 創建新表
CREATE TABLE IF NOT EXISTS ${migrationName.replace(/[^a-zA-Z0-9_]/g, '_')} (
    id INT PRIMARY KEY AUTO_INCREMENT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 示例: 添加索引
-- CREATE INDEX idx_example ON table_name(column_name);

-- 降級操作 (可選)
-- 請在此處編寫降級數據庫的 SQL 語句

-- 示例: 刪除表
-- DROP TABLE IF EXISTS ${migrationName.replace(/[^a-zA-Z0-9_]/g, '_')};`;
            
            // 創建下載
            const blob = new Blob([migrationSQL], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showFlash(`遷移文件已生成: ${filename}`, 'success');
            logSystemEvent(`生成數據庫遷移文件: ${migrationName}`, 'info');
        }

        // ============================================
        // 身份验证功能（全面增強版）
        // ============================================
        function changeAuthType() {
            const type = document.getElementById('auth-type').value;
            
            // 隐藏所有配置面板
            document.getElementById('jwt-config').style.display = 'none';
            document.getElementById('session-config').style.display = 'none';
            document.getElementById('oauth-config').style.display = 'none';
            document.getElementById('oauth2-full-config').style.display = 'none';
            
            // 显示选中的配置面板
            switch (type) {
                case 'jwt':
                    document.getElementById('jwt-config').style.display = 'block';
                    break;
                case 'session':
                    document.getElementById('session-config').style.display = 'block';
                    break;
                case 'oauth':
                    document.getElementById('oauth-config').style.display = 'block';
                    break;
                case 'oauth2-full':
                    document.getElementById('oauth2-full-config').style.display = 'block';
                    break;
            }
            
            logSystemEvent(`切換認證類型: ${type}`, 'info');
        }

        function initUsers() {
            try {
                const userData = document.getElementById('user-data')?.value;
                if (userData) {
                    users = JSON.parse(userData);
                } else {
                    // 默认用户数据
                    users = [
                        {
                            id: 1,
                            username: 'admin',
                            password: 'admin123',
                            email: 'admin@example.com',
                            role: 'admin',
                            permissions: ['read', 'write', 'delete', 'manage_users'],
                            role_hierarchy: 1
                        }
                    ];
                }
            } catch (e) {
                users = [
                    {
                        id: 1,
                        username: 'admin',
                        password: 'admin123',
                        email: 'admin@example.com',
                        role: 'admin',
                        permissions: ['read', 'write', 'delete', 'manage_users'],
                        role_hierarchy: 1
                    }
                ];
            }
            
            updateRoleHierarchyDisplay();
        }

        function updateRoleHierarchyDisplay() {
            const hierarchyList = document.getElementById('role-hierarchy-list');
            hierarchyList.innerHTML = '';
            
            Object.entries(roleHierarchy).forEach(([role, level]) => {
                const roleDiv = document.createElement('div');
                roleDiv.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 8px;
                    margin: 5px 0;
                    background: rgba(56, 189, 248, 0.1);
                    border-radius: 5px;
                `;
                
                roleDiv.innerHTML = `
                    <span>${role}</span>
                    <div>
                        <span style="color: var(--accent-purple); margin-right: 10px;">層級: ${level}</span>
                        <button class="btn btn-warning" onclick="removeRole('${role}')" style="padding: 2px 8px; font-size: 0.8rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                hierarchyList.appendChild(roleDiv);
            });
        }

        function addRoleHierarchy() {
            const roleName = document.getElementById('role-name').value;
            const roleLevel = parseInt(document.getElementById('role-level').value);
            
            if (!roleName || !roleLevel) {
                showFlash('請填寫完整的角色信息', 'warning');
                return;
            }
            
            if (roleLevel < 1 || roleLevel > 10) {
                showFlash('角色層級必須在1-10之間', 'warning');
                return;
            }
            
            roleHierarchy[roleName] = roleLevel;
            
            // 清空輸入框
            document.getElementById('role-name').value = '';
            document.getElementById('role-level').value = '';
            
            updateRoleHierarchyDisplay();
            showFlash(`角色 ${roleName} 已添加`, 'success');
            logSystemEvent(`添加角色層級: ${roleName} (${roleLevel})`, 'info');
        }

        function removeRole(role) {
            if (confirm(`確定要刪除角色 ${role} 嗎？`)) {
                delete roleHierarchy[role];
                updateRoleHierarchyDisplay();
                showFlash(`角色 ${role} 已刪除`, 'success');
                logSystemEvent(`刪除角色: ${role}`, 'info');
            }
        }

        function generateToken() {
            const type = document.getElementById('auth-type').value;
            let token;
            let refreshToken = null;
            
            if (type === 'jwt' || type === 'oauth2-full') {
                const secret = document.getElementById('jwt-secret').value || 'your-secret-key-here';
                const expiry = document.getElementById('jwt-expiry').value || '1h';
                
                // 計算過期時間
                let expiresInSeconds;
                switch (expiry) {
                    case '1h': expiresInSeconds = 3600; break;
                    case '1d': expiresInSeconds = 86400; break;
                    case '7d': expiresInSeconds = 604800; break;
                    case '30d': expiresInSeconds = 2592000; break;
                    default: expiresInSeconds = 3600;
                }
                
                // 生成 JWT payload
                const payload = {
                    sub: '1234567890',
                    username: 'admin',
                    role: 'admin',
                    permissions: ['read', 'write', 'delete', 'manage_users'],
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + expiresInSeconds
                };
                
                // 使用 jsrsasign 生成 JWT
                const header = { alg: 'HS256', typ: 'JWT' };
                const sHeader = JSON.stringify(header);
                const sPayload = JSON.stringify(payload);
                
                try {
                    token = KJUR.jws.JWS.sign('HS256', sHeader, sPayload, secret);
                    
                    // 生成刷新 Token
                    if (type === 'oauth2-full') {
                        const refreshPayload = {
                            sub: '1234567890',
                            type: 'refresh',
                            iat: Math.floor(Date.now() / 1000),
                            exp: Math.floor(Date.now() / 1000) + 604800 // 7天
                        };
                        
                        refreshToken = KJUR.jws.JWS.sign('HS256', JSON.stringify(header), JSON.stringify(refreshPayload), secret);
                    }
                    
                    logSystemEvent('生成 JWT Token', 'info');
                } catch (error) {
                    showFlash(`JWT 生成失敗: ${error.message}`, 'error');
                    return;
                }
            } else if (type === 'session') {
                token = `session-id-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                logSystemEvent('生成 Session ID', 'info');
            } else if (type === 'oauth') {
                token = `oauth-token-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                logSystemEvent('生成 OAuth Token', 'info');
            } else {
                token = `basic-${btoa('admin:admin123')}`;
                logSystemEvent('生成 Basic Auth Token', 'info');
            }
            
            document.getElementById('current-token').value = token;
            
            if (refreshToken) {
                document.getElementById('refresh-token').value = refreshToken;
                localStorage.setItem('refresh-token', refreshToken);
            }
            
            localStorage.setItem('auth-token', token);
            showFlash(`${type.toUpperCase()} Token 已生成`, 'success');
        }

        function validateToken() {
            const token = document.getElementById('current-token').value;
            const type = document.getElementById('auth-type').value;
            
            if (!token) {
                showFlash('請先生成 Token', 'warning');
                return;
            }
            
            let isValid = false;
            let message = '';
            let payload = null;
            let isExpired = false;
            
            if (type === 'jwt' || type === 'oauth2-full') {
                const secret = document.getElementById('jwt-secret').value || 'your-secret-key-here';
                
                try {
                    const isValidJWT = KJUR.jws.JWS.verify(token, secret, ['HS256']);
                    
                    if (isValidJWT) {
                        isValid = true;
                        const parsed = KJUR.jws.JWS.parse(token);
                        payload = parsed.payloadObj;
                        
                        // 檢查是否過期
                        const currentTime = Math.floor(Date.now() / 1000);
                        if (payload.exp && payload.exp < currentTime) {
                            isValid = false;
                            isExpired = true;
                            message = 'JWT Token 已過期';
                        } else {
                            message = 'JWT Token 驗證成功';
                        }
                    } else {
                        message = 'JWT Token 驗證失敗';
                    }
                } catch (e) {
                    if (e.message.includes('expired')) {
                        isExpired = true;
                        message = 'JWT Token 已過期';
                    } else {
                        message = `JWT Token 驗證錯誤: ${e.message}`;
                    }
                }
            } else {
                isValid = token.length > 10;
                message = isValid ? `${type.toUpperCase()} Token 驗證成功` : 'Token 無效';
            }
            
            const resultsDiv = document.getElementById('auth-test-results');
            resultsDiv.innerHTML = `
                <div class="log-entry ${isValid ? 'success' : 'error'}">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>${message}</strong><br>
                        類型: ${type}<br>
                        ${isExpired ? '狀態: <span style="color: var(--accent-red);">已過期</span><br>' : ''}
                        ${payload ? `
                            用戶: ${payload.username || '未知'}<br>
                            角色: ${payload.role || '未知'}<br>
                            權限: ${Array.isArray(payload.permissions) ? payload.permissions.join(', ') : '未知'}<br>
                            發行時間: ${new Date((payload.iat || 0) * 1000).toLocaleString()}<br>
                            過期時間: ${new Date((payload.exp || 0) * 1000).toLocaleString()}<br>
                        ` : ''}
                        Token 前綴: ${token.substring(0, 50)}${token.length > 50 ? '...' : ''}
                    </div>
                </div>
            `;
            
            if (isValid) {
                showFlash('Token 驗證成功', 'success');
                logSystemEvent('Token 驗證成功', 'success');
            } else {
                showFlash(isExpired ? 'Token 已過期，請刷新' : 'Token 驗證失敗', 'error');
                logSystemEvent(isExpired ? 'Token 驗證失敗: 已過期' : 'Token 驗證失敗', 'error');
            }
        }

        function login() {
            const type = document.getElementById('auth-type').value;
            
            if (type === 'oauth' || type === 'oauth2-full') {
                showOAuthDialog();
                return;
            }
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                showFlash('請輸入用戶名和密碼', 'warning');
                return;
            }
            
            initUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            const resultsDiv = document.getElementById('auth-test-results');
            
            if (user) {
                let token;
                let refreshToken = null;
                
                if (type === 'jwt' || type === 'oauth2-full') {
                    const secret = document.getElementById('jwt-secret').value || 'your-secret-key-here';
                    const expiry = document.getElementById('jwt-expiry').value || '1h';
                    
                    // 計算過期時間
                    let expiresInSeconds;
                    switch (expiry) {
                        case '1h': expiresInSeconds = 3600; break;
                        case '1d': expiresInSeconds = 86400; break;
                        case '7d': expiresInSeconds = 604800; break;
                        case '30d': expiresInSeconds = 2592000; break;
                        default: expiresInSeconds = 3600;
                    }
                    
                    const header = { alg: 'HS256', typ: 'JWT' };
                    const payload = {
                        sub: user.id.toString(),
                        username: user.username,
                        role: user.role,
                        permissions: user.permissions || [],
                        iat: Math.floor(Date.now() / 1000),
                        exp: Math.floor(Date.now() / 1000) + expiresInSeconds
                    };
                    
                    token = KJUR.jws.JWS.sign('HS256', JSON.stringify(header), JSON.stringify(payload), secret);
                    
                    // 生成刷新 Token
                    if (type === 'oauth2-full') {
                        const refreshPayload = {
                            sub: user.id.toString(),
                            type: 'refresh',
                            iat: Math.floor(Date.now() / 1000),
                            exp: Math.floor(Date.now() / 1000) + 604800 // 7天
                        };
                        
                        refreshToken = KJUR.jws.JWS.sign('HS256', JSON.stringify(header), JSON.stringify(refreshPayload), secret);
                    }
                } else if (type === 'session') {
                    token = `session-${Date.now()}-${user.id}`;
                    localStorage.setItem('session-user', JSON.stringify(user));
                } else {
                    token = `basic-${btoa(username + ':' + password)}`;
                }
                
                document.getElementById('current-token').value = token;
                localStorage.setItem('auth-token', token);
                localStorage.setItem('current-user', JSON.stringify(user));
                
                if (refreshToken) {
                    document.getElementById('refresh-token').value = refreshToken;
                    localStorage.setItem('refresh-token', refreshToken);
                }
                
                resultsDiv.innerHTML = `
                    <div class="log-entry success">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>登入成功</strong><br>
                            用戶: ${user.username}<br>
                            角色: ${user.role}<br>
                            權限: ${Array.isArray(user.permissions) ? user.permissions.join(', ') : '無'}<br>
                            角色層級: ${roleHierarchy[user.role] || '未知'}<br>
                            Token: ${token.substring(0, 50)}...
                        </div>
                    </div>
                `;
                
                showFlash('登入成功', 'success');
                logSystemEvent(`用戶登入成功: ${username}`, 'success');
            } else {
                resultsDiv.innerHTML = `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>登入失敗</strong><br>
                            用戶名或密碼錯誤<br>
                            嘗試的用戶名: ${username}<br>
                            請檢查:<br>
                            1. 用戶名是否正確<br>
                            2. 密碼是否正確<br>
                            3. 用戶是否存在
                        </div>
                    </div>
                `;
                
                showFlash('登入失敗', 'error');
                logSystemEvent(`用戶登入失敗: ${username}`, 'error');
            }
        }

        function refreshToken() {
            const type = document.getElementById('auth-type').value;
            
            if (type !== 'jwt' && type !== 'oauth2-full') {
                showFlash('只有 JWT 和 OAuth 2.0 支持刷新 Token', 'warning');
                return;
            }
            
            const currentToken = document.getElementById('current-token').value;
            const secret = document.getElementById('jwt-secret').value || 'your-secret-key-here';
            
            if (!currentToken) {
                showFlash('請先獲取 Token', 'warning');
                return;
            }
            
            try {
                // 驗證當前 Token
                const isValid = KJUR.jws.JWS.verify(currentToken, secret, ['HS256']);
                
                if (!isValid) {
                    showFlash('當前 Token 無效，無法刷新', 'error');
                    return;
                }
                
                // 解析當前 Token
                const parsed = KJUR.jws.JWS.parse(currentToken);
                const payload = parsed.payloadObj;
                
                // 生成新 Token
                const expiry = document.getElementById('jwt-expiry').value || '1h';
                let expiresInSeconds;
                switch (expiry) {
                    case '1h': expiresInSeconds = 3600; break;
                    case '1d': expiresInSeconds = 86400; break;
                    case '7d': expiresInSeconds = 604800; break;
                    case '30d': expiresInSeconds = 2592000; break;
                    default: expiresInSeconds = 3600;
                }
                
                const header = { alg: 'HS256', typ: 'JWT' };
                const newPayload = {
                    ...payload,
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + expiresInSeconds
                };
                
                const newToken = KJUR.jws.JWS.sign('HS256', JSON.stringify(header), JSON.stringify(newPayload), secret);
                
                document.getElementById('current-token').value = newToken;
                localStorage.setItem('auth-token', newToken);
                
                const resultsDiv = document.getElementById('auth-test-results');
                resultsDiv.innerHTML += `
                    <div class="log-entry success">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>Token 刷新成功</strong><br>
                            舊 Token 過期時間: ${new Date((payload.exp || 0) * 1000).toLocaleString()}<br>
                            新 Token 過期時間: ${new Date(newPayload.exp * 1000).toLocaleString()}<br>
                            新 Token: ${newToken.substring(0, 50)}...
                        </div>
                    </div>
                `;
                
                showFlash('Token 刷新成功', 'success');
                logSystemEvent('JWT Token 刷新成功', 'info');
                
            } catch (error) {
                showFlash(`Token 刷新失敗: ${error.message}`, 'error');
                logSystemEvent(`Token 刷新失敗: ${error.message}`, 'error');
            }
        }

        function useRefreshToken() {
            const refreshTokenValue = document.getElementById('refresh-token').value;
            
            if (!refreshTokenValue) {
                showFlash('沒有可用的刷新 Token', 'warning');
                return;
            }
            
            const secret = document.getElementById('jwt-secret').value || 'your-secret-key-here';
            
            try {
                // 驗證刷新 Token
                const isValid = KJUR.jws.JWS.verify(refreshTokenValue, secret, ['HS256']);
                
                if (!isValid) {
                    showFlash('刷新 Token 無效', 'error');
                    return;
                }
                
                const parsed = KJUR.jws.JWS.parse(refreshTokenValue);
                const payload = parsed.payloadObj;
                
                if (payload.type !== 'refresh') {
                    showFlash('不是有效的刷新 Token', 'error');
                    return;
                }
                
                // 查找用戶
                initUsers();
                const user = users.find(u => u.id.toString() === payload.sub);
                
                if (!user) {
                    showFlash('用戶不存在', 'error');
                    return;
                }
                
                // 生成新存取 Token
                const expiry = document.getElementById('jwt-expiry').value || '1h';
                let expiresInSeconds;
                switch (expiry) {
                    case '1h': expiresInSeconds = 3600; break;
                    case '1d': expiresInSeconds = 86400; break;
                    case '7d': expiresInSeconds = 604800; break;
                    case '30d': expiresInSeconds = 2592000; break;
                    default: expiresInSeconds = 3600;
                }
                
                const header = { alg: 'HS256', typ: 'JWT' };
                const newPayload = {
                    sub: user.id.toString(),
                    username: user.username,
                    role: user.role,
                    permissions: user.permissions || [],
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + expiresInSeconds
                };
                
                const newToken = KJUR.jws.JWS.sign('HS256', JSON.stringify(header), JSON.stringify(newPayload), secret);
                
                document.getElementById('current-token').value = newToken;
                localStorage.setItem('auth-token', newToken);
                
                const resultsDiv = document.getElementById('auth-test-results');
                resultsDiv.innerHTML += `
                    <div class="log-entry success">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>使用刷新 Token 獲取新 Token 成功</strong><br>
                            用戶: ${user.username}<br>
                            新 Token 過期時間: ${new Date(newPayload.exp * 1000).toLocaleString()}<br>
                            新 Token: ${newToken.substring(0, 50)}...
                        </div>
                    </div>
                `;
                
                showFlash('使用刷新 Token 成功', 'success');
                logSystemEvent('使用刷新 Token 獲取新存取 Token', 'info');
                
            } catch (error) {
                showFlash(`刷新 Token 使用失敗: ${error.message}`, 'error');
                logSystemEvent(`刷新 Token 使用失敗: ${error.message}`, 'error');
            }
        }

        function showOAuthDialog() {
            // 生成授权码
            const authCode = `auth-code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            document.getElementById('oauth-auth-code').value = authCode;
            
            document.getElementById('oauth-dialog').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            
            logSystemEvent('顯示 OAuth 授權對話框', 'info');
        }

        function approveOAuth() {
            const authCode = document.getElementById('oauth-auth-code').value;
            const type = document.getElementById('auth-type').value;
            
            // 模拟交换 Token
            const secret = document.getElementById('jwt-secret').value || 'your-secret-key-here';
            
            let token;
            let refreshToken = null;
            
            if (type === 'oauth2-full') {
                // OAuth 2.0 完整流程
                const header = { alg: 'HS256', typ: 'JWT' };
                
                // 存取 Token
                const accessPayload = {
                    sub: 'oauth-user',
                    username: 'oauth-user',
                    role: 'user',
                    permissions: ['read', 'write'],
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + 3600,
                    scope: 'read write'
                };
                
                token = KJUR.jws.JWS.sign('HS256', JSON.stringify(header), JSON.stringify(accessPayload), secret);
                
                // 刷新 Token
                const refreshPayload = {
                    sub: 'oauth-user',
                    type: 'refresh',
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + 604800
                };
                
                refreshToken = KJUR.jws.JWS.sign('HS256', JSON.stringify(header), JSON.stringify(refreshPayload), secret);
                
            } else {
                // 簡化版 OAuth
                token = `oauth-token-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }
            
            document.getElementById('current-token').value = token;
            localStorage.setItem('auth-token', token);
            
            if (refreshToken) {
                document.getElementById('refresh-token').value = refreshToken;
                localStorage.setItem('refresh-token', refreshToken);
            }
            
            // 模拟用户数据
            const user = {
                id: 'oauth-1',
                username: 'oauth-user',
                email: 'oauth@example.com',
                role: 'user',
                permissions: ['read', 'write']
            };
            localStorage.setItem('current-user', JSON.stringify(user));
            
            const resultsDiv = document.getElementById('auth-test-results');
            resultsDiv.innerHTML = `
                <div class="log-entry success">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>OAuth 授權成功</strong><br>
                        授權碼: ${authCode}<br>
                        ${type === 'oauth2-full' ? '存取 Token' : 'Token'}: ${token.substring(0, 50)}...<br>
                        ${refreshToken ? `刷新 Token: ${refreshToken.substring(0, 50)}...<br>` : ''}
                        用戶: ${user.username}<br>
                        角色: ${user.role}<br>
                        權限: ${user.permissions.join(', ')}
                    </div>
                </div>
            `;
            
            hideOAuthDialog();
            showFlash('OAuth 授權成功', 'success');
            logSystemEvent('OAuth 授權成功', 'success');
        }

        function denyOAuth() {
            hideOAuthDialog();
            showFlash('OAuth 授權被拒絕', 'warning');
            logSystemEvent('OAuth 授權被拒絕', 'warning');
        }

        function hideOAuthDialog() {
            document.getElementById('oauth-dialog').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function accessProtectedResource() {
            const resource = document.getElementById('protected-resource').value;
            const requiredRole = document.getElementById('resource-role').value;
            const token = document.getElementById('current-token').value || localStorage.getItem('auth-token');
            const type = document.getElementById('auth-type').value;
            
            const resultsDiv = document.getElementById('auth-test-results');
            
            if (!token) {
                resultsDiv.innerHTML += `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>訪問失敗</strong><br>
                            資源: ${resource}<br>
                            所需角色: ${requiredRole}<br>
                            錯誤: 未提供認證 Token<br>
                            建議: 請先登入或獲取 Token
                        </div>
                    </div>
                `;
                
                showFlash('訪問失敗: 未授權', 'error');
                logSystemEvent(`訪問失敗: 未授權訪問 ${resource}`, 'error');
                return;
            }
            
            // 模拟访问控制
            let hasAccess = false;
            let role = 'guest';
            let username = 'anonymous';
            let userPermissions = [];
            let userRoleLevel = 10; // 默认最低权限
            
            if (type === 'jwt' || type === 'oauth' || type === 'oauth2-full') {
                try {
                    const secret = document.getElementById('jwt-secret').value || 'your-secret-key-here';
                    const isValid = KJUR.jws.JWS.verify(token, secret, ['HS256']);
                    
                    if (isValid) {
                        const payload = KJUR.jws.JWS.parse(token).payloadObj;
                        role = payload.role || 'user';
                        username = payload.username || 'unknown';
                        userPermissions = payload.permissions || [];
                        
                        // 获取用户角色层级
                        userRoleLevel = roleHierarchy[role] || 10;
                        
                        // 获取所需角色层级
                        const requiredRoleLevel = roleHierarchy[requiredRole] || 10;
                        
                        // 检查权限（基于角色层级）
                        if (resource.includes('/api/admin')) {
                            hasAccess = userRoleLevel <= 1; // 只有 admin 可以访问
                        } else if (resource.includes('/api/manager')) {
                            hasAccess = userRoleLevel <= 2; // manager 及以上可以访问
                        } else if (resource.includes('/api/user')) {
                            hasAccess = userRoleLevel <= 3; // user 及以上可以访问
                        } else if (resource.includes('/api/public')) {
                            hasAccess = true; // 公开资源
                        } else {
                            // 默认检查
                            hasAccess = userRoleLevel <= requiredRoleLevel;
                        }
                    }
                } catch (e) {
                    // Token 无效
                    console.log('Token 验证失败:', e.message);
                }
            } else {
                // 其他认证类型
                hasAccess = token.length > 10;
                role = 'user';
                username = 'user';
            }
            
            if (hasAccess) {
                resultsDiv.innerHTML += `
                    <div class="log-entry success">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>訪問成功</strong><br>
                            資源: ${resource}<br>
                            所需角色: ${requiredRole} (層級: ${roleHierarchy[requiredRole] || '未知'})<br>
                            用戶: ${username}<br>
                            角色: ${role} (層級: ${userRoleLevel})<br>
                            權限: ${userPermissions.join(', ') || '無'}<br>
                            狀態: 授權訪問<br>
                            訪問時間: ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;
                
                showFlash('訪問成功', 'success');
                logSystemEvent(`訪問成功: ${resource}`, 'success');
            } else {
                resultsDiv.innerHTML += `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>訪問被拒絕</strong><br>
                            資源: ${resource}<br>
                            所需角色: ${requiredRole} (層級: ${roleHierarchy[requiredRole] || '未知'})<br>
                            用戶: ${username}<br>
                            角色: ${role} (層級: ${userRoleLevel})<br>
                            權限: ${userPermissions.join(', ') || '無'}<br>
                            錯誤: 權限不足<br>
                            原因: 用戶角色層級 (${userRoleLevel}) 高於所需角色層級 (${roleHierarchy[requiredRole] || '未知'})<br>
                            建議: 聯繫管理員獲取更高權限
                        </div>
                    </div>
                `;
                
                showFlash('訪問被拒絕: 權限不足', 'error');
                logSystemEvent(`訪問被拒絕: 權限不足 ${resource}`, 'error');
            }
        }

        function simulateLogout() {
            document.getElementById('current-token').value = '';
            document.getElementById('refresh-token').value = '';
            
            localStorage.removeItem('auth-token');
            localStorage.removeItem('refresh-token');
            localStorage.removeItem('current-user');
            localStorage.removeItem('session-user');
            
            const resultsDiv = document.getElementById('auth-test-results');
            resultsDiv.innerHTML = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>已登出</strong><br>
                        Token 已清除<br>
                        會話已結束<br>
                        需要重新認證才能訪問受保護資源
                    </div>
                </div>
            `;
            
            showFlash('已登出', 'info');
            logSystemEvent('用戶登出', 'info');
        }

        function simulateSecurityVulnerability() {
            const vulnType = document.getElementById('security-vuln').value;
            const resultsDiv = document.getElementById('auth-test-results');
            
            let attackDescription = '';
            let attackResult = '';
            let severity = '';
            
            switch (vulnType) {
                case 'sql-injection':
                    attackDescription = '攻擊者嘗試 SQL 注入攻擊: \' OR \'1\'=\'1';
                    attackResult = '如果應用程序未使用參數化查詢，攻擊者可能成功繞過認證或訪問敏感數據';
                    severity = '高';
                    break;
                    
                case 'xss':
                    attackDescription = '攻擊者嘗試 XSS 攻擊: <script>alert("XSS")</script>';
                    attackResult = '如果應用程序未對用戶輸入進行適當過濾，惡意腳本可能在用戶瀏覽器中執行';
                    severity = '中';
                    break;
                    
                case 'csrf':
                    attackDescription = '攻擊者嘗試 CSRF 攻擊: 偽造惡意請求';
                    attackResult = '如果應用程序未使用 CSRF Token，攻擊者可能以用戶身份執行未經授權的操作';
                    severity = '中';
                    break;
                    
                case 'jwt-tamper':
                    attackDescription = '攻擊者嘗試竄改 JWT Token';
                    attackResult = '如果應用程序未正確驗證簽名，攻擊者可能提升權限或訪問其他用戶數據';
                    severity = '高';
                    break;
            }
            
            resultsDiv.innerHTML += `
                <div class="log-entry warning">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>安全漏洞模擬: ${vulnType.toUpperCase()}</strong><br>
                        攻擊描述: ${attackDescription}<br>
                        可能結果: ${attackResult}<br>
                        嚴重程度: ${severity}<br>
                        狀態: 模擬攻擊已執行
                    </div>
                </div>
            `;
            
            showFlash(`安全漏洞模擬: ${vulnType}`, 'warning');
            logSystemEvent(`模擬安全漏洞攻擊: ${vulnType}`, 'warning');
        }

        function showSecurityFix() {
            const vulnType = document.getElementById('security-vuln').value;
            const resultsDiv = document.getElementById('auth-test-results');
            
            let fixDescription = '';
            let codeExample = '';
            
            switch (vulnType) {
                case 'sql-injection':
                    fixDescription = '使用參數化查詢或預編譯語句';
                    codeExample = `// 錯誤示例（易受攻擊）
const query = "SELECT * FROM users WHERE username = '" + username + "'";

// 正確示例（安全）
const query = "SELECT * FROM users WHERE username = ?";
db.execute(query, [username]);`;
                    break;
                    
                case 'xss':
                    fixDescription = '對用戶輸入進行適當的轉義和過濾';
                    codeExample = `// 錯誤示例（易受攻擊）
res.send('<div>' + userInput + '</div>');

// 正確示例（安全）
const sanitized = userInput
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;');
res.send('<div>' + sanitized + '</div>');`;
                    break;
                    
                case 'csrf':
                    fixDescription = '使用 CSRF Token 和 SameSite Cookie';
                    codeExample = `// 服務器端生成 CSRF Token
const csrfToken = generateToken();
res.cookie('csrf_token', csrfToken, { httpOnly: true, sameSite: 'strict' });

// 客戶端在請求中包含 Token
fetch('/api/action', {
    method: 'POST',
    headers: {
        'X-CSRF-Token': getCookie('csrf_token')
    }
});

// 服務器端驗證 Token
app.post('/api/action', csrfProtection, (req, res) => {
    // 處理請求
});`;
                    break;
                    
                case 'jwt-tamper':
                    fixDescription = '使用強密鑰並正確驗證簽名，設置合理的過期時間';
                    codeExample = `// 錯誤示例（易受攻擊）
const token = jwt.decode(userToken); // 只解碼，不驗證

// 正確示例（安全）
try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET, {
        algorithms: ['HS256'],
        maxAge: '1h'
    });
    // 使用解碼後的數據
} catch (error) {
    // 處理驗證失敗
}`;
                    break;
            }
            
            resultsDiv.innerHTML += `
                <div class="log-entry success">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>安全修復方案: ${vulnType.toUpperCase()}</strong><br>
                        修復方法: ${fixDescription}<br>
                        代碼示例:<br>
                        <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 5px; overflow: auto;">${codeExample}</pre>
                        建議:<br>
                        1. 定期進行安全審計<br>
                        2. 使用安全開發框架<br>
                        3. 實施適當的輸入驗證<br>
                        4. 保持依賴包更新
                    </div>
                </div>
            `;
            
            showFlash(`安全修復方案已顯示: ${vulnType}`, 'success');
            logSystemEvent(`顯示安全修復方案: ${vulnType}`, 'info');
        }

        // ============================================
        // 单元测试功能（全面增強版）
        // ============================================
        function runTests() {
            const framework = document.getElementById('test-framework').value;
            const code = document.getElementById('test-code').value;
            
            logSystemEvent(`執行單元測試: ${framework}`, 'info');
            showFlash('測試執行中...', 'info');
            
            // 显示加载状态
            const runBtn = document.querySelector('.btn[onclick="runTests()"]');
            const originalHtml = runBtn.innerHTML;
            runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 測試中...';
            runBtn.disabled = true;
            
            setTimeout(() => {
                let results;
                const startTime = Date.now();
                
                if (framework === 'jest') {
                    results = simulateJestTests(code);
                } else if (framework === 'pytest') {
                    results = simulatePytestTests(code);
                } else if (framework === 'junit') {
                    results = simulateJUnitTests(code);
                } else if (framework === 'mock') {
                    results = simulateMockTests(code);
                } else {
                    results = {
                        passed: 0,
                        failed: 0,
                        total: 0,
                        coverage: 0,
                        executionTime: 0,
                        tests: [],
                        error: '不支持的測試框架'
                    };
                }
                
                const executionTime = Date.now() - startTime;
                results.executionTime = executionTime;
                
                const resultsDiv = document.getElementById('test-results');
                
                if (results.error) {
                    resultsDiv.innerHTML = `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>測試執行失敗</strong><br>
                                框架: ${framework}<br>
                                錯誤: ${results.error}<br>
                                執行時間: ${executionTime}ms
                            </div>
                        </div>
                    `;
                    
                    showFlash('測試執行失敗', 'error');
                    logSystemEvent(`單元測試失敗: ${results.error}`, 'error');
                } else {
                    resultsDiv.innerHTML = `
                        <div class="log-entry ${results.passed === results.total ? 'success' : 'warning'}">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>測試完成</strong><br>
                                框架: ${framework}<br>
                                通過: ${results.passed}/${results.total}<br>
                                失敗: ${results.failed}/${results.total}<br>
                                成功率: ${((results.passed / results.total) * 100).toFixed(1)}%<br>
                                覆蓋率: ${results.coverage}%<br>
                                執行時間: ${executionTime}ms
                            </div>
                        </div>
                    `;
                    
                    // 添加详细的测试结果
                    results.tests.forEach(test => {
                        resultsDiv.innerHTML += `
                            <div class="log-entry ${test.passed ? 'success' : 'error'}">
                                <div class="log-message">
                                    ${test.passed ? '✓' : '✗'} ${test.name}<br>
                                    ${test.message}<br>
                                    ${test.duration ? `用時: ${test.duration}ms` : ''}
                                    ${test.error ? `<br>錯誤: ${test.error}` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    const message = results.passed === results.total ? 
                        '所有測試通過' : `${results.passed}/${results.total} 測試通過`;
                    showFlash(message, results.passed === results.total ? 'success' : 'warning');
                    logSystemEvent(`單元測試完成: ${message}`, results.passed === results.total ? 'success' : 'warning');
                    
                    // 顯示覆蓋率報告
                    updateCoverageReport(results);
                }
                
                // 恢复按钮状态
                runBtn.innerHTML = originalHtml;
                runBtn.disabled = false;
            }, 1500);
        }

        function simulateJestTests(code) {
            // 解析測試代碼
            const tests = [];
            let passed = 0;
            let total = 0;
            
            // 簡單的測試檢測
            const testRegex = /(test|it)\(['"](.+?)['"]/g;
            let match;
            
            while ((match = testRegex.exec(code)) !== null) {
                total++;
                const testName = match[2];
                const shouldPass = Math.random() > 0.2; // 80% 通過率
                
                if (shouldPass) {
                    passed++;
                    tests.push({
                        name: testName,
                        passed: true,
                        message: '測試通過',
                        duration: Math.floor(Math.random() * 50) + 10
                    });
                } else {
                    tests.push({
                        name: testName,
                        passed: false,
                        message: '測試失敗',
                        error: '期望值不匹配',
                        duration: Math.floor(Math.random() * 30) + 5
                    });
                }
            }
            
            // 檢查 describe 塊
            const describeRegex = /describe\(['"](.+?)['"]/g;
            let describeCount = 0;
            while ((describeRegex.exec(code)) !== null) {
                describeCount++;
            }
            
            // 計算覆蓋率
            const coverage = Math.min(95, 70 + (passed / Math.max(total, 1)) * 25);
            
            return {
                passed,
                failed: total - passed,
                total,
                coverage: Math.round(coverage),
                tests,
                describeBlocks: describeCount
            };
        }

        function simulatePytestTests(code) {
            const tests = [];
            let passed = 0;
            let total = 0;
            
            // 檢測 Python 測試函數
            const testRegex = /def (test_.+?)\(/g;
            let match;
            
            while ((match = testRegex.exec(code)) !== null) {
                total++;
                const testName = match[1];
                const shouldPass = Math.random() > 0.3; // 70% 通過率
                
                if (shouldPass) {
                    passed++;
                    tests.push({
                        name: testName,
                        passed: true,
                        message: '測試通過',
                        duration: Math.floor(Math.random() * 40) + 5
                    });
                } else {
                    tests.push({
                        name: testName,
                        passed: false,
                        message: '測試失敗',
                        error: 'AssertionError',
                        duration: Math.floor(Math.random() * 20) + 3
                    });
                }
            }
            
            // 計算覆蓋率
            const coverage = Math.min(90, 65 + (passed / Math.max(total, 1)) * 25);
            
            return {
                passed,
                failed: total - passed,
                total,
                coverage: Math.round(coverage),
                tests
            };
        }

        function simulateMockTests(code) {
            const tests = [];
            let passed = 0;
            let total = 0;
            
            // 檢測 Mock 相關測試
            const mockRegex = /\.mock\.|jest\.mock|unittest\.mock/gi;
            const hasMock = mockRegex.test(code);
            
            if (hasMock) {
                total = 3;
                passed = 2; // 模擬一個失敗的測試
                
                tests.push(
                    {
                        name: 'Mock 函數調用測試',
                        passed: true,
                        message: 'Mock 函數被正確調用',
                        duration: 25
                    },
                    {
                        name: 'Mock 返回值測試',
                        passed: true,
                        message: 'Mock 返回預期值',
                        duration: 18
                    },
                    {
                        name: 'Mock 異常測試',
                        passed: false,
                        message: 'Mock 異常未正確處理',
                        error: 'Expected error not thrown',
                        duration: 12
                    }
                );
            } else {
                total = 1;
                passed = 1;
                
                tests.push({
                    name: '基本功能測試',
                    passed: true,
                    message: '測試通過',
                    duration: 15
                });
            }
            
            return {
                passed,
                failed: total - passed,
                total,
                coverage: hasMock ? 85 : 70,
                tests,
                hasMocking: hasMock
            };
        }

        function calculateCoverage() {
            const framework = document.getElementById('test-framework').value;
            const code = document.getElementById('test-code').value;
            
            // 計算代碼覆蓋率
            let coverage = 75; // 基礎覆蓋率
            
            // 根據測試數量調整覆蓋率
            const testCount = (code.match(/test\(/g) || []).length;
            coverage = Math.min(95, coverage + testCount * 5);
            
            // 根據框架調整
            if (framework === 'pytest') coverage += 5;
            if (framework === 'jest') coverage += 3;
            
            // 顯示覆蓋率報告
            document.getElementById('coverage-report').style.display = 'block';
            document.getElementById('coverage-report-content').innerHTML = `
                <h4>代碼覆蓋率分析</h4>
                <div class="quality-metric">
                    <span>總覆蓋率</span>
                    <span>${coverage}%</span>
                </div>
                <div class="quality-metric">
                    <span>語句覆蓋率</span>
                    <span>${Math.min(100, coverage + 5)}%</span>
                </div>
                <div class="quality-metric">
                    <span>分支覆蓋率</span>
                    <span>${Math.min(100, coverage - 10)}%</span>
                </div>
                <div class="quality-metric">
                    <span>函數覆蓋率</span>
                    <span>${Math.min(100, coverage + 2)}%</span>
                </div>
                <div class="quality-metric">
                    <span>行覆蓋率</span>
                    <span>${coverage}%</span>
                </div>
                
                <h5>覆蓋率詳情</h5>
                <div style="margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>已覆蓋代碼</span>
                        <span>${coverage}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${coverage}%"></div>
                    </div>
                </div>
                
                <div style="margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>未覆蓋代碼</span>
                        <span>${100 - coverage}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${100 - coverage}%; background: var(--gradient-red);"></div>
                    </div>
                </div>
                
                <h5>改進建議</h5>
                <div class="error-cause">
                    <strong>增加邊界測試</strong><br>
                    添加更多邊界條件測試用例
                </div>
                <div class="error-cause">
                    <strong>錯誤處理測試</strong><br>
                    添加異常和錯誤處理測試
                </div>
                <div class="error-cause">
                    <strong>集成測試</strong><br>
                    考慮添加集成測試提高覆蓋率
                </div>
            `;
            
            showFlash(`代碼覆蓋率: ${coverage}%`, 'info');
            logSystemEvent(`計算代碼覆蓋率: ${coverage}%`, 'info');
        }

        function updateCoverageReport(testResults) {
            document.getElementById('coverage-report').style.display = 'block';
            document.getElementById('coverage-report-content').innerHTML = `
                <h4>測試覆蓋率報告</h4>
                <div class="quality-metric">
                    <span>測試通過率</span>
                    <span>${((testResults.passed / testResults.total) * 100).toFixed(1)}%</span>
                </div>
                <div class="quality-metric">
                    <span>代碼覆蓋率</span>
                    <span>${testResults.coverage}%</span>
                </div>
                <div class="quality-metric">
                    <span>測試用例數</span>
                    <span>${testResults.total}</span>
                </div>
                <div class="quality-metric">
                    <span>測試執行時間</span>
                    <span>${testResults.executionTime}ms</span>
                </div>
                
                ${testResults.describeBlocks ? `
                <div class="quality-metric">
                    <span>測試套件數</span>
                    <span>${testResults.describeBlocks}</span>
                </div>
                ` : ''}
                
                ${testResults.hasMocking ? `
                <div class="quality-metric">
                    <span>Mock 測試</span>
                    <span>是</span>
                </div>
                ` : ''}
                
                <h5>覆蓋率趨勢</h5>
                <div style="height: 100px; background: rgba(0,0,0,0.3); border-radius: 5px; padding: 10px; margin: 10px 0;">
                    <div style="display: flex; height: 100%; align-items: flex-end; gap: 10px;">
                        ${[70, 75, 80, 85, testResults.coverage].map((value, index) => `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                                <div style="width: 20px; background: var(--gradient-blue); border-radius: 3px; height: ${value}%;"></div>
                                <div style="margin-top: 5px; font-size: 0.8rem;">${['第1次', '第2次', '第3次', '第4次', '本次'][index]}</div>
                                <div style="font-size: 0.7rem; color: var(--text-gray);">${value}%</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function addTestCase() {
            const framework = document.getElementById('test-framework').value;
            let testCode;
            
            if (framework === 'jest') {
                testCode = `\n// 新的測試用例
test('新的測試用例', () => {
  // 測試邏輯
  expect(true).toBe(true);
  expect(1 + 1).toBe(2);
  
  // 數組測試
  expect([1, 2, 3]).toHaveLength(3);
  expect([1, 2, 3]).toContain(2);
  
  // 對象測試
  const user = { name: '張三', age: 25 };
  expect(user).toHaveProperty('name');
  expect(user.age).toBeGreaterThan(18);
  
  // 非同步測試示例
  // test('非同步測試', async () => {
  //   const data = await fetchData();
  //   expect(data).toBeDefined();
  // });
});`;
            } else if (framework === 'pytest') {
                testCode = `\n# 新的測試用例
def test_new_case():
    """測試新功能"""
    assert 1 + 1 == 2
    
    # 列表測試
    assert len([1, 2, 3]) == 3
    assert 2 in [1, 2, 3]
    
    # 字典測試
    user = {"name": "張三", "age": 25}
    assert "name" in user
    assert user["age"] > 18
    
    # 異常測試示例
    # def test_exception():
    #     with pytest.raises(ValueError):
    #         raise ValueError("錯誤")`;
            } else if (framework === 'junit') {
                testCode = `\n// 新的測試用例
@Test
public void testNew

    </body>
</html>
