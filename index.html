<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後端工程師模擬學習平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.5.25/lib/jsrsasign-all-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        :root {
            --primary-color: #0f172a;
            --secondary-color: #1e293b;
            --accent-blue: #38bdf8;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --text-light: #f8fafc;
            --text-gray: #cbd5e1;
            --code-bg: #0d1117;
            --terminal-bg: #111827;
            --shadow-color: rgba(56, 189, 248, 0.2);
            --gradient-blue: linear-gradient(135deg, #1e40af 0%, #38bdf8 100%);
            --gradient-green: linear-gradient(135deg, #065f46 0%, #10b981 100%);
            --gradient-red: linear-gradient(135deg, #7f1d1d 0%, #ef4444 100%);
            --gradient-purple: linear-gradient(135deg, #4c1d95 0%, #8b5cf6 100%);
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--primary-color);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 20%);
        }

        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            opacity: 0.3;
        }

        /* 侧边栏导航 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(56, 189, 248, 0.2);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            padding: 20px;
        }

        .sidebar-header {
            padding: 20px 0;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            color: var(--accent-blue);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-section h3 {
            color: var(--accent-green);
            font-size: 1rem;
            margin-bottom: 10px;
            padding-left: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-gray);
        }

        .nav-item:hover {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent-blue);
        }

        .nav-item.active {
            background: var(--gradient-blue);
            color: white;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--accent-green);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .main-content.sidebar-open {
                margin-left: var(--sidebar-width);
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--gradient-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
        }

        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        /* 页面容器 */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 页面头部 */
        .page-header {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(56, 189, 248, 0.3);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-blue);
        }

        .page-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: var(--text-gray);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        /* 步骤引导 */
        .step-guide {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
            border-left: 4px solid var(--accent-blue);
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(56, 189, 248, 0.1);
            color: var(--text-gray);
            transition: all 0.3s ease;
        }

        .step-item.active {
            background: var(--gradient-blue);
            color: white;
        }

        .step-item.completed {
            background: var(--gradient-green);
            color: white;
        }

        .step-connector {
            width: 30px;
            height: 2px;
            background: var(--accent-blue);
            opacity: 0.3;
        }

        /* 编辑器容器 */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .editor-container {
                gap: 10px;
            }
            .code-panel, .console-panel {
                min-height: 300px;
            }
        }

        .code-panel, .console-panel {
            background: var(--code-bg);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        .panel-header {
            background: var(--secondary-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .panel-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* 代码编辑器 */
        .CodeMirror {
            height: 500px !important;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
        }

        .CodeMirror-gutter-breakpoint {
            background: var(--accent-red);
            border-radius: 50%;
            margin-left: 5px;
            cursor: pointer;
        }

        /* 控制台输出 */
        .console-content {
            padding: 20px;
            font-family: 'Fira Code', 'Courier New', monospace;
            height: 500px;
            overflow-y: auto;
            background: var(--terminal-bg);
        }

        .console-tabs {
            display: flex;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .console-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-gray);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .console-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid transparent;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-entry.info { border-left-color: var(--accent-blue); }
        .log-entry.success { border-left-color: var(--accent-green); }
        .log-entry.error { border-left-color: var(--accent-red); }
        .log-entry.warning { border-left-color: var(--accent-yellow); }

        .log-time {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .log-message {
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* 工具栏 */
        .toolbar {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: var(--gradient-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow-color);
        }

        .btn-success {
            background: var(--gradient-green);
        }

        .btn-warning {
            background: var(--gradient-red);
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 表单控件 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent-blue);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group .form-control {
            flex: 1;
        }

        /* 卡片布局 */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .card {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(56, 189, 248, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-blue);
            box-shadow: 0 10px 25px var(--shadow-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: var(--gradient-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--accent-blue);
        }

        /* 统计面板 */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        /* 动画效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .page-title { font-size: 1.8rem; }
            .step-guide { flex-wrap: wrap; }
            .toolbar { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .panel-actions { flex-wrap: wrap; }
            .card-grid { grid-template-columns: 1fr; }
            .stats-panel { grid-template-columns: 1fr; }
            .console-tab { padding: 8px 12px; }
        }

        /* 调试面板 */
        .debug-panel {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent-purple);
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }

        .debug-title {
            color: var(--accent-purple);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .debug-content {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
        }

        .variable-watch {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
        }

        .var-name {
            color: var(--accent-purple);
            font-weight: bold;
        }

        .var-value {
            color: var(--accent-green);
            word-break: break-all;
        }

        /* API文档面板 */
        .api-docs {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent-green);
        }

        .endpoint {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .method-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .method-get { background: #10b981; color: white; }
        .method-post { background: #3b82f6; color: white; }
        .method-put { background: #f59e0b; color: white; }
        .method-delete { background: #ef4444; color: white; }

        .endpoint-path {
            font-family: 'Fira Code', monospace;
            color: var(--text-light);
            word-break: break-all;
        }

        /* 进度条 */
        .progress-bar {
            height: 10px;
            background: var(--secondary-color);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-green);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        /* 网络模拟可视化 */
        .network-visualization {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .network-node {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .network-node.active {
            border-color: var(--accent-blue);
            background: rgba(56, 189, 248, 0.1);
        }

        .node-icon {
            font-size: 2rem;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        /* Flash消息 */
        .flash-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .flash-success {
            background: var(--gradient-green);
            color: white;
        }

        .flash-error {
            background: var(--gradient-red);
            color: white;
        }

        .flash-info {
            background: var(--gradient-blue);
            color: white;
        }

        .flash-warning {
            background: var(--gradient-purple);
            color: white;
        }

        /* 加载动画 */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(56, 189, 248, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 断点样式 */
        .breakpoint {
            color: var(--accent-red);
            cursor: pointer;
            padding: 2px;
        }

        /* 图表容器 */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
            margin-top: 15px;
        }

        /* 项目创建向导 */
        .wizard-steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .wizard-step {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        .wizard-step.active {
            border-color: var(--accent-blue);
        }

        /* OAuth授权页面 */
        .oauth-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-color);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--accent-blue);
            z-index: 2001;
            min-width: 400px;
            max-width: 90%;
        }

        .oauth-dialog h3 {
            color: var(--accent-blue);
            margin-bottom: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
        }

        /* 代码质量报告 */
        .code-quality-report {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent-yellow);
        }

        .quality-metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
        }

        /* Git模拟界面 */
        .git-commit {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-green);
        }

        /* 错误分析助手 */
        .error-assistant {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent-red);
        }

        .error-cause {
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .error-cause:hover {
            background: rgba(239, 68, 68, 0.2);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 网格背景 -->
    <div class="grid-bg"></div>

    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- 侧边栏导航 -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-code"></i> 後端模擬平台</h2>
        </div>

        <div class="sidebar-nav">
            <!-- 核心开发模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-cogs"></i> 核心開發模塊</h3>
                <div class="nav-item" onclick="navigateTo('home')">
                    <i class="fas fa-home"></i> 首頁
                </div>
                <div class="nav-item" onclick="navigateTo('code-editor')">
                    <i class="fas fa-laptop-code"></i> 代碼編輯器
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('router-manager')">
                    <i class="fas fa-route"></i> 路由管理器
                </div>
                <div class="nav-item" onclick="navigateTo('http-simulator')">
                    <i class="fas fa-exchange-alt"></i> HTTP模擬器
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('database-simulator')">
                    <i class="fas fa-database"></i> 數據庫模擬
                    <span class="badge">增強</span>
                </div>
            </div>

            <!-- 授权与安全模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-shield-alt"></i> 授權與安全</h3>
                <div class="nav-item" onclick="navigateTo('authentication')">
                    <i class="fas fa-key"></i> 身份驗證
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('authorization')">
                    <i class="fas fa-user-lock"></i> 權限管理
                </div>
                <div class="nav-item" onclick="navigateTo('ssl-simulator')">
                    <i class="fas fa-lock"></i> SSL/HTTPS模擬
                    <span class="badge">新</span>
                </div>
            </div>

            <!-- 项目开发模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-project-diagram"></i> 項目開發</h3>
                <div class="nav-item" onclick="navigateTo('project-wizard')">
                    <i class="fas fa-magic"></i> 項目嚮導
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('git-simulator')">
                    <i class="fas fa-code-branch"></i> Git模擬
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('deployment')">
                    <i class="fas fa-rocket"></i> 部署模擬
                    <span class="badge">增強</span>
                </div>
            </div>

            <!-- 测试与验证模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-vial"></i> 測試與優化</h3>
                <div class="nav-item" onclick="navigateTo('unit-testing')">
                    <i class="fas fa-flask"></i> 單元測試
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('api-testing')">
                    <i class="fas fa-bug"></i> 接口測試
                </div>
                <div class="nav-item" onclick="navigateTo('code-quality')">
                    <i class="fas fa-chart-line"></i> 代碼質量
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('error-assistant')">
                    <i class="fas fa-life-ring"></i> 錯誤助手
                    <span class="badge">新</span>
                </div>
            </div>

            <!-- 网络与集成模块 -->
            <div class="nav-section">
                <h3><i class="fas fa-network-wired"></i> 網絡與集成</h3>
                <div class="nav-item" onclick="navigateTo('dns-simulator')">
                    <i class="fas fa-globe"></i> DNS解析模擬
                </div>
                <div class="nav-item" onclick="navigateTo('third-party-api')">
                    <i class="fas fa-plug"></i> 第三方API
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('load-balancer')">
                    <i class="fas fa-balance-scale"></i> 負載均衡
                </div>
                <div class="nav-item" onclick="navigateTo('browser-simulator')">
                    <i class="fas fa-desktop"></i> 瀏覽器模擬
                    <span class="badge">新</span>
                </div>
            </div>

            <!-- 学习模式 -->
            <div class="nav-section">
                <h3><i class="fas fa-graduation-cap"></i> 學習模式</h3>
                <div class="nav-item" onclick="navigateTo('challenges')">
                    <i class="fas fa-star"></i> 任務挑戰
                    <span class="badge">新</span>
                </div>
                <div class="nav-item" onclick="navigateTo('free-mode')">
                    <i class="fas fa-lightbulb"></i> 自由模式
                </div>
                <div class="nav-item" onclick="navigateTo('practice-mode')">
                    <i class="fas fa-tasks"></i> 實作模式
                </div>
                <div class="nav-item" onclick="navigateTo('exam-mode')">
                    <i class="fas fa-file-alt"></i> 考試模式
                </div>
            </div>

            <!-- 系统状态 -->
            <div class="nav-section">
                <h3><i class="fas fa-chart-line"></i> 系統狀態</h3>
                <div class="nav-item" onclick="navigateTo('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> 儀表板
                    <span class="badge">增強</span>
                </div>
                <div class="nav-item" onclick="navigateTo('logs')">
                    <i class="fas fa-history"></i> 操作日誌
                    <span class="badge" id="log-count">0</span>
                </div>
                <div class="nav-item" onclick="navigateTo('settings')">
                    <i class="fas fa-cog"></i> 設定
                </div>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content" id="mainContent">
        <!-- Flash消息容器 -->
        <div id="flash-container"></div>

        <!-- 首页 -->
        <div class="page active" id="home" data-page="home">
            <div class="page-header">
                <h1 class="page-title">後端工程師模擬學習平台</h1>
                <p class="page-subtitle">純前端實現的完整後端開發模擬環境</p>
                
                <!-- 步骤引导 -->
                <div class="step-guide">
                    <div class="step-item completed">
                        <span>1</span> 選擇模式
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item active">
                        <span>2</span> 編寫代碼
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item">
                        <span>3</span> 測試驗證
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-item">
                        <span>4</span> 部署上線
                    </div>
                </div>
            </div>

            <!-- 统计面板 -->
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-value" id="api-count">0</div>
                    <div class="stat-label">API接口數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="success-rate">100%</div>
                    <div class="stat-label">請求成功率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-response">0ms</div>
                    <div class="stat-label">平均響應時間</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-requests">0</div>
                    <div class="stat-label">總請求數</div>
                </div>
            </div>

            <!-- 功能卡片 -->
            <div class="card-grid">
                <div class="card" onclick="navigateTo('code-editor')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <div>
                            <h3 class="card-title">智能代碼編輯器</h3>
                            <p>支援 Python/Node.js/Java，語法檢查與錯誤提示</p>
                        </div>
                    </div>
                    <p>多語言支持，實時代碼解析，語法錯誤檢測，自動補全功能</p>
                </div>

                <div class="card" onclick="navigateTo('router-manager')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-route"></i>
                        </div>
                        <div>
                            <h3 class="card-title">路由管理器</h3>
                            <p>動態路由配置，中間件管理</p>
                        </div>
                    </div>
                    <p>支援靜態/動態路由，中間件鏈配置，路由測試與驗證</p>
                </div>

                <div class="card" onclick="navigateTo('database-simulator')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div>
                            <h3 class="card-title">數據庫模擬</h3>
                            <p>MySQL/MongoDB 操作模擬</p>
                        </div>
                    </div>
                    <p>SQL查詢執行，文檔增刪改查，數據可視化展示</p>
                </div>

                <div class="card" onclick="navigateTo('authentication')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div>
                            <h3 class="card-title">授權與安全</h3>
                            <p>JWT/Session/OAuth 2.0</p>
                        </div>
                    </div>
                    <p>多種授權方案模擬，權限管理，安全配置</p>
                </div>

                <div class="card" onclick="navigateTo('project-wizard')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div>
                            <h3 class="card-title">項目嚮導</h3>
                            <p>快速創建項目，生成代碼模板</p>
                        </div>
                    </div>
                    <p>引導式項目創建，框架選擇，目錄結構生成</p>
                </div>

                <div class="card" onclick="navigateTo('deployment')">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div>
                            <h3 class="card-title">部署模擬</h3>
                            <p>CI/CD 流程模擬</p>
                        </div>
                    </div>
                    <p>自動化部署流程，環境配置，監控與日誌</p>
                </div>
            </div>
        </div>

        <!-- 代码编辑器页面 -->
        <div class="page" id="code-editor" data-page="code-editor">
            <div class="page-header">
                <h1 class="page-title">智能代碼編輯器</h1>
                <p class="page-subtitle">支援多語言，實時語法檢查，代碼調試功能</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 200px;" id="language-select" onchange="changeLanguage()">
                    <option value="python">Python (Flask)</option>
                    <option value="javascript">Node.js (Express)</option>
                    <option value="java">Java (Spring Boot)</option>
                    <option value="sql">SQL</option>
                </select>
                
                <button class="btn" onclick="runCode()" aria-label="執行選定語言的代碼">
                    <i class="fas fa-play"></i> 執行代碼
                </button>
                <button class="btn btn-success" onclick="saveCode()" aria-label="保存當前編輯的代碼">
                    <i class="fas fa-save"></i> 保存
                </button>
                <button class="btn" onclick="loadSnippet()" aria-label="加載預先定義的代碼片段">
                    <i class="fas fa-code"></i> 代碼片段
                </button>
                <button class="btn" onclick="debugCode()">
                    <i class="fas fa-bug"></i> 調試
                </button>
                <button class="btn" onclick="setBreakpoint()">
                    <i class="fas fa-circle"></i> 斷點
                </button>
                <button class="btn btn-secondary" onclick="clearConsole()">
                    <i class="fas fa-trash"></i> 清空
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-file-code"></i>
                            <span>代碼編輯器</span>
                        </div>
                        <div class="panel-actions">
                            <select class="form-control" style="width: 120px;" id="code-template">
                                <option value="">選擇模板</option>
                                <option value="flask-api">Flask API 模板</option>
                                <option value="express-api">Express API 模板</option>
                                <option value="springboot-api">Spring Boot 模板</option>
                                <option value="jwt-auth">JWT 驗證</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="code-editor-area"># 歡迎使用智能代碼編輯器
# 請選擇語言開始編寫代碼

# 示例：創建 Flask 應用
from flask import Flask, jsonify, request

app = Flask(__name__)

# 模擬數據庫
users = [
    {"id": 1, "name": "張三", "email": "zhangsan@example.com"},
    {"id": 2, "name": "李四", "email": "lisi@example.com"}
]

@app.route('/api/users', methods=['GET'])
def get_users():
    """獲取所有用戶"""
    try:
        return jsonify({
            "success": True,
            "data": users,
            "count": len(users)
        }), 200
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

@app.route('/api/users', methods=['POST'])
def create_user():
    """創建新用戶"""
    try:
        data = request.get_json()
        
        # 驗證必填字段
        if not data or 'name' not in data:
            return jsonify({
                "success": False,
                "error": "缺少必要字段: name"
            }), 400
        
        # 檢查用戶名是否已存在
        if any(u['name'] == data['name'] for u in users):
            return jsonify({
                "success": False,
                "error": "用戶名已存在"
            }), 409
        
        # 創建新用戶
        new_user = {
            "id": len(users) + 1,
            "name": data['name'],
            "email": data.get('email', ''),
            "created_at": "2024-01-01T00:00:00Z"
        }
        
        users.append(new_user)
        
        return jsonify({
            "success": True,
            "data": new_user,
            "message": "用戶創建成功"
        }), 201
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

if __name__ == '__main__':
    app.run(debug=True)</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-terminal"></i>
                            <span>控制台輸出</span>
                        </div>
                        <div class="panel-actions">
                            <div class="console-tabs">
                                <div class="console-tab active" onclick="switchConsoleTab('execution')">執行日誌</div>
                                <div class="console-tab" onclick="switchConsoleTab('request')">請求日誌</div>
                                <div class="console-tab" onclick="switchConsoleTab('error')">錯誤日誌</div>
                            </div>
                        </div>
                    </div>
                    <div class="console-content">
                        <div id="execution-log" class="console-tab-content">
                            <div class="log-entry info">
                                <div class="log-time">10:00:00</div>
                                <div class="log-message">代碼編輯器已就緒。請編寫代碼並點擊"執行代碼"按鈕。</div>
                            </div>
                        </div>
                        <div id="request-log" class="console-tab-content" style="display: none;"></div>
                        <div id="error-log" class="console-tab-content" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- 调试面板 -->
            <div class="debug-panel" id="debug-panel" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-bug"></i>
                        <span>代碼調試器</span>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="stepOver()">下一步</button>
                        <button class="btn btn-secondary" onclick="continueDebug()">繼續</button>
                        <button class="btn btn-warning" onclick="stopDebug()">停止</button>
                    </div>
                </div>
                <div class="debug-content">
                    <div class="variable-watch">
                        <div class="var-name">當前行數:</div>
                        <div class="var-value" id="current-line">0</div>
                    </div>
                    <div id="variables-watch"></div>
                </div>
            </div>
        </div>

        <!-- 路由管理器页面 -->
        <div class="page" id="router-manager" data-page="router-manager">
            <div class="page-header">
                <h1 class="page-title">路由管理器</h1>
                <p class="page-subtitle">配置和管理您的 API 路由，支持動態路由和中間件</p>
            </div>

            <div class="toolbar">
                <button class="btn" onclick="addRoute()">
                    <i class="fas fa-plus"></i> 新增路由
                </button>
                <button class="btn btn-success" onclick="saveRoutes()">
                    <i class="fas fa-save"></i> 保存配置
                </button>
                <button class="btn" onclick="testAllRoutes()">
                    <i class="fas fa-vial"></i> 測試所有路由
                </button>
                <button class="btn" onclick="generateAPIDocs()">
                    <i class="fas fa-file-alt"></i> 生成 API 文檔
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-route"></i>
                            <span>路由配置</span>
                        </div>
                    </div>
                    <div class="console-content" id="route-config-area">
                        <!-- 路由配置將在這裡動態生成 -->
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-vial"></i>
                            <span>路由測試</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-exchange-alt"></i> 測試配置
                            </label>
                            <div class="input-group">
                                <select class="form-control" id="test-method">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                                <input type="text" class="form-control" id="test-url" placeholder="/api/users">
                                <button class="btn" onclick="testRoute()">測試</button>
                            </div>
                        </div>
                        <div id="route-test-results"></div>
                    </div>
                </div>
            </div>

            <!-- API文档面板 -->
            <div class="api-docs" id="api-docs" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-file-alt"></i>
                        <span>API 文檔</span>
                    </div>
                </div>
                <div id="api-docs-content"></div>
            </div>
        </div>

        <!-- HTTP模拟器页面 -->
        <div class="page" id="http-simulator" data-page="http-simulator">
            <div class="page-header">
                <h1 class="page-title">HTTP 請求模擬器</h1>
                <p class="page-subtitle">模擬真實 HTTP 請求，支持參數驗證和錯誤處理</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 120px;" id="http-method">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                </select>
                <input type="text" class="form-control" id="http-url" placeholder="請求 URL" value="/api/users">
                <button class="btn" onclick="sendHTTPRequest()" aria-label="發送配置的 HTTP 請求">
                    <i class="fas fa-paper-plane"></i> 發送請求
                </button>
                <button class="btn" onclick="addHeader()">
                    <i class="fas fa-plus"></i> 添加請求頭
                </button>
                <button class="btn btn-secondary" onclick="clearHttpLog()">
                    <i class="fas fa-trash"></i> 清空日誌
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-cogs"></i>
                            <span>請求配置</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <!-- 请求头配置 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-heading"></i> 請求頭
                            </label>
                            <div id="http-headers">
                                <div class="input-group" style="margin-bottom: 5px;">
                                    <input type="text" class="form-control" placeholder="Header 名稱" value="Content-Type">
                                    <input type="text" class="form-control" placeholder="Header 值" value="application/json">
                                    <button class="btn btn-warning" onclick="removeHeader(this)" style="padding: 5px 10px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 请求参数 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-filter"></i> 請求參數
                            </label>
                            <div id="http-params">
                                <div class="input-group" style="margin-bottom: 5px;">
                                    <input type="text" class="form-control" placeholder="參數名">
                                    <input type="text" class="form-control" placeholder="參數值">
                                    <button class="btn btn-warning" onclick="removeParam(this)" style="padding: 5px 10px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 请求体 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-code"></i> 請求體
                            </label>
                            <textarea class="form-control" id="http-body" rows="8">{
  "name": "測試用戶",
  "email": "test@example.com",
  "active": true
}</textarea>
                        </div>

                        <!-- 网络延迟模拟 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-network-wired"></i> 網絡模擬
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="network-delay" placeholder="延遲 (ms)" value="0" min="0" max="5000">
                                <input type="number" class="form-control" id="packet-loss" placeholder="丟包率 %" value="0" min="0" max="100">
                                <button class="btn" onclick="simulateNetwork()">模擬網絡</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-exchange-alt"></i>
                            <span>請求結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="http-response-result">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">HTTP 模擬器已就緒。配置請求參數並點擊"發送請求"。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 网络可视化 -->
            <div class="network-visualization" id="network-visualization" style="display: none;">
                <div class="network-node active">
                    <div class="node-icon">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <div>客戶端</div>
                </div>
                <div class="network-node">
                    <div class="node-icon">
                        <i class="fas fa-server"></i>
                    </div>
                    <div>伺服器</div>
                </div>
                <div class="network-node">
                    <div class="node-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div>數據庫</div>
                </div>
                <div class="network-node">
                    <div class="node-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>認證服務</div>
                </div>
            </div>
        </div>

        <!-- 数据库模拟器页面 -->
        <div class="page" id="database-simulator" data-page="database-simulator">
            <div class="page-header">
                <h1 class="page-title">數據庫模擬器</h1>
                <p class="page-subtitle">模擬 MySQL 和 MongoDB 數據庫操作，支持 SQL 查詢和文檔操作</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="db-type">
                    <option value="mysql">MySQL</option>
                    <option value="mongodb">MongoDB</option>
                </select>
                <button class="btn" onclick="executeQuery()" aria-label="執行選定的數據庫查詢">
                    <i class="fas fa-play"></i> 執行查詢
                </button>
                <button class="btn btn-success" onclick="createTable()">
                    <i class="fas fa-plus"></i> 創建表/集合
                </button>
                <button class="btn" onclick="insertSampleData()">
                    <i class="fas fa-download"></i> 插入樣本數據
                </button>
                <button class="btn btn-secondary" onclick="clearDatabase()">
                    <i class="fas fa-trash"></i> 清空數據
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-database"></i>
                            <span>數據庫查詢</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="db-query" rows="10">-- MySQL 查詢示例
SELECT * FROM users;

-- MongoDB 查詢示例
db.users.find({ active: true });</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-table"></i>
                            <span>查詢結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="db-result">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">數據庫模擬器已就緒。請選擇數據庫類型並執行查詢。</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 身份验证页面 -->
        <div class="page" id="authentication" data-page="authentication">
            <div class="page-header">
                <h1 class="page-title">身份驗證模擬</h1>
                <p class="page-subtitle">模擬 JWT、Session、OAuth 2.0 等多種認證機制</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="auth-type" onchange="changeAuthType()">
                    <option value="jwt">JWT</option>
                    <option value="session">Session</option>
                    <option value="oauth">OAuth 2.0</option>
                    <option value="basic">Basic Auth</option>
                </select>
                <button class="btn" onclick="generateToken()">
                    <i class="fas fa-key"></i> 生成 Token
                </button>
                <button class="btn btn-success" onclick="validateToken()">
                    <i class="fas fa-check"></i> 驗證 Token
                </button>
                <button class="btn" onclick="simulateLogin()">
                    <i class="fas fa-sign-in-alt"></i> 模擬登入
                </button>
                <button class="btn btn-warning" onclick="simulateLogout()">
                    <i class="fas fa-sign-out-alt"></i> 模擬登出
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-cogs"></i>
                            <span>認證配置</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <!-- JWT配置 -->
                        <div id="jwt-config">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-key"></i> JWT 密鑰
                                </label>
                                <input type="text" class="form-control" id="jwt-secret" value="your-secret-key-here">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-clock"></i> 有效時間
                                </label>
                                <select class="form-control" id="jwt-expiry">
                                    <option value="1h">1 小時</option>
                                    <option value="1d">1 天</option>
                                    <option value="7d">7 天</option>
                                    <option value="30d">30 天</option>
                                </select>
                            </div>
                        </div>

                        <!-- Session配置 -->
                        <div id="session-config" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-clock"></i> Session 過期時間
                                </label>
                                <select class="form-control" id="session-expiry">
                                    <option value="900">15 分鐘</option>
                                    <option value="3600">1 小時</option>
                                    <option value="86400">1 天</option>
                                </select>
                            </div>
                        </div>

                        <!-- OAuth配置 -->
                        <div id="oauth-config" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-id-card"></i> Client ID
                                </label>
                                <input type="text" class="form-control" id="oauth-client-id" value="your-client-id">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-key"></i> Client Secret
                                </label>
                                <input type="text" class="form-control" id="oauth-client-secret" value="your-client-secret">
                            </div>
                        </div>

                        <!-- 用户数据 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-users"></i> 模擬用戶數據
                            </label>
                            <textarea class="form-control" id="user-data" rows="8">[
  {
    "id": 1,
    "username": "admin",
    "password": "admin123",
    "email": "admin@example.com",
    "role": "admin",
    "permissions": ["read", "write", "delete"]
  },
  {
    "id": 2,
    "username": "user1",
    "password": "password123",
    "email": "user1@example.com",
    "role": "user",
    "permissions": ["read", "write"]
  }
]</textarea>
                        </div>
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-vial"></i>
                            <span>認證測試</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <!-- 登录测试 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-sign-in-alt"></i> 登入測試
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="login-username" placeholder="用戶名" value="admin">
                                <input type="password" class="form-control" id="login-password" placeholder="密碼" value="admin123">
                                <button class="btn" onclick="login()">登入</button>
                            </div>
                        </div>

                        <!-- Token展示 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-key"></i> 當前 Token
                            </label>
                            <textarea class="form-control" id="current-token" rows="3" readonly></textarea>
                        </div>

                        <!-- 访问受保护资源 -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-lock"></i> 訪問受保護資源
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="protected-resource" placeholder="/api/admin" value="/api/admin">
                                <button class="btn" onclick="accessProtectedResource()">訪問</button>
                            </div>
                        </div>

                        <!-- 测试结果 -->
                        <div id="auth-test-results"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 单元测试页面 -->
        <div class="page" id="unit-testing" data-page="unit-testing">
            <div class="page-header">
                <h1 class="page-title">單元測試模擬</h1>
                <p class="page-subtitle">編寫和執行測試用例，分析代碼覆蓋率</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="test-framework">
                    <option value="jest">Jest (JavaScript)</option>
                    <option value="pytest">Pytest (Python)</option>
                    <option value="junit">JUnit (Java)</option>
                </select>
                <button class="btn" onclick="runTests()">
                    <i class="fas fa-play"></i> 執行測試
                </button>
                <button class="btn btn-success" onclick="addTestCase()">
                    <i class="fas fa-plus"></i> 新增測試用例
                </button>
                <button class="btn" onclick="generateTestReport()">
                    <i class="fas fa-file-pdf"></i> 生成報告
                </button>
                <button class="btn btn-secondary" onclick="clearTests()">
                    <i class="fas fa-trash"></i> 清空測試
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-code"></i>
                            <span>測試代碼</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="test-code" rows="10">// Jest 測試用例示例
const { add, subtract, multiply } = require('./math');

describe('數學函數測試', () => {
  test('加法測試', () => {
    expect(add(1, 2)).toBe(3);
    expect(add(-1, 1)).toBe(0);
    expect(add(0, 0)).toBe(0);
  });

  test('減法測試', () => {
    expect(subtract(5, 3)).toBe(2);
    expect(subtract(0, 5)).toBe(-5);
  });

  test('乘法測試', () => {
    expect(multiply(2, 3)).toBe(6);
    expect(multiply(0, 5)).toBe(0);
    expect(multiply(-2, 3)).toBe(-6);
  });
});

// 被測試的函數
module.exports = {
  add: (a, b) => a + b,
  subtract: (a, b) => a - b,
  multiply: (a, b) => a * b
};</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-chart-bar"></i>
                            <span>測試結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="test-results">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">單元測試模擬器已就緒。請編寫測試代碼並點擊"執行測試"。</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 项目向导页面 -->
        <div class="page" id="project-wizard" data-page="project-wizard">
            <div class="page-header">
                <h1 class="page-title">項目創建嚮導</h1>
                <p class="page-subtitle">引導式項目創建，自動生成代碼模板</p>
            </div>

            <div class="wizard-steps">
                <div class="wizard-step active" id="step1">
                    <h3><i class="fas fa-list-alt"></i> 步驟 1: 選擇項目類型</h3>
                    <div class="form-group">
                        <select class="form-control" id="project-type">
                            <option value="rest-api">RESTful API</option>
                            <option value="admin-system">後台管理系統</option>
                            <option value="microservice">微服務架構</option>
                            <option value="real-time">實時應用</option>
                        </select>
                    </div>
                    <button class="btn" onclick="nextStep(2)">下一步</button>
                </div>

                <div class="wizard-step" id="step2" style="display: none;">
                    <h3><i class="fas fa-cogs"></i> 步驟 2: 選擇框架</h3>
                    <div class="form-group">
                        <select class="form-control" id="project-framework">
                            <option value="flask">Flask (Python)</option>
                            <option value="express">Express (Node.js)</option>
                            <option value="springboot">Spring Boot (Java)</option>
                            <option value="fastapi">FastAPI (Python)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="prevStep(1)">上一步</button>
                    <button class="btn" onclick="nextStep(3)">下一步</button>
                </div>

                <div class="wizard-step" id="step3" style="display: none;">
                    <h3><i class="fas fa-folder"></i> 步驟 3: 配置目錄結構</h3>
                    <div id="directory-structure">
                        <!-- 目录结构将动态生成 -->
                    </div>
                    <button class="btn" onclick="prevStep(2)">上一步</button>
                    <button class="btn" onclick="nextStep(4)">下一步</button>
                </div>

                <div class="wizard-step" id="step4" style="display: none;">
                    <h3><i class="fas fa-check-circle"></i> 步驟 4: 完成創建</h3>
                    <div id="project-summary">
                        <!-- 项目摘要将动态生成 -->
                    </div>
                    <button class="btn" onclick="prevStep(3)">上一步</button>
                    <button class="btn btn-success" onclick="createProject()">創建項目</button>
                </div>
            </div>
        </div>

        <!-- Git模拟页面 -->
        <div class="page" id="git-simulator" data-page="git-simulator">
            <div class="page-header">
                <h1 class="page-title">Git 版本控制模擬</h1>
                <p class="page-subtitle">模擬 Git 操作，學習版本控制流程</p>
            </div>

            <div class="toolbar">
                <button class="btn" onclick="gitInit()">
                    <i class="fas fa-plus"></i> 初始化倉庫
                </button>
                <button class="btn" onclick="gitAdd()">
                    <i class="fas fa-plus-circle"></i> 添加文件
                </button>
                <button class="btn btn-success" onclick="gitCommit()">
                    <i class="fas fa-check"></i> 提交
                </button>
                <button class="btn" onclick="gitBranch()">
                    <i class="fas fa-code-branch"></i> 創建分支
                </button>
                <button class="btn" onclick="gitMerge()">
                    <i class="fas fa-code-merge"></i> 合併分支
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-code"></i>
                            <span>代碼文件</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="git-file-content" rows="10">// 代碼文件內容
function calculateTotal(items) {
  return items.reduce((sum, item) => sum + item.price, 0);
}

class User {
  constructor(name, email) {
    this.name = name;
    this.email = email;
  }
}</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-history"></i>
                            <span>Git 操作</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <div class="form-group">
                            <label class="form-label">提交信息</label>
                            <input type="text" class="form-control" id="commit-message" placeholder="輸入提交信息">
                        </div>
                        <div class="form-group">
                            <label class="form-label">分支名稱</label>
                            <input type="text" class="form-control" id="branch-name" placeholder="輸入分支名稱">
                        </div>
                        <div id="git-operations"></div>
                    </div>
                </div>
            </div>

            <!-- 提交历史 -->
            <div class="debug-panel">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-history"></i>
                        <span>提交歷史</span>
                    </div>
                </div>
                <div id="commit-history"></div>
            </div>
        </div>

        <!-- 代码质量分析页面 -->
        <div class="page" id="code-quality" data-page="code-quality">
            <div class="page-header">
                <h1 class="page-title">代碼質量分析</h1>
                <p class="page-subtitle">檢查代碼規範，提供優化建議</p>
            </div>

            <div class="toolbar">
                <button class="btn" onclick="analyzeCode()">
                    <i class="fas fa-search"></i> 分析代碼
                </button>
                <button class="btn btn-success" onclick="autoFormat()">
                    <i class="fas fa-magic"></i> 一鍵格式化
                </button>
                <button class="btn" onclick="generateQualityReport()">
                    <i class="fas fa-file-alt"></i> 生成報告
                </button>
                <button class="btn btn-secondary" onclick="clearAnalysis()">
                    <i class="fas fa-trash"></i> 清空
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-code"></i>
                            <span>待分析代碼</span>
                        </div>
                    </div>
                    <textarea class="form-control" id="code-to-analyze" rows="10">// 示例代碼（包含一些常見問題）
function processData(data){
  var result = []
  for(var i=0;i<data.length;i++){
    if(data[i].active){
      result.push(data[i])
    }
  }
  return result
}

const user = {
  name: '張三',
  age: 25,
  email: 'zhangsan@example.com'
}

console.log('用戶:', user)</textarea>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-chart-bar"></i>
                            <span>分析結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="quality-results">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">代碼質量分析器已就緒。請輸入代碼並點擊"分析代碼"。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 代码质量报告 -->
            <div class="code-quality-report" id="quality-report" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-file-alt"></i>
                        <span>代碼質量報告</span>
                    </div>
                </div>
                <div id="quality-report-content"></div>
            </div>
        </div>

        <!-- 错误分析助手页面 -->
        <div class="page" id="error-assistant" data-page="error-assistant">
            <div class="page-header">
                <h1 class="page-title">錯誤分析助手</h1>
                <p class="page-subtitle">智能分析錯誤原因，提供解決方案</p>
            </div>

            <div class="toolbar">
                <button class="btn" onclick="analyzeError()">
                    <i class="fas fa-search"></i> 分析錯誤
                </button>
                <button class="btn" onclick="clearErrorLog()">
                    <i class="fas fa-trash"></i> 清空日誌
                </button>
            </div>

            <div class="editor-container">
                <div class="code-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-bug"></i>
                            <span>錯誤信息</span>
                        </div>
                    </div>
                    <div class="console-content">
                        <div class="form-group">
                            <label class="form-label">錯誤類型</label>
                            <select class="form-control" id="error-type">
                                <option value="404">404 Not Found</option>
                                <option value="500">500 Internal Server Error</option>
                                <option value="401">401 Unauthorized</option>
                                <option value="403">403 Forbidden</option>
                                <option value="422">422 Unprocessable Entity</option>
                                <option value="syntax">語法錯誤</option>
                                <option value="runtime">運行時錯誤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">錯誤描述</label>
                            <textarea class="form-control" id="error-description" rows="6" placeholder="請描述錯誤發生的情況..."></textarea>
                        </div>
                        <button class="btn" onclick="analyzeError()">開始分析</button>
                    </div>
                </div>

                <div class="console-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-lightbulb"></i>
                            <span>分析結果</span>
                        </div>
                    </div>
                    <div class="console-content" id="error-analysis-results">
                        <div class="log-entry info">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">錯誤分析助手已就緒。請選擇錯誤類型並描述問題。</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 错误分析助手 -->
            <div class="error-assistant" id="error-suggestions" style="display: none;">
                <div class="debug-header">
                    <div class="debug-title">
                        <i class="fas fa-life-ring"></i>
                        <span>可能的解決方案</span>
                    </div>
                </div>
                <div id="error-suggestions-content"></div>
            </div>
        </div>

        <!-- 仪表板页面 -->
        <div class="page" id="dashboard" data-page="dashboard">
            <div class="page-header">
                <h1 class="page-title">系統儀表板</h1>
                <p class="page-subtitle">實時監控系統狀態和性能指標</p>
            </div>

            <div class="stats-panel">
                <div class="stat-card" role="status" aria-live="polite" aria-label="API調用總數統計">
                    <div class="stat-value" id="total-api-calls">0</div>
                    <div class="stat-label">API 調用總數</div>
                </div>
                <div class="stat-card" role="status" aria-live="polite" aria-label="成功請求數統計">
                    <div class="stat-value" id="success-count">0</div>
                    <div class="stat-label">成功請求</div>
                </div>
                <div class="stat-card" role="status" aria-live="polite" aria-label="失敗請求數統計">
                    <div class="stat-value" id="error-count">0</div>
                    <div class="stat-label">失敗請求</div>
                </div>
                <div class="stat-card" role="status" aria-live="polite" aria-label="平均延遲統計">
                    <div class="stat-value" id="avg-latency">0ms</div>
                    <div class="stat-label">平均延遲</div>
                </div>
            </div>

            <div class="card-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <h3 class="card-title">請求趨勢</h3>
                            <p>最近 24 小時 API 調用情況</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="request-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <h3 class="card-title">錯誤分析</h3>
                            <p>最近發生的錯誤統計</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="error-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div>
                            <h3 class="card-title">性能監控</h3>
                            <p>系統資源使用情況</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label>CPU 使用率</label>
                            <div class="progress-bar">
                                <div class="progress-fill" id="cpu-usage" style="width: 30%"></div>
                            </div>
                            <span id="cpu-text">30%</span>
                        </div>
                        <div class="form-group">
                            <label>內存使用率</label>
                            <div class="progress-bar">
                                <div class="progress-fill" id="memory-usage" style="width: 45%"></div>
                            </div>
                            <span id="memory-text">45%</span>
                        </div>
                        <div class="form-group">
                            <label>存儲使用率</label>
                            <div class="progress-bar">
                                <div class="progress-fill" id="storage-usage" style="width: 60%"></div>
                            </div>
                            <span id="storage-text">60%</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div>
                            <h3 class="card-title">最近活動</h3>
                            <p>最新的系統操作記錄</p>
                        </div>
                    </div>
                    <div id="recent-activities" style="margin-top: 15px;">
                        <div class="log-entry info" style="margin-bottom: 10px;">
                            <div class="log-time">10:00:00</div>
                            <div class="log-message">系統啟動成功</div>
                        </div>
                        <div class="log-entry success" style="margin-bottom: 10px;">
                            <div class="log-time">10:01:00</div>
                            <div class="log-message">用戶登入成功</div>
                        </div>
                        <div class="log-entry info">
                            <div class="log-time">10:02:00</div>
                            <div class="log-message">API 路由配置已加載</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作日志页面 -->
        <div class="page" id="logs" data-page="logs">
            <div class="page-header">
                <h1 class="page-title">操作日誌</h1>
                <p class="page-subtitle">查看系統操作記錄和事件歷史</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 150px;" id="log-level">
                    <option value="all">所有級別</option>
                    <option value="info">信息</option>
                    <option value="success">成功</option>
                    <option value="warning">警告</option>
                    <option value="error">錯誤</option>
                </select>
                <input type="text" class="form-control" id="log-search" placeholder="搜索日誌...">
                <button class="btn" onclick="filterLogs()">
                    <i class="fas fa-filter"></i> 篩選
                </button>
                <button class="btn btn-success" onclick="exportLogs()">
                    <i class="fas fa-download"></i> 導出日誌
                </button>
                <button class="btn btn-warning" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> 清空日誌
                </button>
            </div>

            <div class="console-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-history"></i>
                        <span>系統日誌</span>
                    </div>
                </div>
                <div class="console-content" id="system-logs">
                    <!-- 系统日志将在这里动态生成 -->
                </div>
            </div>
        </div>

        <!-- 挑戰系統頁面 -->
        <div class="page" id="challenges" data-page="challenges">
            <div class="page-header">
                <h1 class="page-title">任務挑戰</h1>
                <p class="page-subtitle">逐步完成後端開發挑戰，學習實際應用</p>
            </div>

            <div class="toolbar">
                <select class="form-control" style="width: 200px;" onchange="const id = parseInt(this.value); ChallengeSystem.loadChallenge(id); loadChallengeUI();">
                    <option value="1">#1 建立使用者登入 API (簡單)</option>
                    <option value="2">#2 建立資源 CRUD API (中等)</option>
                    <option value="3">#3 實現認證中間件 (困難)</option>
                </select>
                
                <button class="btn" onclick="showReferenceSolution()" aria-label="查看參考解決方案">
                    <i class="fas fa-lightbulb"></i> 參考方案
                </button>
                
                <button class="btn btn-success" onclick="compareWithReference()" aria-label="比對您的解決方案">
                    <i class="fas fa-code"></i> 比對解決方案
                </button>
                
                <button class="btn" onclick="visualizeRequestLifecycle()" aria-label="可視化請求生命週期">
                    <i class="fas fa-project-diagram"></i> 請求流程
                </button>
            </div>

            <div class="two-column-layout">
                <div class="column">
                    <div class="card">
                        <div class="card-header">
                            <h3 id="challengeTitle">挑戰標題</h3>
                            <span id="challengeDifficulty" style="color: #94a3b8;">難度: easy</span>
                        </div>
                        <div class="card-body">
                            <p id="challengeDescription">挑戰描述將在此顯示</p>
                            
                            <div style="margin-top: 15px;">
                                <strong>學習目標:</strong>
                                <ul id="challengeObjectives" style="margin: 10px 0; padding-left: 20px;">
                                    <!-- 目標將在此動態生成 -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div id="lifecycleVisualization" style="margin-top: 20px;">
                        <!-- 請求生命週期可視化將在此顯示 -->
                    </div>
                </div>
                
                <div class="column">
                    <div class="card">
                        <div class="card-header">
                            <h3>挑戰代碼</h3>
                        </div>
                        <div class="card-body">
                            <textarea id="challenge-code-area" style="width: 100%; height: 400px; background: #0f172a; color: #e2e8f0; font-family: monospace; padding: 10px; border: 1px solid #334155; border-radius: 4px;">// 在此實現挑戰
</textarea>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 15px;">
                        <div class="card-header">
                            <h3>進度</h3>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 10px;">
                                <strong>完成度:</strong>
                                <span id="progressPercentage" style="color: #38bdf8;">0/3</span>
                            </div>
                            <div style="background: #0f172a; border-radius: 4px; height: 24px; overflow: hidden;">
                                <div id="progressBar" style="background: linear-gradient(90deg, #0ea5e9, #38bdf8); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OAuth授权对话框 -->
    <div id="oauth-dialog" class="oauth-dialog" style="display: none;">
        <h3><i class="fas fa-shield-alt"></i> OAuth 2.0 授權</h3>
        <div class="form-group">
            <label class="form-label">應用名稱</label>
            <input type="text" class="form-control" id="oauth-app-name" value="後端模擬平台" readonly>
        </div>
        <div class="form-group">
            <label class="form-label">請求的權限</label>
            <div>
                <label><input type="checkbox" checked> 讀取用戶信息</label><br>
                <label><input type="checkbox" checked> 更新用戶信息</label><br>
                <label><input type="checkbox"> 刪除用戶信息</label>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">授權碼</label>
            <textarea class="form-control" id="oauth-auth-code" rows="3" readonly></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" onclick="approveOAuth()">授權</button>
            <button class="btn btn-warning" onclick="denyOAuth()">拒絕</button>
        </div>
    </div>

    <div id="overlay" class="overlay" style="display: none;"></div>

    <!-- 加载外部库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/display/autorefresh.min.js"></script>

    <script>
        // ============================================
        // 全局变量和初始化
        // ============================================
        let currentPage = 'home';
        let pageHistory = [];
        let editors = {};
        let systemLogs = [];
        let routes = [];
        let users = [];
        let isDebugging = false;
        let debugLine = 0;
        let debugVariables = {};
        let requestStats = {
            total: 0,
            success: 0,
            error: 0,
            latency: []
        };
        let breakpoints = new Set();
        let pyodide = null;
        let charts = {};
        let databaseData = {
            mysql: {
                users: [
                    { id: 1, name: '張三', email: 'zhangsan@example.com', age: 25, active: 1 },
                    { id: 2, name: '李四', email: 'lisi@example.com', age: 30, active: 1 },
                    { id: 3, name: '王五', email: 'wangwu@example.com', age: 28, active: 0 }
                ]
            },
            mongodb: {
                users: [
                    { _id: '1', name: '張三', email: 'zhangsan@example.com', age: 25, active: true },
                    { _id: '2', name: '李四', email: 'lisi@example.com', age: 30, active: true },
                    { _id: '3', name: '王五', email: 'wangwu@example.com', age: 28, active: false }
                ]
            }
        };
        let gitHistory = [];
        let currentBranch = 'main';

        // ============================================
        // 狀態管理系統
        // ============================================
        const StateManager = {
            state: {
                codeExecutions: [],
                apiRequests: [],
                databaseQueries: [],
                userAuthentications: [],
                routeTests: [],
                unitTests: [],
                performanceMetrics: { cpu: 0, memory: 0, storage: 0 }
            },
            
            addCodeExecution: function(code, output, status) {
                this.state.codeExecutions.push({
                    id: Date.now(),
                    code: code,
                    output: output,
                    status: status,
                    timestamp: new Date().toLocaleTimeString('zh-TW')
                });
                this.updateStats();
                return this.state.codeExecutions[this.state.codeExecutions.length - 1];
            },
            
            addAPIRequest: function(method, url, params, response, status) {
                const request = {
                    id: Date.now(),
                    method: method,
                    url: url,
                    params: params,
                    response: response,
                    status: status,
                    timestamp: new Date().toLocaleTimeString('zh-TW'),
                    latency: Math.random() * 500 + 50
                };
                this.state.apiRequests.push(request);
                requestStats.total++;
                if (status === 'success') requestStats.success++;
                else requestStats.error++;
                requestStats.latency.push(request.latency);
                this.updateStats();
                return request;
            },
            
            addDatabaseQuery: function(query, result, status) {
                this.state.databaseQueries.push({
                    id: Date.now(),
                    query: query,
                    result: result,
                    status: status,
                    timestamp: new Date().toLocaleTimeString('zh-TW'),
                    duration: Math.random() * 200 + 10
                });
                this.updateStats();
                return this.state.databaseQueries[this.state.databaseQueries.length - 1];
            },
            
            addUnitTest: function(testName, passed, assertions) {
                this.state.unitTests.push({
                    id: Date.now(),
                    testName: testName,
                    passed: passed,
                    assertions: assertions,
                    timestamp: new Date().toLocaleTimeString('zh-TW')
                });
                this.updateStats();
                return this.state.unitTests[this.state.unitTests.length - 1];
            },
            
            updateStats: function() {
                const totalTests = this.state.unitTests.length;
                const passedTests = this.state.unitTests.filter(t => t.passed).length;
                document.getElementById('api-count').textContent = this.state.apiRequests.length;
                document.getElementById('total-requests').textContent = requestStats.total;
                document.getElementById('success-count').textContent = requestStats.success;
                document.getElementById('error-count').textContent = requestStats.error;
                document.getElementById('test-count').textContent = `${passedTests}/${totalTests}`;
                document.getElementById('code-runs').textContent = this.state.codeExecutions.length;
            }
        };

        // ============================================
        // 虛擬 REST API 伺服器引擎
        // ============================================
        const VirtualAPIServer = {
            routes: [],
            middlewares: [],
            
            defineRoute: function(method, path, handler) {
                this.routes.push({ method: method.toUpperCase(), path, handler });
                logSystemEvent(`路由已定義: ${method.toUpperCase()} ${path}`, 'info');
            },
            
            addMiddleware: function(name, fn) {
                this.middlewares.push({ name, fn });
                logSystemEvent(`中間件已添加: ${name}`, 'info');
            },
            
            handleRequest: function(method, path, body = null, headers = {}) {
                const route = this.routes.find(r => 
                    r.method === method.toUpperCase() && 
                    this.matchPath(r.path, path)
                );
                
                if (!route) {
                    return { 
                        status: 404, 
                        body: { error: `路由 ${method} ${path} 未找到` } 
                    };
                }
                
                const request = { 
                    method, 
                    path, 
                    body: body ? JSON.parse(body) : null, 
                    headers 
                };
                const response = { status: 200, body: null };
                
                try {
                    // 執行中間件
                    for (const mw of this.middlewares) {
                        mw.fn(request, response);
                        if (response.status >= 400) return response;
                    }
                    
                    // 執行路由處理器
                    const result = route.handler(request, response);
                    response.body = result || response.body;
                    
                    return response;
                } catch (error) {
                    return { 
                        status: 500, 
                        body: { error: '伺服器內部錯誤', message: error.message } 
                    };
                }
            },
            
            matchPath: function(routePath, requestPath) {
                const routeParts = routePath.split('/').filter(p => p);
                const requestParts = requestPath.split('/').filter(p => p);
                
                if (routeParts.length !== requestParts.length) return false;
                
                return routeParts.every((part, i) => 
                    part.startsWith(':') || part === requestParts[i]
                );
            },
            
            clear: function() {
                this.routes = [];
                this.middlewares = [];
            }
        };

        // ============================================
        // 虛擬資料庫記憶體引擎
        // ============================================
        const VirtualDatabase = {
            tables: {},
            
            createTable: function(name, schema) {
                this.tables[name] = { schema, data: [] };
                logSystemEvent(`表已創建: ${name}`, 'info');
            },
            
            insert: function(tableName, record) {
                if (!this.tables[tableName]) {
                    throw new Error(`表 ${tableName} 不存在`);
                }
                record.id = record.id || Date.now();
                this.tables[tableName].data.push(record);
                return record;
            },
            
            select: function(tableName, whereClause = null) {
                if (!this.tables[tableName]) {
                    throw new Error(`表 ${tableName} 不存在`);
                }
                
                let results = this.tables[tableName].data;
                if (whereClause) {
                    results = results.filter(whereClause);
                }
                return results;
            },
            
            update: function(tableName, whereClause, updates) {
                if (!this.tables[tableName]) {
                    throw new Error(`表 ${tableName} 不存在`);
                }
                
                let count = 0;
                this.tables[tableName].data.forEach(record => {
                    if (whereClause(record)) {
                        Object.assign(record, updates);
                        count++;
                    }
                });
                return count;
            },
            
            delete: function(tableName, whereClause) {
                if (!this.tables[tableName]) {
                    throw new Error(`表 ${tableName} 不存在`);
                }
                
                const before = this.tables[tableName].data.length;
                this.tables[tableName].data = 
                    this.tables[tableName].data.filter(r => !whereClause(r));
                return before - this.tables[tableName].data.length;
            },
            
            getTableData: function(tableName) {
                return this.tables[tableName]?.data || [];
            },
            
            clear: function() {
                this.tables = {};
            }
        };

        // ============================================
        // 任務挑戰系統
        // ============================================
        const ChallengeSystem = {
            challenges: [
                {
                    id: 1,
                    title: '建立使用者登入 API',
                    difficulty: 'easy',
                    description: '實現一個 POST /login 端點，接受用戶名和密碼，返回驗證結果',
                    objectives: [
                        '定義 /login 路由',
                        '實現密碼驗證邏輯',
                        '返回成功/失敗響應'
                    ],
                    initialCode: `// 定義使用者表
db.createTable('users', ['id', 'username', 'password']);

// 定義登入路由
api.defineRoute('POST', '/login', (req, res) => {
    // 在此實現登入邏輯
});`,
                    referenceSolution: `db.createTable('users', ['id', 'username', 'password']);
db.insert('users', { username: 'admin', password: 'admin123' });

api.defineRoute('POST', '/login', (req, res) => {
    const user = db.select('users', r => r.username === req.body.username)[0];
    if (user && user.password === req.body.password) {
        return { success: true, token: 'JWT_TOKEN' };
    }
    return { success: false, error: '登入失敗' };
});`
                },
                {
                    id: 2,
                    title: '建立資源 CRUD API',
                    difficulty: 'medium',
                    description: '實現完整的產品管理 CRUD 端點：GET/POST/PUT/DELETE',
                    objectives: [
                        '建立 /products 表',
                        '實現 GET 查詢所有產品',
                        '實現 POST 新增產品',
                        '實現 PUT 更新產品',
                        '實現 DELETE 刪除產品'
                    ],
                    initialCode: `// 建立產品表與路由
// TODO: 実装 CRUD endpoints`,
                    referenceSolution: `db.createTable('products', ['id', 'name', 'price', 'stock']);

api.defineRoute('GET', '/products', (req, res) => {
    return db.select('products');
});

api.defineRoute('POST', '/products', (req, res) => {
    return db.insert('products', req.body);
});

api.defineRoute('PUT', '/products/:id', (req, res) => {
    const id = parseInt(req.path.split('/')[2]);
    db.update('products', r => r.id === id, req.body);
    return { success: true };
});

api.defineRoute('DELETE', '/products/:id', (req, res) => {
    const id = parseInt(req.path.split('/')[2]);
    const count = db.delete('products', r => r.id === id);
    return { deleted: count };
});`
                },
                {
                    id: 3,
                    title: '實現認證中間件',
                    difficulty: 'hard',
                    description: '建立一個中間件檢查 Authorization 標頭中的有效 token',
                    objectives: [
                        '建立 auth 中間件',
                        '檢查 Authorization 標頭',
                        '驗證 token 有效性',
                        '在受保護的路由中應用'
                    ],
                    initialCode: `// 實現認證中間件
// api.addMiddleware('auth', (req, res) => { ... })`,
                    referenceSolution: `api.addMiddleware('auth', (req, res) => {
    const authHeader = req.headers.authorization;
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        res.status = 401;
        return;
    }
    const token = authHeader.replace('Bearer ', '');
    // 驗證 token（簡化版）
    if (token !== 'valid_token_123') {
        res.status = 403;
    }
});

api.defineRoute('GET', '/protected', (req, res) => {
    return { message: '這是受保護的資源' };
});`
                }
            ],
            
            currentChallenge: null,
            userProgress: {},
            
            loadChallenge: function(challengeId) {
                this.currentChallenge = this.challenges.find(c => c.id === challengeId);
                if (!this.userProgress[challengeId]) {
                    this.userProgress[challengeId] = { started: false, completed: false };
                }
                return this.currentChallenge;
            },
            
            markCompleted: function(challengeId) {
                this.userProgress[challengeId].completed = true;
                logSystemEvent(`挑戰已完成: #${challengeId}`, 'success');
            },
            
            getProgress: function() {
                const completed = Object.values(this.userProgress).filter(p => p.completed).length;
                return `${completed}/${this.challenges.length}`;
            }
        };

        // ============================================
        // 請求生命週期可視化
        // ============================================
        const RequestLifecycleVisualizer = {
            stages: [
                { name: '路由匹配', duration: 10, description: '尋找相符的路由定義' },
                { name: '中間件執行', duration: 30, description: '執行所有中間件' },
                { name: '控制器處理', duration: 50, description: '執行路由處理器' },
                { name: '資料庫操作', duration: 40, description: '執行 CRUD 操作' },
                { name: '回應序列化', duration: 20, description: '準備回應體' }
            ],
            
            visualizeRequest: function(method, path) {
                const timeline = document.createElement('div');
                timeline.style.cssText = `
                    background: linear-gradient(90deg, #1e40af, #0f172a);
                    padding: 20px;
                    border-radius: 8px;
                    color: #f8fafc;
                    font-family: monospace;
                `;
                
                let html = `<div style="margin-bottom: 15px;"><strong>請求: ${method} ${path}</strong></div>`;
                let totalTime = 0;
                
                this.stages.forEach((stage, index) => {
                    totalTime += stage.duration;
                    const left = this.stages.slice(0, index).reduce((sum, s) => sum + s.duration, 0);
                    
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 0.9em; margin-bottom: 4px;">
                                ${index + 1}. ${stage.name} (${stage.duration}ms)
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 24px; position: relative; overflow: hidden;">
                                <div style="
                                    position: absolute;
                                    background: linear-gradient(90deg, #38bdf8, #0ea5e9);
                                    height: 100%;
                                    width: ${(stage.duration / 150) * 100}%;
                                    animation: slideIn 0.5s ease-out;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: #0f172a;
                                    font-size: 0.8em;
                                    font-weight: bold;
                                " title="${stage.description}">${stage.duration}ms</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); text-align: right;"><strong>總耗時: ${totalTime}ms</strong></div>`;
                
                timeline.innerHTML = html;
                return timeline;
            }
        };

        // ============================================
        // 解決方案比對系統
        // ============================================
        const SolutionComparison = {
            compareCode: function(userCode, referenceCode) {
                const userLines = userCode.split('\\n');
                const refLines = referenceCode.split('\\n');
                
                const comparison = {
                    identical: userCode.trim() === referenceCode.trim(),
                    userLineCount: userLines.length,
                    referenceLineCount: refLines.length,
                    similarities: this.calculateSimilarity(userCode, referenceCode),
                    suggestions: []
                };
                
                if (!comparison.identical) {
                    if (comparison.userLineCount < comparison.referenceLineCount) {
                        comparison.suggestions.push('您的程式碼可能缺少某些功能，請參考參考方案中的實現');
                    }
                    
                    if (!userCode.includes('middleware') && referenceCode.includes('middleware')) {
                        comparison.suggestions.push('建議添加中間件邏輯');
                    }
                    
                    if (!userCode.includes('error') && referenceCode.includes('error')) {
                        comparison.suggestions.push('記得添加錯誤處理機制');
                    }
                }
                
                return comparison;
            },
            
            calculateSimilarity: function(code1, code2) {
                // 簡單的相似度計算（字符比對）
                let matches = 0;
                const minLen = Math.min(code1.length, code2.length);
                
                for (let i = 0; i < minLen; i++) {
                    if (code1[i] === code2[i]) matches++;
                }
                
                return Math.round((matches / Math.max(code1.length, code2.length)) * 100);
            },
            
            generateReport: function(challengeId, userCode) {
                const challenge = ChallengeSystem.challenges.find(c => c.id === challengeId);
                if (!challenge) return null;
                
                const comparison = this.compareCode(userCode, challenge.referenceSolution);
                
                return {
                    challengeTitle: challenge.title,
                    completed: comparison.identical,
                    similarity: comparison.similarities,
                    feedback: {
                        positive: comparison.similarities >= 80 ? '很好的嘗試！您的方案接近參考解決方案。' : '繼續努力',
                        suggestions: comparison.suggestions,
                        keyPoints: [
                            '檢查路由定義是否正確',
                            '驗證中間件邏輯',
                            '確保錯誤處理完整',
                            '測試所有邊界情況'
                        ]
                    }
                };
            }
        };

        // ============================================
        // 初始化函数
        // ============================================
        function sendHTTPRequest() {
            const method = document.getElementById('http-method').value;
            const url = document.getElementById('http-url').value;
            const requestBody = document.getElementById('http-body')?.value || '{}';
            
            if (!url.trim()) {
                showFlash('請輸入請求 URL', 'warning');
                return;
            }
            
            logSystemEvent(`發送 ${method} 請求: ${url}`, 'info');
            showFlash('正在發送請求...', 'info');
            
            try {
                setTimeout(() => {
                    let response;
                    const status = Math.random() > 0.1 ? 'success' : 'error';
                    
                    if (status === 'success') {
                        response = {
                            status: 200,
                            statusText: 'OK',
                            data: {
                                message: `${method} ${url} 執行成功`,
                                timestamp: new Date().toISOString(),
                                requestID: 'REQ-' + Date.now()
                            }
                        };
                    } else {
                        response = {
                            status: 500,
                            statusText: 'Internal Server Error',
                            error: '服務器內部錯誤'
                        };
                    }
                    
                    const result = StateManager.addAPIRequest(method, url, requestBody, JSON.stringify(response, null, 2), status);
                    displayHTTPResponse(response, result);
                    showFlash(`請求完成: ${response.status} ${response.statusText}`, status === 'success' ? 'success' : 'error');
                    logSystemEvent(`${method} ${url} 完成，耗時: ${result.latency.toFixed(0)}ms`, status);
                }, 500 + Math.random() * 1000);
                
            } catch (error) {
                showFlash('請求發送失敗: ' + error.message, 'error');
                logSystemEvent(`API 請求錯誤: ${error.message}`, 'error');
            }
        }
        
        function displayHTTPResponse(response, requestRecord) {
            const resultsDiv = document.getElementById('http-response-result');
            if (!resultsDiv) return;
            
            const statusClass = response.status >= 200 && response.status < 300 ? 'success' : 'error';
            resultsDiv.innerHTML = `<div class="log-entry ${statusClass}"><div class="log-time">${requestRecord.timestamp}</div><div class="log-message"><div><strong>狀態碼:</strong> ${response.status} ${response.statusText}</div><div><strong>延遲:</strong> ${requestRecord.latency.toFixed(0)}ms</div><div><strong>回應內容:</strong></div><pre>${typeof response.data === 'object' ? JSON.stringify(response.data, null, 2) : response.error}</pre></div></div>`;
        }
        
        function executeQuery() {
            const dbType = document.getElementById('db-type').value;
            const query = document.getElementById('db-query').value;
            
            if (!query.trim()) {
                showFlash('請輸入查詢語句', 'warning');
                return;
            }
            
            logSystemEvent(`執行 ${dbType.toUpperCase()} 查詢`, 'info');
            showFlash('正在執行查詢...', 'info');
            
            setTimeout(() => {
                let result;
                if (dbType === 'mysql') {
                    result = executeMySQLQuery(query);
                } else if (dbType === 'mongodb') {
                    result = executeMongoDBQuery(query);
                }
                
                const dbRecord = StateManager.addDatabaseQuery(query, result.output, result.success ? 'success' : 'error');
                displayQueryResult(result, dbRecord);
                showFlash(`查詢完成，耗時: ${result.duration}ms`, result.success ? 'success' : 'error');
                logSystemEvent(`數據庫查詢完成 (${dbRecord.duration.toFixed(0)}ms)`, result.success ? 'success' : 'error');
            }, 300 + Math.random() * 500);
        }
        
        function executeMySQLQuery(query) {
            const data = databaseData.mysql;
            let output = '';
            
            if (query.toLowerCase().includes('select * from users')) {
                output = formatTableOutput(data.users, ['id', 'name', 'email', 'age', 'active']);
            } else if (query.toLowerCase().includes('select')) {
                output = '查詢返回 ' + data.users.length + ' 行數據';
            } else if (query.toLowerCase().includes('insert')) {
                output = '插入成功，影響 1 行';
            } else if (query.toLowerCase().includes('update')) {
                output = '更新成功，影響 ' + Math.floor(Math.random() * 3 + 1) + ' 行';
            } else {
                output = '查詢執行成功';
            }
            
            return { success: true, output: output, duration: Math.random() * 200 + 50 };
        }
        
        function executeMongoDBQuery(query) {
            const data = databaseData.mongodb;
            let output = '';
            
            if (query.includes('find')) {
                output = JSON.stringify(data.users, null, 2);
            } else if (query.includes('insertOne')) {
                output = '{ acknowledged: true, insertedId: ObjectId(...) }';
            } else if (query.includes('updateOne')) {
                output = '{ acknowledged: true, modifiedCount: 1 }';
            } else {
                output = JSON.stringify(data.users, null, 2);
            }
            
            return { success: true, output: output, duration: Math.random() * 150 + 50 };
        }
        
        function formatTableOutput(data, columns) {
            const header = columns.map(c => c.padEnd(15)).join(' | ');
            const separator = '-'.repeat(header.length);
            const rows = data.map(row => columns.map(col => String(row[col] || '').padEnd(15)).join(' | '));
            return header + '\\n' + separator + '\\n' + rows.join('\\n');
        }
        
        function displayQueryResult(result, dbRecord) {
            const resultsDiv = document.getElementById('db-result');
            if (!resultsDiv) return;
            
            resultsDiv.innerHTML = `<div class="log-entry ${result.success ? 'success' : 'error'}"><div class="log-time">${dbRecord.timestamp}</div><div class="log-message"><div><strong>執行耗時:</strong> ${dbRecord.duration.toFixed(0)}ms</div><div><strong>結果:</strong></div><pre>${result.output}</pre></div></div>`;
        }

        // ============================================
        // 任務挑戰系統 UI 函數
        // ============================================
        function loadChallengeUI() {
            const challenge = ChallengeSystem.currentChallenge;
            if (!challenge) return;
            
            const titleEl = document.getElementById('challengeTitle');
            const diffEl = document.getElementById('challengeDifficulty');
            const descEl = document.getElementById('challengeDescription');
            const objEl = document.getElementById('challengeObjectives');
            
            if (titleEl) titleEl.textContent = challenge.title;
            if (diffEl) diffEl.textContent = '難度: ' + challenge.difficulty;
            if (descEl) descEl.textContent = challenge.description;
            
            if (objEl) {
                objEl.innerHTML = challenge.objectives.map(obj => 
                    '<li style="margin: 5px 0; color: #94a3b8;">' + obj + '</li>'
                ).join('');
            }
            
            if (editors.challenge) {
                editors.challenge.setValue(challenge.initialCode);
            }
            
            logSystemEvent('已加載挑戰: ' + challenge.title, 'info');
        }

        function showReferenceSolution() {
            const challenge = ChallengeSystem.currentChallenge;
            if (!challenge) {
                showFlash('請先選擇一個挑戰', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            modal.innerHTML = '<div style="background: #1e293b; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; color: #e2e8f0;"><h3 style="margin-top: 0; color: #38bdf8;">參考解決方案</h3><pre style="background: #0f172a; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 0.9em;">' + challenge.referenceSolution + '</pre><button onclick="this.parentElement.parentElement.remove()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 15px;">關閉</button></div>';
            
            document.body.appendChild(modal);
        }

        function compareWithReference() {
            const challenge = ChallengeSystem.currentChallenge;
            if (!challenge) {
                showFlash('請先選擇一個挑戰', 'warning');
                return;
            }
            
            const userCode = (editors.challenge && editors.challenge.getValue) ? editors.challenge.getValue() : '';
            const report = SolutionComparison.generateReport(challenge.id, userCode);
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            const similarityColor = report.similarity >= 80 ? '#10b981' : (report.similarity >= 50 ? '#f59e0b' : '#ef4444');
            
            let suggestionsHTML = '<ul style="margin: 10px 0; padding-left: 20px;">';
            if (report.feedback.suggestions.length > 0) {
                suggestionsHTML += report.feedback.suggestions.map(s => '<li>' + s + '</li>').join('');
            } else {
                suggestionsHTML += '<li>您的實現已經很接近參考方案！</li>';
            }
            suggestionsHTML += '</ul>';
            
            const keyPointsHTML = '<ul style="margin: 10px 0; padding-left: 20px;">' + 
                report.feedback.keyPoints.map(p => '<li>' + p + '</li>').join('') + 
                '</ul>';
            
            modal.innerHTML = '<div style="background: #1e293b; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; color: #e2e8f0;"><h3 style="margin-top: 0; color: #38bdf8;">' + report.challengeTitle + ' - 評估報告</h3><div style="background: #0f172a; padding: 15px; border-radius: 4px; margin-bottom: 15px;"><div style="margin-bottom: 10px;"><strong>相似度: <span style="color: ' + similarityColor + ';">' + report.similarity + '%</span></strong></div><div style="margin-bottom: 10px;"><strong>狀態: ' + (report.completed ? '<span style="color: #10b981;">✓ 完成</span>' : '<span style="color: #f59e0b;">○ 進行中</span>') + '</strong></div></div><div style="background: #0f172a; padding: 15px; border-radius: 4px; margin-bottom: 15px;"><strong style="color: #38bdf8;">反饋:</strong><p style="margin: 10px 0 0 0;">' + report.feedback.positive + '</p></div><div style="background: #0f172a; padding: 15px; border-radius: 4px; margin-bottom: 15px;"><strong style="color: #38bdf8;">建議:</strong>' + suggestionsHTML + '</div><div style="background: #0f172a; padding: 15px; border-radius: 4px; margin-bottom: 15px;"><strong style="color: #38bdf8;">關鍵要點:</strong>' + keyPointsHTML + '</div><button onclick="this.parentElement.parentElement.remove()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">關閉</button></div>';
            
            document.body.appendChild(modal);
            logSystemEvent('已執行程式碼比對: 相似度 ' + report.similarity + '%', 'info');
        }

        // ============================================
        // API 伺服器管理函數
        // ============================================
        function setupAPIServer() {
            // 建立預設路由
            VirtualAPIServer.defineRoute('GET', '/api/users', function(req, res) {
                return VirtualDatabase.select('users');
            });
            
            VirtualAPIServer.defineRoute('POST', '/api/users', function(req, res) {
                return VirtualDatabase.insert('users', req.body);
            });
            
            // 建立預設資料表
            VirtualDatabase.createTable('users', ['id', 'name', 'email', 'role']);
            VirtualDatabase.insert('users', { id: 1, name: '管理員', email: 'admin@example.com', role: 'admin' });
            VirtualDatabase.insert('users', { id: 2, name: '用戶', email: 'user@example.com', role: 'user' });
            
            showFlash('API 伺服器已啟動', 'success');
            logSystemEvent('虛擬 API 伺服器已初始化', 'info');
        }

        function visualizeRequestLifecycle() {
            const method = (document.getElementById('httpMethod') && document.getElementById('httpMethod').value) || 'GET';
            const url = (document.getElementById('httpUrl') && document.getElementById('httpUrl').value) || '/api/users';
            
            const visualization = RequestLifecycleVisualizer.visualizeRequest(method, url);
            
            const container = document.getElementById('lifecycleVisualization') || document.getElementById('lifecycleContainer');
            
            if (container) {
                container.innerHTML = '';
                container.appendChild(visualization);
            }
            
            logSystemEvent('已可視化請求生命週期: ' + method + ' ' + url, 'info');
        }

        // 初始化函数
        async function init() {
            // 初始化 CodeMirror 编辑器
            editors.code = CodeMirror.fromTextArea(document.getElementById('code-editor-area'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                lineWrapping: true,
                lint: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers", "breakpoints"],
                autoRefresh: true
            });

            // 初始化挑戰編輯器
            editors.challenge = CodeMirror.fromTextArea(document.getElementById('challenge-code-area'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                lineWrapping: true,
                autoRefresh: true
            });

            // 初始化Pyodide
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
                });
                await pyodide.loadPackage(["micropip"]);
                console.log("Pyodide loaded successfully");
            } catch (error) {
                console.warn("Pyodide failed to load, falling back to simulation mode:", error);
            }

            // 加载保存的数据
            loadSavedData();
            
            // 初始化系统日志
            initSystemLogs();
            
            // 初始化路由
            initRoutes();
            
            // 初始化 API 伺服器
            setupAPIServer();
            
            // 初始化挑戰系統
            ChallengeSystem.loadChallenge(1);
            
            // 初始化用户数据
            initUsers();
            
            // 初始化统计信息
            updateStats();
            
            // 设置移动端适配
            setupMobile();
            
            // 初始化图表
            initCharts();
            
            // 显示欢迎消息
            showFlash('歡迎使用後端學習模擬平台！', 'info');
            logSystemEvent('系統初始化完成', 'info');
            
            // 点击主内容区关闭侧边栏
            document.getElementById('mainContent').addEventListener('click', function() {
                if (window.innerWidth <= 1024) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                        this.classList.remove('sidebar-open');
                    }
                }
            });
        }

        // ============================================
        // 导航功能
        // ============================================
        function navigateTo(pageId) {
            // 保存当前页面数据
            savePageData();
            
            const targetPage = document.getElementById(pageId);
            if (!targetPage) return;

            // 保存当前页面到历史记录
            if (currentPage !== pageId) {
                pageHistory.push(currentPage);
                logSystemEvent(`切換到頁面: ${pageId}`, 'info');
            }

            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // 显示目标页面
            targetPage.classList.add('active');
            currentPage = pageId;

            // 更新导航项状态
            updateNavItems();

            // 如果是移动端，关闭侧边栏
            if (window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('mainContent').classList.remove('sidebar-open');
            }

            // 加载页面数据
            loadPageData();
        }

        function savePageData() {
            if (currentPage === 'code-editor' && editors.code) {
                localStorage.setItem('editor-content', editors.code.getValue());
            }
            if (currentPage === 'router-manager') {
                localStorage.setItem('routes', JSON.stringify(routes));
            }
        }

        function loadPageData() {
            if (currentPage === 'code-editor' && editors.code) {
                const savedContent = localStorage.getItem('editor-content');
                if (savedContent) {
                    editors.code.setValue(savedContent);
                }
            }
            if (currentPage === 'router-manager') {
                updateRoutesDisplay();
            }
            if (currentPage === 'dashboard') {
                updateCharts();
            }
        }

        function goBack() {
            if (pageHistory.length > 0) {
                const prevPage = pageHistory.pop();
                navigateTo(prevPage);
            } else {
                navigateTo('home');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
            document.getElementById('mainContent').classList.toggle('sidebar-open');
        }

        function updateNavItems() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.onclick && item.onclick.toString().includes(`'${currentPage}'`)) {
                    item.classList.add('active');
                }
            });
        }

        function setupMobile() {
            window.addEventListener('resize', () => {
                if (window.innerWidth > 1024) {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('mainContent').classList.remove('sidebar-open');
                }
            });
        }

        // ============================================
        // 系统日志功能
        // ============================================
        function initSystemLogs() {
            systemLogs = JSON.parse(localStorage.getItem('system-logs') || '[]');
            if (systemLogs.length === 0) {
                systemLogs.push({
                    time: new Date().toLocaleTimeString(),
                    message: '系統啟動',
                    level: 'info'
                });
            }
            updateLogsDisplay();
        }

        function logSystemEvent(message, level = 'info') {
            const logEntry = {
                time: new Date().toLocaleTimeString(),
                message: message,
                level: level
            };
            systemLogs.unshift(logEntry);
            
            // 限制日志数量
            if (systemLogs.length > 100) {
                systemLogs.pop();
            }
            
            localStorage.setItem('system-logs', JSON.stringify(systemLogs));
            updateLogsDisplay();
            
            // 更新仪表板显示
            if (currentPage === 'logs') {
                addLogToDisplay(logEntry);
            }
        }

        function updateLogsDisplay() {
            const logCount = document.getElementById('log-count');
            if (logCount) {
                logCount.textContent = systemLogs.length;
            }
            
            if (currentPage === 'logs') {
                const logsContainer = document.getElementById('system-logs');
                logsContainer.innerHTML = '';
                systemLogs.forEach(log => {
                    addLogToDisplay(log);
                });
            }
        }

        function addLogToDisplay(log) {
            const logsContainer = document.getElementById('system-logs');
            if (!logsContainer) return;
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${log.level}`;
            logEntry.innerHTML = `
                <div class="log-time">${log.time}</div>
                <div class="log-message">${log.message}</div>
            `;
            logsContainer.appendChild(logEntry);
        }

        function filterLogs() {
            const level = document.getElementById('log-level').value;
            const search = document.getElementById('log-search').value.toLowerCase();
            
            const filteredLogs = systemLogs.filter(log => {
                const matchesLevel = level === 'all' || log.level === level;
                const matchesSearch = !search || log.message.toLowerCase().includes(search);
                return matchesLevel && matchesSearch;
            });
            
            const logsContainer = document.getElementById('system-logs');
            logsContainer.innerHTML = '';
            filteredLogs.forEach(log => {
                addLogToDisplay(log);
            });
        }

        function exportLogs() {
            const logText = systemLogs.map(log => 
                `[${log.time}] [${log.level.toUpperCase()}] ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showFlash('日誌已導出', 'success');
        }

        function clearLogs() {
            if (confirm('確定要清空所有日誌嗎？此操作不可恢復。')) {
                systemLogs = [{
                    time: new Date().toLocaleTimeString(),
                    message: '日誌已清空',
                    level: 'info'
                }];
                localStorage.setItem('system-logs', JSON.stringify(systemLogs));
                updateLogsDisplay();
                showFlash('日誌已清空', 'success');
            }
        }

        // ============================================
        // Flash消息功能
        // ============================================
        function showFlash(message, type = 'info') {
            const container = document.getElementById('flash-container');
            const flash = document.createElement('div');
            flash.className = `flash-message flash-${type}`;
            flash.innerHTML = `
                <i class="fas fa-${getFlashIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(flash);
            
            setTimeout(() => {
                flash.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (flash.parentNode) {
                        flash.parentNode.removeChild(flash);
                    }
                }, 300);
            }, 3000);
        }

        function getFlashIcon(type) {
            const icons = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // ============================================
        // 代码编辑器功能（增强版）
        // ============================================
        function changeLanguage() {
            const lang = document.getElementById('language-select').value;
            const modes = {
                'python': 'python',
                'javascript': 'javascript',
                'java': 'text/x-java',
                'sql': 'sql'
            };
            
            if (modes[lang]) {
                editors.code.setOption('mode', modes[lang]);
                showFlash(`已切換到 ${lang} 語言模式`, 'info');
                logSystemEvent(`切換代碼語言: ${lang}`, 'info');
                
                // 重置断点
                breakpoints.clear();
                updateBreakpointsDisplay();
            }
        }

        async function runCode() {
            const code = editors.code.getValue();
            const language = document.getElementById('language-select').value;
            
            if (!code.trim()) {
                showFlash('請輸入代碼', 'warning');
                return;
            }
            
            logSystemEvent('開始執行代碼', 'info');
            showFlash('代碼執行中...', 'info');
            
            try {
                let result;
                if (language === 'python' && pyodide) {
                    result = await executePythonCode(code);
                } else if (language === 'javascript') {
                    result = executeJavaScriptCode(code);
                } else if (language === 'java') {
                    result = simulateJavaExecution(code);
                } else if (language === 'nodejs') {
                    result = simulateNodeJSExecution(code);
                } else {
                    result = simulateCodeExecution(code, language);
                }
                
                // 使用 StateManager 記錄執行
                StateManager.addCodeExecution(code, result.output, result.success ? 'success' : 'error');
                
                if (result.success) {
                    addConsoleLog('代碼執行成功', 'success', result.output);
                    showFlash('代碼執行成功！', 'success');
                    logSystemEvent('代碼執行完成，耗時：' + (result.executionTime || '未知'), 'success');
                } else {
                    addConsoleLog('代碼執行失敗', 'error', result.error);
                    showFlash('代碼執行失敗：' + result.error, 'error');
                    logSystemEvent(`代碼執行錯誤: ${result.error}`, 'error');
                }
                
                updateStats();
            } catch (error) {
                addConsoleLog('代碼執行異常', 'error', error.message);
                showFlash('代碼執行異常', 'error');
                logSystemEvent(`代碼執行異常: ${error.message}`, 'error');
                
                requestStats.error++;
                requestStats.total++;
                updateStats();
            }
        }
        
        function simulateJavaExecution(code) {
            // 模擬 Java 執行
            try {
                // 提取 main 方法或類名
                const className = code.match(/public class (\w+)/)?.[1] || 'Main';
                const hasMain = code.includes('public static void main');
                
                if (!hasMain) {
                    return { 
                        success: false, 
                        error: `Java 類 "${className}" 缺少 main 方法` 
                    };
                }
                
                // 模擬輸出
                const output = `編譯 ${className}.java 成功\\n[${new Date().toLocaleTimeString('zh-TW')}] 執行 ${className}.main()\\n\\n動作執行完成（模擬模式）`;
                
                return {
                    success: true,
                    output: output,
                    executionTime: Math.random() * 200 + 100 + 'ms'
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        function simulateNodeJSExecution(code) {
            // 模擬 Node.js 執行
            try {
                const output = [];
                // 簡單的評估
                if (code.includes('console.log')) {
                    const logMatches = code.match(/console\.log\((.*?)\)/g);
                    if (logMatches) {
                        logMatches.forEach(match => {
                            output.push(match.replace(/console\.log\((.*?)\)/, '$1').replace(/['"]/g, ''));
                        });
                    }
                } else {
                    output.push('Node.js 應用執行完成（模擬模式）');
                }
                
                return {
                    success: true,
                    output: output.join('\\n') || '執行完成',
                    executionTime: Math.random() * 150 + 50 + 'ms'
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function executePythonCode(code) {
            try {
                // 清理输出
                const output = [];
                const originalStdout = pyodide.runPython(`
                    import sys
                    class StringIO:
                        def __init__(self):
                            self.value = ''
                        def write(self, text):
                            self.value += text
                        def getvalue(self):
                            return self.value
                    sys.stdout = StringIO()
                    sys.stderr = StringIO()
                `);
                
                // 执行代码
                await pyodide.runPythonAsync(code);
                
                // 获取输出
                const stdout = pyodide.runPython('sys.stdout.getvalue()');
                const stderr = pyodide.runPython('sys.stderr.getvalue()');
                
                if (stderr) {
                    return { success: false, error: stderr };
                }
                
                return { 
                    success: true, 
                    output: stdout || '代碼執行完成（無輸出）',
                    executionTime: '50ms'
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function executeJavaScriptCode(code) {
            try {
                // 安全执行JavaScript
                const output = [];
                const originalConsoleLog = console.log;
                console.log = function(...args) {
                    output.push(args.join(' '));
                };
                
                // 尝试执行代码
                eval(code);
                
                console.log = originalConsoleLog;
                
                return { 
                    success: true, 
                    output: output.join('\n') || '代碼執行完成（無輸出）',
                    executionTime: '30ms'
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function simulateCodeExecution(code, language) {
            // 语法检查
            const syntaxErrors = checkSyntax(code, language);
            if (syntaxErrors.length > 0) {
                return {
                    success: false,
                    error: `語法錯誤:\n${syntaxErrors.join('\n')}`
                };
            }
            
            // 检查常见错误模式
            const errorPatterns = {
                'python': [
                    { pattern: /^[ \t]*def\s+\w+\([^)]*\):$/gm, message: '函數定義缺少冒號' },
                    { pattern: /^[ \t]*if\s+.*:$/gm, message: 'if語句缺少冒號' },
                    { pattern: /^[ \t]*for\s+.*:$/gm, message: 'for循環缺少冒號' },
                    { pattern: /^[ \t]*while\s+.*:$/gm, message: 'while循環缺少冒號' }
                ],
                'javascript': [
                    { pattern: /function\s+\w+\([^)]*\)\s*\{/g, message: '函數定義缺少大括號' },
                    { pattern: /if\s*\([^)]*\)\s*\{/g, message: 'if語句缺少大括號' },
                    { pattern: /for\s*\([^)]*\)\s*\{/g, message: 'for循環缺少大括號' },
                    { pattern: /while\s*\([^)]*\)\s*\{/g, message: 'while循環缺少大括號' }
                ]
            };
            
            if (errorPatterns[language]) {
                for (const pattern of errorPatterns[language]) {
                    if (!pattern.pattern.test(code)) {
                        return {
                            success: false,
                            error: pattern.message
                        };
                    }
                }
            }
            
            return {
                success: true,
                output: `代碼語法檢查通過\n語言: ${language}\n執行時間: 25ms`,
                executionTime: '25ms'
            };
        }

        function checkSyntax(code, language) {
            const errors = [];
            
            if (language === 'python') {
                // 检查Python语法
                if (code.includes('print ') && !code.includes('print(')) {
                    errors.push('Python 3 中使用 print() 而不是 print');
                }
                
                // 检查缩进
                const lines = code.split('\n');
                let indentLevel = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;
                    
                    if (line.endsWith(':')) {
                        indentLevel++;
                    } else if (line.startsWith('return') || line.startsWith('break') || line.startsWith('continue') || line.startsWith('pass')) {
                        indentLevel--;
                    }
                    
                    if (indentLevel < 0) {
                        errors.push(`第 ${i + 1} 行: 縮進錯誤`);
                        indentLevel = 0;
                    }
                }
            }
            
            return errors;
        }

        function setBreakpoint() {
            const cursor = editors.code.getCursor();
            const line = cursor.line + 1;
            
            if (breakpoints.has(line)) {
                breakpoints.delete(line);
                showFlash(`已移除第 ${line} 行的斷點`, 'info');
            } else {
                breakpoints.add(line);
                showFlash(`已在第 ${line} 行設置斷點`, 'info');
            }
            
            updateBreakpointsDisplay();
        }

        function updateBreakpointsDisplay() {
            const gutters = editors.code.getGutterElement();
            let breakpointGutter = gutters.querySelector('.breakpoints-gutter');
            
            if (!breakpointGutter) {
                breakpointGutter = document.createElement('div');
                breakpointGutter.className = 'breakpoints-gutter';
                gutters.appendChild(breakpointGutter);
            }
            
            breakpointGutter.innerHTML = '';
            breakpoints.forEach(line => {
                const marker = document.createElement('div');
                marker.className = 'breakpoint';
                marker.innerHTML = '●';
                marker.style.lineHeight = '18px';
                marker.style.textAlign = 'center';
                marker.style.cursor = 'pointer';
                marker.onclick = function() {
                    breakpoints.delete(line);
                    updateBreakpointsDisplay();
                };
                breakpointGutter.appendChild(marker);
            });
        }

        function debugCode() {
            isDebugging = true;
            debugLine = 0;
            debugVariables = {};
            
            document.getElementById('debug-panel').style.display = 'block';
            showFlash('調試模式已啟動', 'info');
            logSystemEvent('進入調試模式', 'info');
            
            // 开始调试
            stepDebug();
        }

        function stepDebug() {
            if (!isDebugging) return;
            
            debugLine++;
            const code = editors.code.getValue();
            const lines = code.split('\n');
            
            // 检查断点
            if (breakpoints.has(debugLine)) {
                showFlash(`在第 ${debugLine} 行遇到斷點`, 'warning');
                logSystemEvent(`調試器在斷點暫停: 第 ${debugLine} 行`, 'info');
                return; // 暂停在断点
            }
            
            if (debugLine >= lines.length) {
                stopDebug();
                return;
            }
            
            // 更新当前行显示
            document.getElementById('current-line').textContent = debugLine;
            
            // 分析当前行的变量
            const currentLine = lines[debugLine - 1];
            const varMatch = currentLine.match(/(\w+)\s*=\s*([^#]+)/);
            
            if (varMatch) {
                const varName = varMatch[1];
                let varValue = varMatch[2].trim();
                
                // 尝试计算表达式
                try {
                    if (!isNaN(eval(varValue))) {
                        varValue = eval(varValue);
                    }
                } catch (e) {
                    // 如果不能计算，保持原样
                }
                
                debugVariables[varName] = varValue;
            }
            
            // 更新变量监视
            updateDebugVariables();
            
            // 继续下一步
            setTimeout(stepDebug, 1000);
        }

        function updateDebugVariables() {
            const varsContainer = document.getElementById('variables-watch');
            varsContainer.innerHTML = '';
            
            Object.keys(debugVariables).forEach(key => {
                const varDiv = document.createElement('div');
                varDiv.className = 'variable-watch';
                varDiv.innerHTML = `
                    <div class="var-name">${key}:</div>
                    <div class="var-value">${debugVariables[key]}</div>
                `;
                varsContainer.appendChild(varDiv);
            });
        }

        function stepOver() {
            stepDebug();
        }

        function continueDebug() {
            isDebugging = false;
            // 继续执行直到下一个断点或结束
            const code = editors.code.getValue();
            const lines = code.split('\n');
            
            while (debugLine < lines.length) {
                debugLine++;
                if (breakpoints.has(debugLine)) {
                    isDebugging = true;
                    document.getElementById('current-line').textContent = debugLine;
                    showFlash(`在第 ${debugLine} 行遇到斷點`, 'warning');
                    return;
                }
            }
            
            stopDebug();
        }

        function stopDebug() {
            isDebugging = false;
            document.getElementById('debug-panel').style.display = 'none';
            showFlash('調試完成', 'success');
            logSystemEvent('調試模式結束', 'info');
        }

        function saveCode() {
            const code = editors.code.getValue();
            localStorage.setItem('saved-code', code);
            showFlash('代碼已保存', 'success');
            logSystemEvent('代碼保存成功', 'success');
        }

        function loadSnippet() {
            const template = document.getElementById('code-template').value;
            const snippets = {
                'flask-api': `from flask import Flask, jsonify, request
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

@app.route('/api/health', methods=['GET'])
def health_check():
    return jsonify({
        "status": "healthy",
        "timestamp": "2024-01-01T00:00:00Z"
    }), 200

@app.route('/api/users', methods=['GET'])
def get_users():
    users = [
        {"id": 1, "name": "張三", "email": "zhangsan@example.com"},
        {"id": 2, "name": "李四", "email": "lisi@example.com"}
    ]
    return jsonify(users), 200

@app.route('/api/users', methods=['POST'])
def create_user():
    data = request.get_json()
    if not data or 'name' not in data:
        return jsonify({"error": "缺少必要字段"}), 400
    
    new_user = {
        "id": 3,
        "name": data['name'],
        "email": data.get('email', '')
    }
    return jsonify(new_user), 201

if __name__ == '__main__':
    app.run(debug=True)`,
                'jwt-auth': `const jwt = require('jsonwebtoken');
const express = require('express');
const app = express();

const SECRET_KEY = 'your-secret-key';

// 登入接口
app.post('/api/login', (req, res) => {
    const { username, password } = req.body;
    
    // 驗證用戶名和密碼
    if (username === 'admin' && password === 'admin123') {
        const token = jwt.sign(
            { username, role: 'admin' },
            SECRET_KEY,
            { expiresIn: '1h' }
        );
        
        res.json({
            success: true,
            token,
            user: { username, role: 'admin' }
        });
    } else {
        res.status(401).json({
            success: false,
            error: '用戶名或密碼錯誤'
        });
    }
});

// 驗證中間件
const authenticate = (req, res, next) => {
    const token = req.headers['authorization']?.split(' ')[1];
    
    if (!token) {
        return res.status(401).json({ error: '需要授權' });
    }
    
    try {
        const decoded = jwt.verify(token, SECRET_KEY);
        req.user = decoded;
        next();
    } catch (error) {
        return res.status(403).json({ error: 'Token 無效或已過期' });
    }
};

// 受保護的路由
app.get('/api/protected', authenticate, (req, res) => {
    res.json({
        success: true,
        message: '訪問受保護資源成功',
        user: req.user
    });
});`
            };
            
            if (snippets[template]) {
                editors.code.setValue(snippets[template]);
                showFlash('代碼片段已加載', 'success');
                logSystemEvent(`加載代碼片段: ${template}`, 'info');
            }
        }

        function clearConsole() {
            const logContainers = ['execution-log', 'request-log', 'error-log'];
            logContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = '';
                }
            });
            showFlash('控制台已清空', 'success');
            logSystemEvent('清空控制台', 'info');
        }

        function switchConsoleTab(tab) {
            document.querySelectorAll('.console-tab').forEach(t => {
                t.classList.remove('active');
            });
            document.querySelectorAll('.console-tab-content').forEach(c => {
                c.style.display = 'none';
            });
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-log`).style.display = 'block';
        }

        function addConsoleLog(message, level = 'info', data = null) {
            const container = document.getElementById('execution-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            
            let logMessage = message;
            if (data) {
                if (typeof data === 'object') {
                    logMessage += '\n' + JSON.stringify(data, null, 2);
                } else {
                    logMessage += '\n' + data;
                }
            }
            
            logEntry.innerHTML = `
                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                <div class="log-message">${logMessage}</div>
            `;
            container.appendChild(logEntry);
        }

        // ============================================
        // 路由管理器功能（增强版）
        // ============================================
        function initRoutes() {
            routes = JSON.parse(localStorage.getItem('routes') || '[]');
            if (routes.length === 0) {
                routes = [
                    {
                        id: 1,
                        method: 'GET',
                        path: '/api/users',
                        handler: '(req, res) => {\n  const users = [\n    { id: 1, name: "張三" },\n    { id: 2, name: "李四" }\n  ];\n  res.json({ users });\n}',
                        middlewares: ['log', 'auth'],
                        description: '獲取所有用戶'
                    },
                    {
                        id: 2,
                        method: 'POST',
                        path: '/api/users',
                        handler: '(req, res) => {\n  const user = req.body;\n  user.id = Date.now();\n  res.status(201).json(user);\n}',
                        middlewares: ['log', 'auth', 'validate'],
                        description: '創建新用戶'
                    }
                ];
                saveRoutes();
            }
            updateRoutesDisplay();
        }

        function addRoute() {
            const newId = routes.length > 0 ? Math.max(...routes.map(r => r.id)) + 1 : 1;
            const route = {
                id: newId,
                method: 'GET',
                path: '/api/new-route',
                handler: '(req, res) => {\n  res.json({ message: "新路由" });\n}',
                middlewares: [],
                description: '新路由'
            };
            routes.push(route);
            updateRoutesDisplay();
            showFlash('新路由已添加', 'success');
            logSystemEvent('添加新路由', 'info');
        }

        function updateRoutesDisplay() {
            const container = document.getElementById('route-config-area');
            container.innerHTML = '';
            
            routes.forEach((route) => {
                const routeDiv = document.createElement('div');
                routeDiv.className = 'route-item';
                routeDiv.style.cssText = `
                    margin-bottom: 15px;
                    padding: 15px;
                    background: rgba(255,255,255,0.05);
                    border-radius: 8px;
                    border-left: 4px solid var(--accent-blue);
                `;
                
                const methodColor = {
                    'GET': 'method-get',
                    'POST': 'method-post',
                    'PUT': 'method-put',
                    'DELETE': 'method-delete'
                }[route.method] || 'method-get';
                
                routeDiv.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                        <div style="display: flex; gap: 5px; flex: 1;">
                            <select class="form-control" onchange="updateRoute(${route.id}, 'method', this.value)" style="min-width: 100px;">
                                <option value="GET" ${route.method === 'GET' ? 'selected' : ''}>GET</option>
                                <option value="POST" ${route.method === 'POST' ? 'selected' : ''}>POST</option>
                                <option value="PUT" ${route.method === 'PUT' ? 'selected' : ''}>PUT</option>
                                <option value="DELETE" ${route.method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                            </select>
                            <input type="text" class="form-control" value="${route.path}" 
                                   onchange="updateRoute(${route.id}, 'path', this.value)" placeholder="路由路徑" style="flex: 2;">
                        </div>
                        <button class="btn btn-warning" onclick="removeRoute(${route.id})" style="padding: 5px 10px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <input type="text" class="form-control" value="${route.description || ''}" 
                               onchange="updateRoute(${route.id}, 'description', this.value)" placeholder="路由描述">
                    </div>
                    <textarea class="form-control" onchange="updateRoute(${route.id}, 'handler', this.value)" 
                              rows="4" placeholder="處理函數">${route.handler}</textarea>
                    <div style="margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="color: var(--accent-blue); font-size: 0.9rem;">
                            <input type="checkbox" ${route.middlewares.includes('log') ? 'checked' : ''} 
                                   onchange="toggleMiddleware(${route.id}, 'log', this.checked)"> 日誌中間件
                        </label>
                        <label style="color: var(--accent-blue); font-size: 0.9rem;">
                            <input type="checkbox" ${route.middlewares.includes('auth') ? 'checked' : ''} 
                                   onchange="toggleMiddleware(${route.id}, 'auth', this.checked)"> 認證中間件
                        </label>
                        <label style="color: var(--accent-blue); font-size: 0.9rem;">
                            <input type="checkbox" ${route.middlewares.includes('validate') ? 'checked' : ''} 
                                   onchange="toggleMiddleware(${route.id}, 'validate', this.checked)"> 驗證中間件
                        </label>
                        <label style="color: var(--accent-blue); font-size: 0.9rem;">
                            <input type="checkbox" ${route.middlewares.includes('cors') ? 'checked' : ''} 
                                   onchange="toggleMiddleware(${route.id}, 'cors', this.checked)"> CORS中間件
                        </label>
                    </div>
                `;
                container.appendChild(routeDiv);
            });
        }

        function updateRoute(id, field, value) {
            const routeIndex = routes.findIndex(r => r.id === id);
            if (routeIndex !== -1) {
                routes[routeIndex][field] = value;
                saveRoutes();
            }
        }

        function toggleMiddleware(id, middleware, checked) {
            const routeIndex = routes.findIndex(r => r.id === id);
            if (routeIndex === -1) return;
            
            if (checked) {
                if (!routes[routeIndex].middlewares.includes(middleware)) {
                    routes[routeIndex].middlewares.push(middleware);
                }
            } else {
                const idx = routes[routeIndex].middlewares.indexOf(middleware);
                if (idx > -1) {
                    routes[routeIndex].middlewares.splice(idx, 1);
                }
            }
            saveRoutes();
        }

        function removeRoute(id) {
            if (confirm('確定要刪除此路由嗎？')) {
                const routeIndex = routes.findIndex(r => r.id === id);
                if (routeIndex !== -1) {
                    routes.splice(routeIndex, 1);
                    updateRoutesDisplay();
                    saveRoutes();
                    showFlash('路由已刪除', 'success');
                    logSystemEvent('刪除路由', 'info');
                }
            }
        }

        function saveRoutes() {
            localStorage.setItem('routes', JSON.stringify(routes));
            showFlash('路由配置已保存', 'success');
            logSystemEvent('保存路由配置', 'info');
        }

        function testRoute() {
            const method = document.getElementById('test-method').value;
            const url = document.getElementById('test-url').value;
            
            // 使用增强的路由匹配
            const matchedRoute = findMatchingRoute(method, url);
            
            const resultsDiv = document.getElementById('route-test-results');
            
            if (matchedRoute) {
                // 检查中间件
                const middlewareResults = checkMiddlewares(matchedRoute, url);
                
                let testResult = '成功';
                let statusCode = 200;
                let errorMessage = '';
                
                if (middlewareResults.includes('未通過認證')) {
                    testResult = '失敗';
                    statusCode = 401;
                    errorMessage = '缺少有效的認證Token';
                } else if (middlewareResults.includes('驗證失敗')) {
                    testResult = '失敗';
                    statusCode = 422;
                    errorMessage = '請求數據驗證失敗';
                }
                
                resultsDiv.innerHTML = `
                    <div class="log-entry ${testResult === '成功' ? 'success' : 'error'}">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>路由測試${testResult}</strong><br>
                            方法: ${method}<br>
                            路徑: ${url}<br>
                            匹配路由: ${matchedRoute.path}<br>
                            中間件: ${matchedRoute.middlewares.join(', ')}<br>
                            狀態碼: ${statusCode}<br>
                            ${errorMessage ? '錯誤: ' + errorMessage : ''}
                        </div>
                    </div>
                `;
                
                if (testResult === '成功') {
                    showFlash('路由測試成功', 'success');
                    logSystemEvent(`路由測試成功: ${method} ${url}`, 'success');
                } else {
                    showFlash(`路由測試失敗: ${errorMessage}`, 'error');
                    logSystemEvent(`路由測試失敗: ${method} ${url} - ${errorMessage}`, 'error');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>路由測試失敗</strong><br>
                            未找到匹配的路由: ${method} ${url}
                        </div>
                    </div>
                `;
                
                showFlash('未找到匹配的路由', 'error');
                logSystemEvent(`路由測試失敗: ${method} ${url}`, 'error');
            }
            
            // 更新统计信息
            requestStats.total++;
            if (matchedRoute) requestStats.success++;
            else requestStats.error++;
            updateStats();
        }

        function findMatchingRoute(method, path) {
            for (const route of routes) {
                if (route.method !== method) continue;
                
                // 将路由路径转换为正则表达式
                const pattern = route.path
                    .replace(/:\w+/g, '([^/]+)')
                    .replace(/\//g, '\\/');
                
                const regex = new RegExp(`^${pattern}$`);
                
                if (regex.test(path)) {
                    return route;
                }
            }
            return null;
        }

        function checkMiddlewares(route, path) {
            const results = [];
            
            if (route.middlewares.includes('auth')) {
                // 检查是否有有效的Token
                const token = localStorage.getItem('auth-token');
                if (!token) {
                    results.push('未通過認證');
                } else {
                    results.push('通過認證');
                }
            }
            
            if (route.middlewares.includes('validate')) {
                // 模拟验证逻辑
                if (path.includes('/api/users') && route.method === 'POST') {
                    results.push('通過驗證');
                } else {
                    results.push('驗證失敗');
                }
            }
            
            return results;
        }

        function testAllRoutes() {
            const resultsDiv = document.getElementById('route-test-results');
            resultsDiv.innerHTML = '<div class="log-entry info">開始測試所有路由...</div>';
            
            let passed = 0;
            let failed = 0;
            
            // 测试用户定义的所有路由
            routes.forEach((route, index) => {
                setTimeout(() => {
                    // 为每个路由生成测试URL
                    let testUrl = route.path;
                    
                    // 替换动态参数
                    if (testUrl.includes(':')) {
                        testUrl = testUrl.replace(/:\w+/g, '123');
                    }
                    
                    const matchedRoute = findMatchingRoute(route.method, testUrl);
                    
                    if (matchedRoute) {
                        passed++;
                        resultsDiv.innerHTML += `
                            <div class="log-entry success">
                                <div class="log-message">✓ ${route.method} ${testUrl} - 成功</div>
                            </div>
                        `;
                    } else {
                        failed++;
                        resultsDiv.innerHTML += `
                            <div class="log-entry error">
                                <div class="log-message">✗ ${route.method} ${testUrl} - 失敗</div>
                            </div>
                        `;
                    }
                    
                    if (index === routes.length - 1) {
                        resultsDiv.innerHTML += `
                            <div class="log-entry ${passed === routes.length ? 'success' : 'warning'}">
                                <div class="log-message">
                                    <strong>測試完成</strong><br>
                                    通過: ${passed}/${routes.length}<br>
                                    失敗: ${failed}/${routes.length}
                                </div>
                            </div>
                        `;
                        
                        showFlash(`路由測試完成: ${passed}/${routes.length} 通過`, 
                                 passed === routes.length ? 'success' : 'warning');
                        logSystemEvent(`路由測試完成: ${passed}/${routes.length} 通過`, 
                                     passed === routes.length ? 'success' : 'warning');
                    }
                }, index * 500);
            });
        }

        function generateAPIDocs() {
            const docsDiv = document.getElementById('api-docs');
            const contentDiv = document.getElementById('api-docs-content');
            
            contentDiv.innerHTML = `
                <h3 style="color: var(--accent-green); margin-bottom: 20px;">API 文檔</h3>
                <p>自動根據路由配置生成的 API 文檔：</p>
            `;
            
            routes.forEach(route => {
                const methodColor = {
                    'GET': 'method-get',
                    'POST': 'method-post',
                    'PUT': 'method-put',
                    'DELETE': 'method-delete'
                }[route.method];
                
                contentDiv.innerHTML += `
                    <div class="endpoint">
                        <div class="endpoint-header">
                            <span class="method-badge ${methodColor}">${route.method}</span>
                            <span class="endpoint-path">${route.path}</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>描述:</strong> ${route.description || '無'}<br>
                            <strong>中間件:</strong> ${route.middlewares.join(', ') || '無'}<br>
                            <strong>處理函數:</strong>
                            <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 5px; overflow: auto;">
${route.handler}
                            </pre>
                        </div>
                    </div>
                `;
            });
            
            docsDiv.style.display = 'block';
            showFlash('API 文檔已生成', 'success');
            logSystemEvent('生成 API 文檔', 'info');
        }

        // ============================================
        // HTTP模拟器功能（增强版）
        // ============================================
        function sendHttpRequest() {
            const method = document.getElementById('http-method').value;
            const url = document.getElementById('http-url').value;
            const body = document.getElementById('http-body').value;
            
            const startTime = Date.now();
            
            // 模拟网络延迟
            const delay = parseInt(document.getElementById('network-delay').value) || 0;
            const packetLoss = parseInt(document.getElementById('packet-loss').value) || 0;
            
            logSystemEvent(`發送 HTTP 請求: ${method} ${url}`, 'info');
            showFlash('請求發送中...', 'info');
            
            // 检查请求体格式
            if (method !== 'GET' && method !== 'DELETE') {
                try {
                    JSON.parse(body);
                } catch (error) {
                    const latency = Date.now() - startTime;
                    const resultDiv = document.getElementById('http-result');
                    resultDiv.innerHTML += `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>請求失敗: 415 Unsupported Media Type</strong><br>
                                方法: ${method}<br>
                                URL: ${url}<br>
                                錯誤: 請求體必須是有效的 JSON 格式
                            </div>
                        </div>
                    `;
                    
                    showFlash('請求體必須是有效的 JSON 格式', 'error');
                    logSystemEvent(`HTTP 請求失敗: 無效的 JSON 格式`, 'error');
                    
                    requestStats.error++;
                    requestStats.total++;
                    requestStats.latency.push(latency);
                    updateStats();
                    return;
                }
            }
            
            // 模拟网络延迟
            setTimeout(() => {
                // 模拟丢包
                if (Math.random() * 100 < packetLoss) {
                    const latency = Date.now() - startTime;
                    const resultDiv = document.getElementById('http-result');
                    resultDiv.innerHTML += `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>請求失敗: 網絡丟包</strong><br>
                                方法: ${method}<br>
                                URL: ${url}<br>
                                延遲: ${latency}ms<br>
                                丟包率: ${packetLoss}%<br>
                                <button class="btn btn-secondary" onclick="retryHttpRequest()" style="margin-top: 10px;">
                                    <i class="fas fa-redo"></i> 重試請求
                                </button>
                            </div>
                        </div>
                    `;
                    
                    showFlash('請求失敗: 網絡丟包', 'error');
                    logSystemEvent(`HTTP 請求失敗: 網絡丟包`, 'error');
                    
                    requestStats.error++;
                    requestStats.total++;
                    requestStats.latency.push(latency);
                    updateStats();
                    return;
                }
                
                // 查找匹配的路由
                const matchedRoute = findMatchingRoute(method, url);
                
                const latency = Date.now() - startTime;
                const resultDiv = document.getElementById('http-result');
                
                if (matchedRoute) {
                    // 检查中间件
                    const middlewareChecks = checkMiddlewares(matchedRoute, url);
                    
                    if (middlewareChecks.includes('未通過認證')) {
                        resultDiv.innerHTML += `
                            <div class="log-entry error">
                                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                                <div class="log-message">
                                    <strong>請求失敗: 401 Unauthorized</strong><br>
                                    方法: ${method}<br>
                                    URL: ${url}<br>
                                    狀態碼: 401<br>
                                    錯誤: 需要有效的認證Token<br>
                                    中間件: ${matchedRoute.middlewares.join(', ')}
                                </div>
                            </div>
                        `;
                        
                        showFlash('請求失敗: 需要認證', 'error');
                        logSystemEvent(`HTTP 請求失敗: 需要認證`, 'error');
                        
                        requestStats.error++;
                        requestStats.total++;
                        requestStats.latency.push(latency);
                    } else {
                        let responseBody;
                        try {
                            responseBody = JSON.parse(body || '{}');
                        } catch {
                            responseBody = { error: '無效的 JSON 格式' };
                        }
                        
                        resultDiv.innerHTML += `
                            <div class="log-entry success">
                                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                                <div class="log-message">
                                    <strong>請求成功: 200 OK</strong><br>
                                    方法: ${method}<br>
                                    URL: ${url}<br>
                                    狀態碼: 200<br>
                                    延遲: ${latency}ms<br>
                                    中間件: ${matchedRoute.middlewares.join(', ')}<br>
                                    回應體: ${JSON.stringify(responseBody, null, 2)}
                                </div>
                            </div>
                        `;
                        
                        showFlash('請求成功', 'success');
                        logSystemEvent(`HTTP 請求成功: ${method} ${url}`, 'success');
                        
                        requestStats.success++;
                        requestStats.total++;
                        requestStats.latency.push(latency);
                    }
                } else {
                    resultDiv.innerHTML += `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>請求失敗: 404 Not Found</strong><br>
                                方法: ${method}<br>
                                URL: ${url}<br>
                                狀態碼: 404<br>
                                延遲: ${latency}ms<br>
                                錯誤: 未找到匹配的路由
                            </div>
                        </div>
                    `;
                    
                    showFlash('請求失敗: 404 Not Found', 'error');
                    logSystemEvent(`HTTP 請求失敗: 404 Not Found`, 'error');
                    
                    requestStats.error++;
                    requestStats.total++;
                    requestStats.latency.push(latency);
                }
                
                updateStats();
                
                // 更新网络可视化
                updateNetworkVisualization();
                
            }, delay);
        }

        function retryHttpRequest() {
            sendHttpRequest();
        }

        function addHeader() {
            const headersDiv = document.getElementById('http-headers');
            const headerHtml = `
                <div class="input-group" style="margin-bottom: 5px;">
                    <input type="text" class="form-control" placeholder="Header 名稱" value="Authorization">
                    <input type="text" class="form-control" placeholder="Header 值" value="Bearer token_here">
                    <button class="btn btn-warning" onclick="removeHeader(this)" style="padding: 5px 10px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            headersDiv.insertAdjacentHTML('beforeend', headerHtml);
        }

        function removeHeader(button) {
            button.parentElement.remove();
        }

        function removeParam(button) {
            button.parentElement.remove();
        }

        function simulateNetwork() {
            const delay = document.getElementById('network-delay').value;
            const packetLoss = document.getElementById('packet-loss').value;
            
            showFlash(`網絡模擬設置: 延遲 ${delay}ms, 丟包率 ${packetLoss}%`, 'info');
            logSystemEvent(`設置網絡模擬: 延遲 ${delay}ms, 丟包率 ${packetLoss}%`, 'info');
        }

        function clearHttpLog() {
            document.getElementById('http-result').innerHTML = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">HTTP 日誌已清空</div>
                </div>
            `;
            showFlash('HTTP 日誌已清空', 'success');
        }

        function updateNetworkVisualization() {
            const nodes = document.querySelectorAll('.network-node');
            nodes.forEach((node, index) => {
                setTimeout(() => {
                    node.classList.add('active');
                    setTimeout(() => {
                        node.classList.remove('active');
                    }, 1000);
                }, index * 500);
            });
            
            document.getElementById('network-visualization').style.display = 'grid';
        }

        // ============================================
        // 数据库模拟器功能（增强版）
        // ============================================
        function executeQuery() {
            const query = document.getElementById('db-query').value;
            const dbType = document.getElementById('db-type').value;
            
            logSystemEvent(`執行數據庫查詢: ${dbType}`, 'info');
            showFlash('查詢執行中...', 'info');
            
            setTimeout(() => {
                let result;
                if (dbType === 'mysql') {
                    result = executeMySQLQuery(query);
                } else {
                    result = executeMongoDBQuery(query);
                }
                
                const resultDiv = document.getElementById('db-result');
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="log-entry success">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>查詢執行成功</strong><br>
                                數據庫類型: ${dbType}<br>
                                查詢: ${query}<br>
                                結果: ${JSON.stringify(result.data, null, 2)}<br>
                                受影響行數: ${result.affectedRows || 0}
                            </div>
                        </div>
                    `;
                    
                    showFlash('查詢執行成功', 'success');
                    logSystemEvent('數據庫查詢成功', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="log-entry error">
                            <div class="log-time">${new Date().toLocaleTimeString()}</div>
                            <div class="log-message">
                                <strong>查詢執行失敗</strong><br>
                                數據庫類型: ${dbType}<br>
                                查詢: ${query}<br>
                                錯誤: ${result.error}
                            </div>
                        </div>
                    `;
                    
                    showFlash('查詢執行失敗', 'error');
                    logSystemEvent('數據庫查詢失敗', 'error');
                }
            }, 1000);
        }

        function executeMySQLQuery(query) {
            const queryLower = query.toLowerCase().trim();
            
            if (queryLower.startsWith('select')) {
                // 支持简单的WHERE条件
                let filteredData = [...databaseData.mysql.users];
                
                if (queryLower.includes('where')) {
                    const whereClause = queryLower.split('where')[1].trim();
                    
                    // 支持简单的条件：age > 25, active = 1
                    if (whereClause.includes('age >')) {
                        const age = parseInt(whereClause.split('age >')[1].trim());
                        filteredData = filteredData.filter(item => item.age > age);
                    } else if (whereClause.includes('active =')) {
                        const active = parseInt(whereClause.split('active =')[1].trim());
                        filteredData = filteredData.filter(item => item.active === active);
                    }
                }
                
                return {
                    success: true,
                    data: filteredData,
                    affectedRows: 0
                };
            } else if (queryLower.startsWith('insert')) {
                // 解析INSERT语句
                const valuesMatch = query.match(/values\s*\(([^)]+)\)/i);
                if (valuesMatch) {
                    const values = valuesMatch[1].split(',').map(v => v.trim().replace(/'/g, ''));
                    const newId = databaseData.mysql.users.length + 1;
                    
                    const newUser = {
                        id: newId,
                        name: values[0] || '新用戶',
                        email: values[1] || 'new@example.com',
                        age: parseInt(values[2]) || 25,
                        active: parseInt(values[3]) || 1
                    };
                    
                    databaseData.mysql.users.push(newUser);
                    localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
                    
                    return {
                        success: true,
                        data: newUser,
                        affectedRows: 1
                    };
                }
            } else if (queryLower.startsWith('update')) {
                // 解析UPDATE语句
                const setMatch = query.match(/set\s+(.+?)\s+where/i);
                if (setMatch) {
                    const setClause = setMatch[1];
                    const updates = {};
                    
                    if (setClause.includes('age =')) {
                        updates.age = parseInt(setClause.split('age =')[1].trim());
                    }
                    if (setClause.includes('active =')) {
                        updates.active = parseInt(setClause.split('active =')[1].trim());
                    }
                    
                    // 简单的更新逻辑
                    let affected = 0;
                    databaseData.mysql.users = databaseData.mysql.users.map(user => {
                        if (queryLower.includes('where id =')) {
                            const idMatch = queryLower.match(/where id = (\d+)/);
                            if (idMatch && user.id === parseInt(idMatch[1])) {
                                affected++;
                                return { ...user, ...updates };
                            }
                        }
                        return user;
                    });
                    
                    localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
                    
                    return {
                        success: true,
                        data: { updated: affected },
                        affectedRows: affected
                    };
                }
            } else if (queryLower.startsWith('delete')) {
                // 解析DELETE语句
                let affected = 0;
                const originalLength = databaseData.mysql.users.length;
                
                if (queryLower.includes('where id =')) {
                    const idMatch = queryLower.match(/where id = (\d+)/);
                    if (idMatch) {
                        const idToDelete = parseInt(idMatch[1]);
                        databaseData.mysql.users = databaseData.mysql.users.filter(user => user.id !== idToDelete);
                        affected = originalLength - databaseData.mysql.users.length;
                    }
                }
                
                localStorage.setItem('mysql-data', JSON.stringify(databaseData.mysql));
                
                return {
                    success: true,
                    data: { deleted: affected },
                    affectedRows: affected
                };
            }
            
            return {
                success: false,
                error: '不支持的SQL語句或語法錯誤'
            };
        }

        function executeMongoDBQuery(query) {
            const queryLower = query.toLowerCase().trim();
            
            if (queryLower.includes('db.users.find')) {
                // 解析find查询
                let filteredData = [...databaseData.mongodb.users];
                
                // 支持简单的查询条件
                if (query.includes('{')) {
                    const conditionMatch = query.match(/\{([^}]+)\}/);
                    if (conditionMatch) {
                        const condition = conditionMatch[1].trim();
                        
                        if (condition.includes('age:')) {
                            if (condition.includes('$gt:')) {
                                const ageMatch = condition.match(/\$gt:\s*(\d+)/);
                                if (ageMatch) {
                                    const age = parseInt(ageMatch[1]);
                                    filteredData = filteredData.filter(item => item.age > age);
                                }
                            } else if (condition.includes('$lt:')) {
                                const ageMatch = condition.match(/\$lt:\s*(\d+)/);
                                if (ageMatch) {
                                    const age = parseInt(ageMatch[1]);
                                    filteredData = filteredData.filter(item => item.age < age);
                                }
                            } else {
                                const ageMatch = condition.match(/age:\s*(\d+)/);
                                if (ageMatch) {
                                    const age = parseInt(ageMatch[1]);
                                    filteredData = filteredData.filter(item => item.age === age);
                                }
                            }
                        }
                        
                        if (condition.includes('active:')) {
                            const activeMatch = condition.match(/active:\s*(true|false)/);
                            if (activeMatch) {
                                const active = activeMatch[1] === 'true';
                                filteredData = filteredData.filter(item => item.active === active);
                            }
                        }
                    }
                }
                
                return {
                    success: true,
                    data: filteredData,
                    count: filteredData.length
                };
            } else if (queryLower.includes('db.users.insert')) {
                // 解析insert操作
                const docMatch = query.match(/\{([^}]+)\}/);
                if (docMatch) {
                    try {
                        const doc = JSON.parse(`{${docMatch[1]}}`);
                        const newId = (databaseData.mongodb.users.length + 1).toString();
                        const newDoc = { _id: newId, ...doc };
                        
                        databaseData.mongodb.users.push(newDoc);
                        localStorage.setItem('mongodb-data', JSON.stringify(databaseData.mongodb));
                        
                        return {
                            success: true,
                            data: newDoc,
                            insertedCount: 1
                        };
                    } catch (e) {
                        return {
                            success: false,
                            error: '無效的文檔格式'
                        };
                    }
                }
            }
            
            return {
                success: false,
                error: '不支持的MongoDB語句或語法錯誤'
            };
        }

        function createTable() {
            const dbType = document.getElementById('db-type').value;
            let query;
            
            if (dbType === 'mysql') {
                query = `CREATE TABLE IF NOT EXISTS users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    age INT,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);`;
            } else {
                query = `// MongoDB 創建集合
db.createCollection("users", {
    validator: {
        $jsonSchema: {
            bsonType: "object",
            required: ["name", "email"],
            properties: {
                name: { bsonType: "string" },
                email: { bsonType: "string" },
                age: { bsonType: "int" },
                active: { bsonType: "bool" }
            }
        }
    }
});`;
            }
            
            document.getElementById('db-query').value = query;
            showFlash('創建表語句已生成', 'success');
            logSystemEvent(`生成創建表語句: ${dbType}`, 'info');
        }

        function insertSampleData() {
            const dbType = document.getElementById('db-type').value;
            let query;
            
            if (dbType === 'mysql') {
                query = `-- 插入示例數據
INSERT INTO users (name, email, age, active) VALUES
('張三', 'zhangsan@example.com', 25, true),
('李四', 'lisi@example.com', 30, true),
('王五', 'wangwu@example.com', 28, false);`;
            } else {
                query = `// 插入示例文檔
db.users.insertMany([
    { name: "張三", email: "zhangsan@example.com", age: 25, active: true },
    { name: "李四", email: "lisi@example.com", age: 30, active: true },
    { name: "王五", email: "wangwu@example.com", age: 28, active: false }
]);`;
            }
            
            document.getElementById('db-query').value = query;
            showFlash('示例數據語句已生成', 'success');
            logSystemEvent(`生成示例數據語句: ${dbType}`, 'info');
        }

        function clearDatabase() {
            if (confirm('確定要清空模擬數據庫嗎？')) {
                const dbType = document.getElementById('db-type').value;
                
                if (dbType === 'mysql') {
                    databaseData.mysql.users = [];
                    localStorage.removeItem('mysql-data');
                } else {
                    databaseData.mongodb.users = [];
                    localStorage.removeItem('mongodb-data');
                }
                
                const resultDiv = document.getElementById('db-result');
                resultDiv.innerHTML = `
                    <div class="log-entry warning">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">模擬數據庫已清空</div>
                    </div>
                `;
                showFlash('模擬數據庫已清空', 'warning');
                logSystemEvent('清空模擬數據庫', 'warning');
            }
        }

        // ============================================
        // 身份验证功能（增强版）
        // ============================================
        function changeAuthType() {
            const type = document.getElementById('auth-type').value;
            
            document.getElementById('jwt-config').style.display = 
                type === 'jwt' ? 'block' : 'none';
            document.getElementById('session-config').style.display = 
                type === 'session' ? 'block' : 'none';
            document.getElementById('oauth-config').style.display = 
                type === 'oauth' ? 'block' : 'none';
            
            logSystemEvent(`切換認證類型: ${type}`, 'info');
        }

        function initUsers() {
            try {
                const userData = document.getElementById('user-data')?.value;
                if (userData) {
                    users = JSON.parse(userData);
                }
            } catch (e) {
                users = [
                    {
                        id: 1,
                        username: 'admin',
                        password: 'admin123',
                        email: 'admin@example.com',
                        role: 'admin'
                    }
                ];
            }
        }

        function generateToken() {
            const type = document.getElementById('auth-type').value;
            let token;
            
            if (type === 'jwt') {
                const secret = document.getElementById('jwt-secret').value;
                const expiry = document.getElementById('jwt-expiry').value;
                
                // 使用 jsrsasign 生成 JWT
                const header = { alg: 'HS256', typ: 'JWT' };
                const payload = {
                    sub: '1234567890',
                    username: 'admin',
                    role: 'admin',
                    exp: Math.floor(Date.now() / 1000) + 3600
                };
                
                const sHeader = JSON.stringify(header);
                const sPayload = JSON.stringify(payload);
                const sJWT = KJUR.jws.JWS.sign('HS256', sHeader, sPayload, secret);
                token = sJWT;
                
                logSystemEvent('生成 JWT Token', 'info');
            } else if (type === 'session') {
                token = `session-id-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                logSystemEvent('生成 Session ID', 'info');
            } else if (type === 'oauth') {
                token = `oauth-token-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                logSystemEvent('生成 OAuth Token', 'info');
            } else {
                token = `basic-${btoa('admin:admin123')}`;
                logSystemEvent('生成 Basic Auth Token', 'info');
            }
            
            document.getElementById('current-token').value = token;
            showFlash(`${type.toUpperCase()} Token 已生成`, 'success');
            
            // 保存到localStorage
            localStorage.setItem('auth-token', token);
        }

        function validateToken() {
            const token = document.getElementById('current-token').value;
            const type = document.getElementById('auth-type').value;
            
            if (!token) {
                showFlash('請先生成 Token', 'warning');
                return;
            }
            
            let isValid = false;
            let message = '';
            let payload = null;
            
            if (type === 'jwt') {
                const secret = document.getElementById('jwt-secret').value;
                try {
                    const isValidJWT = KJUR.jws.JWS.verify(token, secret, ['HS256']);
                    if (isValidJWT) {
                        isValid = true;
                        payload = KJUR.jws.JWS.parse(token).payloadObj;
                        message = 'JWT Token 驗證成功';
                    } else {
                        message = 'JWT Token 驗證失敗';
                    }
                } catch (e) {
                    message = `JWT Token 驗證錯誤: ${e.message}`;
                }
            } else {
                isValid = token.length > 10;
                message = isValid ? `${type.toUpperCase()} Token 驗證成功` : 'Token 無效';
            }
            
            const resultsDiv = document.getElementById('auth-test-results');
            resultsDiv.innerHTML = `
                <div class="log-entry ${isValid ? 'success' : 'error'}">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>${message}</strong><br>
                        類型: ${type}<br>
                        ${payload ? `用戶: ${payload.username}, 角色: ${payload.role}` : ''}<br>
                        Token: ${token.substring(0, 50)}${token.length > 50 ? '...' : ''}
                    </div>
                </div>
            `;
            
            if (isValid) {
                showFlash('Token 驗證成功', 'success');
                logSystemEvent('Token 驗證成功', 'success');
            } else {
                showFlash('Token 驗證失敗', 'error');
                logSystemEvent('Token 驗證失敗', 'error');
            }
        }

        function login() {
            const type = document.getElementById('auth-type').value;
            
            if (type === 'oauth') {
                // 显示OAuth授权对话框
                showOAuthDialog();
                return;
            }
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            initUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            const resultsDiv = document.getElementById('auth-test-results');
            
            if (user) {
                let token;
                if (type === 'jwt') {
                    const secret = document.getElementById('jwt-secret').value;
                    const header = { alg: 'HS256', typ: 'JWT' };
                    const payload = {
                        sub: user.id,
                        username: user.username,
                        role: user.role,
                        exp: Math.floor(Date.now() / 1000) + 3600
                    };
                    token = KJUR.jws.JWS.sign('HS256', JSON.stringify(header), JSON.stringify(payload), secret);
                } else if (type === 'session') {
                    token = `session-${Date.now()}-${user.id}`;
                    localStorage.setItem('session-user', JSON.stringify(user));
                } else {
                    token = `basic-${btoa(username + ':' + password)}`;
                }
                
                document.getElementById('current-token').value = token;
                localStorage.setItem('auth-token', token);
                localStorage.setItem('current-user', JSON.stringify(user));
                
                resultsDiv.innerHTML = `
                    <div class="log-entry success">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>登入成功</strong><br>
                            用戶: ${user.username}<br>
                            角色: ${user.role}<br>
                            Token: ${token.substring(0, 50)}...
                        </div>
                    </div>
                `;
                
                showFlash('登入成功', 'success');
                logSystemEvent(`用戶登入成功: ${username}`, 'success');
            } else {
                resultsDiv.innerHTML = `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>登入失敗</strong><br>
                            用戶名或密碼錯誤
                        </div>
                    </div>
                `;
                
                showFlash('登入失敗', 'error');
                logSystemEvent(`用戶登入失敗: ${username}`, 'error');
            }
        }

        function showOAuthDialog() {
            // 生成授权码
            const authCode = `auth-code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            document.getElementById('oauth-auth-code').value = authCode;
            
            document.getElementById('oauth-dialog').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function approveOAuth() {
            const authCode = document.getElementById('oauth-auth-code').value;
            
            // 模拟交换Token
            const token = `oauth-token-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            document.getElementById('current-token').value = token;
            localStorage.setItem('auth-token', token);
            
            // 模拟用户数据
            const user = {
                id: 1,
                username: 'oauth-user',
                email: 'oauth@example.com',
                role: 'user'
            };
            localStorage.setItem('current-user', JSON.stringify(user));
            
            const resultsDiv = document.getElementById('auth-test-results');
            resultsDiv.innerHTML = `
                <div class="log-entry success">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>OAuth 授權成功</strong><br>
                        授權碼: ${authCode}<br>
                        Token: ${token}<br>
                        用戶: ${user.username}
                    </div>
                </div>
            `;
            
            hideOAuthDialog();
            showFlash('OAuth 授權成功', 'success');
            logSystemEvent('OAuth 授權成功', 'success');
        }

        function denyOAuth() {
            hideOAuthDialog();
            showFlash('OAuth 授權被拒絕', 'warning');
            logSystemEvent('OAuth 授權被拒絕', 'warning');
        }

        function hideOAuthDialog() {
            document.getElementById('oauth-dialog').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function accessProtectedResource() {
            const resource = document.getElementById('protected-resource').value;
            const token = document.getElementById('current-token').value || localStorage.getItem('auth-token');
            const type = document.getElementById('auth-type').value;
            
            const resultsDiv = document.getElementById('auth-test-results');
            
            if (!token) {
                resultsDiv.innerHTML += `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>訪問失敗</strong><br>
                            資源: ${resource}<br>
                            錯誤: 未提供認證 Token
                        </div>
                    </div>
                `;
                
                showFlash('訪問失敗: 未授權', 'error');
                logSystemEvent(`訪問失敗: 未授權訪問 ${resource}`, 'error');
                return;
            }
            
            // 模拟访问控制
            let hasAccess = false;
            let role = 'guest';
            let username = 'anonymous';
            
            if (type === 'jwt') {
                try {
                    const secret = document.getElementById('jwt-secret').value;
                    const isValid = KJUR.jws.JWS.verify(token, secret, ['HS256']);
                    if (isValid) {
                        const payload = KJUR.jws.JWS.parse(token).payloadObj;
                        role = payload.role || 'user';
                        username = payload.username || 'unknown';
                        
                        // 检查权限
                        if (resource.includes('/api/admin')) {
                            hasAccess = role === 'admin';
                        } else {
                            hasAccess = true;
                        }
                    }
                } catch (e) {
                    // Token 无效
                }
            } else {
                hasAccess = token.length > 10;
                role = 'user';
                username = 'user';
            }
            
            if (hasAccess) {
                resultsDiv.innerHTML += `
                    <div class="log-entry success">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>訪問成功</strong><br>
                            資源: ${resource}<br>
                            用戶: ${username}<br>
                            角色: ${role}<br>
                            狀態: 授權訪問
                        </div>
                    </div>
                `;
                
                showFlash('訪問成功', 'success');
                logSystemEvent(`訪問成功: ${resource}`, 'success');
            } else {
                resultsDiv.innerHTML += `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>訪問被拒絕</strong><br>
                            資源: ${resource}<br>
                            用戶: ${username}<br>
                            角色: ${role}<br>
                            錯誤: 權限不足
                        </div>
                    </div>
                `;
                
                showFlash('訪問被拒絕: 權限不足', 'error');
                logSystemEvent(`訪問被拒絕: 權限不足 ${resource}`, 'error');
            }
        }

        function simulateLogout() {
            document.getElementById('current-token').value = '';
            localStorage.removeItem('auth-token');
            localStorage.removeItem('current-user');
            localStorage.removeItem('session-user');
            
            const resultsDiv = document.getElementById('auth-test-results');
            resultsDiv.innerHTML = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">已登出，Token 已清除</div>
                </div>
            `;
            
            showFlash('已登出', 'info');
            logSystemEvent('用戶登出', 'info');
        }

        // ============================================
        // 单元测试功能
        // ============================================
        function runTests() {
            const framework = document.getElementById('test-framework').value;
            const code = document.getElementById('test-code').value;
            
            logSystemEvent(`執行單元測試: ${framework}`, 'info');
            showFlash('測試執行中...', 'info');
            
            setTimeout(() => {
                let results;
                if (framework === 'jest') {
                    results = simulateJestTests(code);
                } else if (framework === 'pytest') {
                    results = simulatePytestTests(code);
                } else {
                    results = simulateJUnitTests(code);
                }
                
                const resultsDiv = document.getElementById('test-results');
                resultsDiv.innerHTML = `
                    <div class="log-entry ${results.passed === results.total ? 'success' : 'warning'}">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>測試完成</strong><br>
                            框架: ${framework}<br>
                            通過: ${results.passed}/${results.total}<br>
                            失敗: ${results.failed}/${results.total}<br>
                            覆蓋率: ${results.coverage}%<br>
                            執行時間: ${results.executionTime}ms
                        </div>
                    </div>
                `;
                
                // 添加详细的测试结果
                results.tests.forEach(test => {
                    resultsDiv.innerHTML += `
                        <div class="log-entry ${test.passed ? 'success' : 'error'}">
                            <div class="log-message">
                                ${test.passed ? '✓' : '✗'} ${test.name}<br>
                                ${test.message}
                            </div>
                        </div>
                    `;
                });
                
                const message = results.passed === results.total ? 
                    '所有測試通過' : `${results.passed}/${results.total} 測試通過`;
                showFlash(message, results.passed === results.total ? 'success' : 'warning');
                logSystemEvent(`單元測試完成: ${message}`, results.passed === results.total ? 'success' : 'warning');
            }, 1500);
        }

        function simulateJestTests(code) {
            // 简单的测试模拟
            const tests = [
                { name: '加法測試', passed: true, message: '1 + 2 = 3' },
                { name: '減法測試', passed: true, message: '5 - 3 = 2' },
                { name: '乘法測試', passed: true, message: '2 * 3 = 6' }
            ];
            
            return {
                passed: 3,
                failed: 0,
                total: 3,
                coverage: 85,
                executionTime: 125,
                tests: tests
            };
        }

        function simulatePytestTests(code) {
            const tests = [
                { name: '測試加法函數', passed: true, message: 'assert add(1, 2) == 3' },
                { name: '測試減法函數', passed: true, message: 'assert subtract(5, 3) == 2' },
                { name: '測試乘法函數', passed: false, message: 'AssertionError: assert multiply(2, 3) == 6' }
            ];
            
            return {
                passed: 2,
                failed: 1,
                total: 3,
                coverage: 75,
                executionTime: 98,
                tests: tests
            };
        }

        function addTestCase() {
            const framework = document.getElementById('test-framework').value;
            let testCode;
            
            if (framework === 'jest') {
                testCode = `\ntest('新的測試用例', () => {
  expect(true).toBe(true);
});`;
            } else if (framework === 'pytest') {
                testCode = `\ndef test_new_case():
    assert 1 + 1 == 2`;
            } else {
                testCode = `\n@Test
public void testNewCase() {
    assertEquals(2, 1 + 1);
}`;
            }
            
            const textarea = document.getElementById('test-code');
            textarea.value += testCode;
            showFlash('測試用例已添加', 'success');
            logSystemEvent('添加測試用例', 'info');
        }

        function generateTestReport() {
            const report = {
                timestamp: new Date().toISOString(),
                totalTests: 15,
                passedTests: 12,
                failedTests: 3,
                coverage: 80,
                executionTime: 2450,
                details: [
                    { test: '用戶註冊測試', status: 'passed', time: '120ms' },
                    { test: '用戶登入測試', status: 'passed', time: '85ms' },
                    { test: '權限驗證測試', status: 'failed', time: '200ms', error: '權限檢查失敗' }
                ]
            };
            
            const reportText = JSON.stringify(report, null, 2);
            const blob = new Blob([reportText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showFlash('測試報告已導出', 'success');
            logSystemEvent('導出測試報告', 'info');
        }

        function clearTests() {
            if (confirm('確定要清空測試代碼嗎？')) {
                document.getElementById('test-code').value = '';
                document.getElementById('test-results').innerHTML = `
                    <div class="log-entry info">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">測試代碼已清空</div>
                    </div>
                `;
                showFlash('測試代碼已清空', 'success');
                logSystemEvent('清空測試代碼', 'info');
            }
        }

        // ============================================
        // 项目向导功能
        // ============================================
        function nextStep(step) {
            document.querySelectorAll('.wizard-step').forEach(s => {
                s.style.display = 'none';
            });
            document.getElementById(`step${step}`).style.display = 'block';
        }

        function prevStep(step) {
            document.querySelectorAll('.wizard-step').forEach(s => {
                s.style.display = 'none';
            });
            document.getElementById(`step${step}`).style.display = 'block';
        }

        function createProject() {
            const type = document.getElementById('project-type').value;
            const framework = document.getElementById('project-framework').value;
            
            let projectTemplate = '';
            
            if (framework === 'flask') {
                projectTemplate = `from flask import Flask, jsonify, request
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

@app.route('/')
def home():
    return jsonify({"message": "Welcome to Flask API"})

@app.route('/api/health')
def health():
    return jsonify({"status": "healthy"})

if __name__ == '__main__':
    app.run(debug=True)`;
            } else if (framework === 'express') {
                projectTemplate = `const express = require('express');
const app = express();

app.use(express.json());

app.get('/', (req, res) => {
    res.json({ message: 'Welcome to Express API' });
});

app.get('/api/health', (req, res) => {
    res.json({ status: 'healthy' });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(\`Server running on port \${PORT}\`);
});`;
            }
            
            // 保存项目代码
            localStorage.setItem('project-code', projectTemplate);
            
            // 切换到代码编辑器
            navigateTo('code-editor');
            
            // 加载项目代码
            setTimeout(() => {
                if (editors.code) {
                    editors.code.setValue(projectTemplate);
                }
            }, 100);
            
            showFlash('項目創建成功', 'success');
            logSystemEvent(`創建項目: ${type} - ${framework}`, 'success');
        }

        // ============================================
        // Git模拟功能
        // ============================================
        function gitInit() {
            gitHistory = [];
            currentBranch = 'main';
            
            const operationsDiv = document.getElementById('git-operations');
            operationsDiv.innerHTML += `
                <div class="log-entry success">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">已初始化空的 Git 倉庫</div>
                </div>
            `;
            
            showFlash('Git 倉庫初始化成功', 'success');
            logSystemEvent('初始化 Git 倉庫', 'info');
        }

        function gitAdd() {
            const operationsDiv = document.getElementById('git-operations');
            operationsDiv.innerHTML += `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">已添加文件到暫存區</div>
                </div>
            `;
            
            showFlash('文件已添加到暫存區', 'info');
            logSystemEvent('添加文件到 Git 暫存區', 'info');
        }

        function gitCommit() {
            const message = document.getElementById('commit-message').value;
            if (!message) {
                showFlash('請輸入提交信息', 'warning');
                return;
            }
            
            const fileContent = document.getElementById('git-file-content').value;
            const commit = {
                id: gitHistory.length + 1,
                hash: Math.random().toString(36).substr(2, 7),
                message: message,
                branch: currentBranch,
                timestamp: new Date().toISOString(),
                content: fileContent
            };
            
            gitHistory.push(commit);
            
            const operationsDiv = document.getElementById('git-operations');
            operationsDiv.innerHTML += `
                <div class="log-entry success">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>提交成功</strong><br>
                        提交信息: ${message}<br>
                        提交哈希: ${commit.hash}
                    </div>
                </div>
            `;
            
            updateCommitHistory();
            
            showFlash('提交成功', 'success');
            logSystemEvent(`Git 提交: ${message}`, 'info');
        }

        function gitBranch() {
            const branchName = document.getElementById('branch-name').value;
            if (!branchName) {
                showFlash('請輸入分支名稱', 'warning');
                return;
            }
            
            currentBranch = branchName;
            
            const operationsDiv = document.getElementById('git-operations');
            operationsDiv.innerHTML += `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>創建分支成功</strong><br>
                        分支名稱: ${branchName}<br>
                        已切換到分支: ${branchName}
                    </div>
                </div>
            `;
            
            showFlash(`已創建並切換到分支 ${branchName}`, 'success');
            logSystemEvent(`創建 Git 分支: ${branchName}`, 'info');
        }

        function gitMerge() {
            // 模拟合并冲突
            const hasConflict = Math.random() > 0.7;
            
            const operationsDiv = document.getElementById('git-operations');
            
            if (hasConflict) {
                operationsDiv.innerHTML += `
                    <div class="log-entry error">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>合併衝突</strong><br>
                            自動合併失敗，需要手動解決衝突
                        </div>
                    </div>
                `;
                
                showFlash('合併衝突: 需要手動解決', 'error');
                logSystemEvent('Git 合併衝突', 'warning');
            } else {
                operationsDiv.innerHTML += `
                    <div class="log-entry success">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>合併成功</strong><br>
                            已成功合併分支
                        </div>
                    </div>
                `;
                
                showFlash('合併成功', 'success');
                logSystemEvent('Git 合併成功', 'info');
            }
        }

        function updateCommitHistory() {
            const historyDiv = document.getElementById('commit-history');
            historyDiv.innerHTML = '';
            
            gitHistory.slice().reverse().forEach(commit => {
                const commitDiv = document.createElement('div');
                commitDiv.className = 'git-commit';
                commitDiv.innerHTML = `
                    <div style="font-weight: bold; color: var(--accent-green);">
                        ${commit.hash} (${commit.branch})
                    </div>
                    <div style="margin: 5px 0;">${commit.message}</div>
                    <div style="font-size: 0.9rem; color: var(--text-gray);">
                        ${new Date(commit.timestamp).toLocaleString()}
                    </div>
                `;
                historyDiv.appendChild(commitDiv);
            });
        }

        // ============================================
        // 代码质量分析功能
        // ============================================
        function analyzeCode() {
            const code = document.getElementById('code-to-analyze').value;
            
            // 分析代码质量
            const issues = [];
            const metrics = {
                lines: code.split('\n').length,
                complexity: 0,
                issuesFound: 0
            };
            
            // 检查常见问题
            if (code.includes('var ')) {
                issues.push({
                    type: 'warning',
                    message: '建議使用 const 或 let 代替 var',
                    line: code.split('\n').findIndex(line => line.includes('var ')) + 1
                });
            }
            
            if (code.match(/for\s*\(\s*var\s+\w+\s*=/)) {
                issues.push({
                    type: 'warning',
                    message: 'for 循環中建議使用 let',
                    line: code.split('\n').findIndex(line => line.match(/for\s*\(\s*var\s+\w+\s*=/)) + 1
                });
            }
            
            if (code.includes('console.log(')) {
                issues.push({
                    type: 'info',
                    message: '生產環境建議移除 console.log',
                    line: code.split('\n').findIndex(line => line.includes('console.log(')) + 1
                });
            }
            
            // 检查代码复杂度
            const functionCount = (code.match(/function\s+\w+\(/g) || []).length;
            metrics.complexity = functionCount;
            metrics.issuesFound = issues.length;
            
            const resultsDiv = document.getElementById('quality-results');
            resultsDiv.innerHTML = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>代碼質量分析完成</strong><br>
                        總行數: ${metrics.lines}<br>
                        函數數量: ${metrics.complexity}<br>
                        發現問題: ${metrics.issuesFound}
                    </div>
                </div>
            `;
            
            // 显示具体问题
            issues.forEach(issue => {
                resultsDiv.innerHTML += `
                    <div class="log-entry ${issue.type}">
                        <div class="log-message">
                            ${issue.type === 'error' ? '✗' : issue.type === 'warning' ? '⚠' : 'ℹ'} 
                            第 ${issue.line} 行: ${issue.message}
                        </div>
                    </div>
                `;
            });
            
            // 生成质量报告
            generateQualityReportContent(metrics, issues);
            
            showFlash('代碼質量分析完成', 'success');
            logSystemEvent('執行代碼質量分析', 'info');
        }

        function autoFormat() {
            const code = document.getElementById('code-to-analyze').value;
            
            // 简单的格式化
            let formatted = code
                .replace(/\t/g, '  ') // 制表符转空格
                .replace(/\s+$/gm, '') // 移除行尾空格
                .replace(/\n{3,}/g, '\n\n'); // 移除多余空行
            
            document.getElementById('code-to-analyze').value = formatted;
            
            showFlash('代碼已格式化', 'success');
            logSystemEvent('自動格式化代碼', 'info');
        }

        function generateQualityReport() {
            const reportDiv = document.getElementById('quality-report');
            reportDiv.style.display = 'block';
            
            showFlash('代碼質量報告已生成', 'success');
            logSystemEvent('生成代碼質量報告', 'info');
        }

        function generateQualityReportContent(metrics, issues) {
            const contentDiv = document.getElementById('quality-report-content');
            contentDiv.innerHTML = '';
            
            // 计算质量分数
            const issueScore = Math.max(0, 100 - (issues.length * 10));
            const complexityScore = Math.max(0, 100 - (metrics.complexity * 5));
            const finalScore = Math.round((issueScore + complexityScore) / 2);
            
            contentDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--accent-yellow);">代碼質量報告</h4>
                    <div class="quality-metric">
                        <span>質量分數</span>
                        <span style="color: ${finalScore >= 80 ? 'var(--accent-green)' : finalScore >= 60 ? 'var(--accent-yellow)' : 'var(--accent-red)'}; font-weight: bold;">
                            ${finalScore}/100
                        </span>
                    </div>
                    <div class="quality-metric">
                        <span>代碼行數</span>
                        <span>${metrics.lines}</span>
                    </div>
                    <div class="quality-metric">
                        <span>函數數量</span>
                        <span>${metrics.complexity}</span>
                    </div>
                    <div class="quality-metric">
                        <span>發現問題</span>
                        <span>${metrics.issuesFound}</span>
                    </div>
                </div>
            `;
            
            if (issues.length > 0) {
                contentDiv.innerHTML += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: var(--accent-yellow);">發現的問題</h5>
                `;
                
                issues.forEach(issue => {
                    contentDiv.innerHTML += `
                        <div class="error-cause">
                            <strong>第 ${issue.line} 行</strong><br>
                            ${issue.message}
                        </div>
                    `;
                });
                
                contentDiv.innerHTML += `</div>`;
            }
            
            // 优化建议
            contentDiv.innerHTML += `
                <div>
                    <h5 style="color: var(--accent-yellow);">優化建議</h5>
                    <div class="error-cause">
                        <strong>代碼規範</strong><br>
                        建議使用 ESLint 進行代碼檢查，統一編碼風格
                    </div>
                    <div class="error-cause">
                        <strong>代碼重構</strong><br>
                        考慮將重複邏輯提取為獨立函數，提高代碼複用性
                    </div>
                    <div class="error-cause">
                        <strong>錯誤處理</strong><br>
                        建議添加完整的錯誤處理機制，提高代碼健壯性
                    </div>
                </div>
            `;
        }

        function clearAnalysis() {
            if (confirm('確定要清空分析結果嗎？')) {
                document.getElementById('code-to-analyze').value = '';
                document.getElementById('quality-results').innerHTML = `
                    <div class="log-entry info">
                        <div class="log-time">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">代碼質量分析器已就緒。請輸入代碼並點擊"分析代碼"。</div>
                    </div>
                `;
                document.getElementById('quality-report').style.display = 'none';
                showFlash('分析結果已清空', 'success');
                logSystemEvent('清空代碼質量分析', 'info');
            }
        }

        // ============================================
        // 错误分析助手功能
        // ============================================
        function analyzeError() {
            const errorType = document.getElementById('error-type').value;
            const description = document.getElementById('error-description').value;
            
            const resultsDiv = document.getElementById('error-analysis-results');
            resultsDiv.innerHTML = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">
                        <strong>錯誤分析報告</strong><br>
                        錯誤類型: ${getErrorTypeName(errorType)}<br>
                        描述: ${description || '無'}
                    </div>
                </div>
            `;
            
            // 生成错误建议
            generateErrorSuggestions(errorType, description);
            
            showFlash('錯誤分析完成', 'success');
            logSystemEvent(`分析錯誤: ${errorType}`, 'info');
        }

        function getErrorTypeName(errorType) {
            const names = {
                '404': '404 Not Found',
                '500': '500 Internal Server Error',
                '401': '401 Unauthorized',
                '403': '403 Forbidden',
                '422': '422 Unprocessable Entity',
                'syntax': '語法錯誤',
                'runtime': '運行時錯誤'
            };
            return names[errorType] || errorType;
        }

        function generateErrorSuggestions(errorType, description) {
            const suggestionsDiv = document.getElementById('error-suggestions');
            const contentDiv = document.getElementById('error-suggestions-content');
            
            suggestionsDiv.style.display = 'block';
            contentDiv.innerHTML = '';
            
            // 根据错误类型提供建议
            const suggestions = {
                '404': [
                    '檢查請求的 URL 是否正確',
                    '確認路由是否在伺服器中註冊',
                    '檢查 HTTP 方法是否匹配（GET/POST/PUT/DELETE）',
                    '如果是動態路由，檢查參數格式是否正確'
                ],
                '500': [
                    '查看伺服器日誌獲取詳細錯誤信息',
                    '檢查代碼中的語法錯誤',
                    '確認依賴包是否正確安裝',
                    '檢查數據庫連接是否正常'
                ],
                '401': [
                    '檢查是否提供了有效的認證 Token',
                    '確認 Token 是否已過期',
                    '檢查用戶名和密碼是否正確',
                    '如果是 OAuth，檢查授權流程是否完整'
                ],
                '403': [
                    '檢查用戶角色是否有足夠權限',
                    '確認資源訪問控制列表配置',
                    '檢查 IP 白名單設置',
                    '確認 API 訪問頻率是否超限'
                ],
                '422': [
                    '檢查請求數據格式是否符合要求',
                    '確認必填字段是否都提供了',
                    '檢查字段數據類型是否正確',
                    '驗證數據範圍和約束條件'
                ],
                'syntax': [
                    '檢查代碼中的括號是否匹配',
                    '確認語句結束符是否正確',
                    '檢查變量是否已定義',
                    '確認函數參數是否正確'
                ],
                'runtime': [
                    '檢查變量是否為 null 或 undefined',
                    '確認數組索引是否越界',
                    '檢查對象屬性是否存在',
                    '確認網絡請求是否成功'
                ]
            };
            
            const errorSuggestions = suggestions[errorType] || ['請檢查代碼邏輯和配置'];
            
            errorSuggestions.forEach((suggestion, index) => {
                contentDiv.innerHTML += `
                    <div class="error-cause" onclick="navigateToSuggestion(${index}, '${errorType}')">
                        <strong>建議 ${index + 1}</strong><br>
                        ${suggestion}
                    </div>
                `;
            });
            
            // 添加通用建议
            contentDiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: rgba(56, 189, 248, 0.1); border-radius: 5px;">
                    <strong>通用排查步驟:</strong><br>
                    1. 檢查控制台錯誤信息<br>
                    2. 確認環境配置是否正確<br>
                    3. 查看相關文檔和示例代碼<br>
                    4. 使用調試工具逐步排查
                </div>
            `;
        }

        function navigateToSuggestion(index, errorType) {
            // 根据建议导航到相关页面
            switch (errorType) {
                case '404':
                    navigateTo('router-manager');
                    break;
                case '401':
                case '403':
                    navigateTo('authentication');
                    break;
                case '422':
                    navigateTo('http-simulator');
                    break;
                case 'syntax':
                case 'runtime':
                    navigateTo('code-editor');
                    break;
                default:
                    navigateTo('error-assistant');
            }
            
            showFlash(`已導航到相關頁面查看建議 ${index + 1}`, 'info');
        }

        function clearErrorLog() {
            document.getElementById('error-description').value = '';
            document.getElementById('error-analysis-results').innerHTML = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString()}</div>
                    <div class="log-message">錯誤分析助手已就緒。請選擇錯誤類型並描述問題。</div>
                </div>
            `;
            document.getElementById('error-suggestions').style.display = 'none';
            showFlash('錯誤分析已清空', 'success');
        }

        // ============================================
        // 图表功能
        // ============================================
        function initCharts() {
            // 请求趋势图表
            const requestCtx = document.getElementById('request-chart').getContext('2d');
            charts.request = new Chart(requestCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'API 請求數',
                        data: Array.from({length: 24}, () => Math.floor(Math.random() * 100)),
                        borderColor: 'rgb(56, 189, 248)',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgb(203, 213, 225)'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgb(203, 213, 225)'
                            },
                            grid: {
                                color: 'rgba(203, 213, 225, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgb(203, 213, 225)'
                            },
                            grid: {
                                color: 'rgba(203, 213, 225, 0.1)'
                            }
                        }
                    }
                }
            });

            // 错误分析图表
            const errorCtx = document.getElementById('error-chart').getContext('2d');
            charts.error = new Chart(errorCtx, {
                type: 'doughnut',
                data: {
                    labels: ['404 Not Found', '500 Server Error', '401 Unauthorized', '其他錯誤'],
                    datasets: [{
                        data: [15, 10, 8, 5],
                        backgroundColor: [
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)',
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgb(203, 213, 225)'
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (charts.request) {
                // 更新请求趋势数据
                const newData = charts.request.data.datasets[0].data.map(() => 
                    Math.floor(Math.random() * 100)
                );
                charts.request.data.datasets[0].data = newData;
                charts.request.update();
            }
        }

        // ============================================
        // 统计和仪表板功能（增强版）
        // ============================================
        function updateStats() {
            // 从localStorage加载统计信息
            const savedStats = JSON.parse(localStorage.getItem('request-stats') || '{}');
            if (savedStats.total !== undefined) {
                requestStats = { ...requestStats, ...savedStats };
            }
            
            // 更新首页统计
            document.getElementById('api-count').textContent = routes.length;
            document.getElementById('success-rate').textContent = 
                requestStats.total > 0 ? 
                `${Math.round((requestStats.success / requestStats.total) * 100)}%` : 
                '100%';
            
            const avgLatency = requestStats.latency.length > 0 ?
                Math.round(requestStats.latency.reduce((a, b) => a + b, 0) / requestStats.latency.length) :
                0;
            document.getElementById('avg-response').textContent = `${avgLatency}ms`;
            document.getElementById('total-requests').textContent = requestStats.total;
            
            // 更新仪表板统计
            document.getElementById('total-api-calls').textContent = requestStats.total;
            document.getElementById('success-calls').textContent = requestStats.success;
            document.getElementById('error-calls').textContent = requestStats.error;
            document.getElementById('avg-latency').textContent = `${avgLatency}ms`;
            
            // 更新性能监控
            updatePerformanceStats();
            
            // 保存统计信息
            localStorage.setItem('request-stats', JSON.stringify(requestStats));
        }

        function updatePerformanceStats() {
            // 模拟性能数据
            const cpuUsage = 20 + Math.random() * 30;
            const memoryUsage = 40 + Math.random() * 30;
            const storageUsage = 50 + Math.random() * 30;
            
            document.getElementById('cpu-usage').style.width = `${cpuUsage}%`;
            document.getElementById('cpu-text').textContent = `${Math.round(cpuUsage)}%`;
            
            document.getElementById('memory-usage').style.width = `${memoryUsage}%`;
            document.getElementById('memory-text').textContent = `${Math.round(memoryUsage)}%`;
            
            document.getElementById('storage-usage').style.width = `${storageUsage}%`;
            document.getElementById('storage-text').textContent = `${Math.round(storageUsage)}%`;
        }

        // ============================================
        // 数据加载和保存
        // ============================================
        function loadSavedData() {
            // 加载保存的代码
            const savedCode = localStorage.getItem('saved-code');
            if (savedCode && editors.code) {
                editors.code.setValue(savedCode);
            }
            
            // 加载路由
            const savedRoutes = localStorage.getItem('routes');
            if (savedRoutes) {
                routes = JSON.parse(savedRoutes);
            }
            
            // 加载系统设置
            const settings = localStorage.getItem('system-settings');
            if (settings) {
                try {
                    const parsedSettings = JSON.parse(settings);
                    // 应用设置
                } catch (e) {
                    console.error('加载设置失败:', e);
                }
            }
            
            // 加载数据库数据
            const mysqlData = localStorage.getItem('mysql-data');
            if (mysqlData) {
                databaseData.mysql = JSON.parse(mysqlData);
            }
            
            const mongodbData = localStorage.getItem('mongodb-data');
            if (mongodbData) {
                databaseData.mongodb = JSON.parse(mongodbData);
            }
        }

        // ============================================
        // 页面加载完成
        // ============================================
        document.addEventListener('DOMContentLoaded', init);
        
        // 点击overlay关闭OAuth对话框
        document.getElementById('overlay').addEventListener('click', hideOAuthDialog);
    </script>
</body>
</html>